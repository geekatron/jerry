# Jerry Framework CI Pipeline
# ADR: projects/PROJ-001-plugin-cleanup/decisions/ADR-CI-001-cicd-pipeline.md
#
# Triggers: All pushes + PRs to main/master/claude/* branches
# Jobs: lint, type-check, security, test (matrix), coverage-report

name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main, master, "claude/**"]

permissions:
  contents: read
  pull-requests: write

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Lint & Format Check
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install ruff
        run: pip install "ruff==0.14.11"

      - name: Check linting
        run: ruff check . --config=pyproject.toml

      - name: Check formatting
        run: ruff format --check . --config=pyproject.toml

  # ===========================================================================
  # Type Checking
  # ===========================================================================
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyright
          pip install -e ".[dev]" || pip install -e .

      - name: Run pyright
        run: pyright src/

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Install and audit dependencies
        run: |
          # Install dev dependencies directly (not the jerry package itself)
          # This allows auditing only real PyPI dependencies
          pip install filelock mypy ruff
          pip-audit --strict

  # ===========================================================================
  # Plugin Validation (EN-005)
  # ===========================================================================
  # Validates plugin manifests and hook scripts
  # Ensures session_start_hook.py runs standalone without pip install
  plugin-validation:
    name: Plugin Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Validate plugin manifests
        run: uv run python scripts/validate_plugin_manifests.py

      - name: Validate hook wrappers syntax
        run: |
          # EN-007: Hook wrappers are thin scripts that delegate to jerry CLI.
          # Validate they parse without errors (they will fail at runtime without
          # uv/jerry installed, but syntax must be valid).
          python3 -m py_compile hooks/session-start.py
          python3 -m py_compile hooks/pre-compact.py
          python3 -m py_compile hooks/pre-tool-use.py
          python3 -m py_compile hooks/user-prompt-submit.py

      - name: Validate hook scripts syntax
        run: |
          echo "Checking hook scripts for syntax errors..."
          for script in hooks/*.py scripts/*.py; do
            if [ -f "$script" ]; then
              echo "  Checking: $script"
              uv run python -m py_compile "$script"
            fi
          done
          echo "All hook scripts passed syntax check!"

  # ===========================================================================
  # Template Format Validation (EN-818)
  # ===========================================================================
  template-validation:
    name: Template Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync

      - name: Validate adversarial strategy templates
        run: uv run python scripts/validate_templates.py --verbose

  # ===========================================================================
  # License Header Check (EN-935, FEAT-015)
  # ===========================================================================
  # Validates SPDX Apache-2.0 license headers on all Python files
  license-headers:
    name: License Header Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync

      - name: Validate SPDX license headers
        run: uv run python scripts/check_spdx_headers.py

  # ===========================================================================
  # CLI Integration Tests (EN-006)
  # ===========================================================================
  # Validates CLI commands via subprocess (plugin mode)
  # Ensures `jerry` command works without pip install -e .
  cli-integration:
    name: CLI Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --extra dev --extra test

      - name: Run CLI subprocess tests
        run: |
          # Run only subprocess-marked tests
          # These validate plugin mode (CLI via uv run)
          PYTHONPATH="." uv run pytest \
            tests/integration/cli/test_jerry_cli_subprocess.py \
            -v \
            --tb=short

      - name: Run MkDocs e2e validation tests
        run: |
          # Validate MkDocs build output: icon rendering, link quality, anchor integrity
          # Requires mkdocs-material (available via --extra dev)
          PYTHONPATH="." uv run pytest \
            tests/e2e/test_mkdocs_research_validation.py \
            -v \
            --tb=short

      - name: Verify jerry --help works
        run: PYTHONPATH="." uv run jerry --help

      - name: Verify jerry --version works
        run: PYTHONPATH="." uv run jerry --version

  # ===========================================================================
  # Test Suite - pip (Python Matrix)
  # ===========================================================================
  # Uses standard pip/venv for maximum portability
  # See: docs/INSTALLATION.md for pip installation instructions
  test-pip:
    name: Test pip (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      PYTHONUTF8: "1"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12", "3.13", "3.14"]
        exclude:
          - os: windows-latest
            python-version: "3.11"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.11"
          - os: macos-latest
            python-version: "3.12"

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt
          pip install -e .

      - name: Run tests with coverage
        shell: bash
        run: |
          # Exclude subprocess tests (require uv) - they run in cli-integration job
          # Exclude llm tests - they are slow, expensive, and run on-demand
          pytest \
            -m "not subprocess and not llm" \
            --cov=src \
            --cov-branch \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --junitxml=junit-pip-${{ matrix.python-version }}.xml \
            -v
        # Skip coverage check for refactoring PRs
        if: ${{ !contains(github.event.head_commit.message, '[skip-coverage]') }}
        continue-on-error: ${{ contains(github.event.head_commit.message, '[skip-coverage]') }}

      - name: Run tests without coverage threshold (skip-coverage)
        if: ${{ contains(github.event.head_commit.message, '[skip-coverage]') }}
        shell: bash
        run: |
          # Exclude subprocess tests (require uv) - they run in cli-integration job
          # Exclude llm tests - they are slow, expensive, and run on-demand
          pytest \
            -m "not subprocess and not llm" \
            --cov=src \
            --cov-branch \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-pip-${{ matrix.python-version }}.xml \
            -v

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.14' && matrix.os == 'ubuntu-latest'
        with:
          name: coverage-report-pip
          path: |
            coverage.xml
            htmlcov/
            junit-pip-${{ matrix.python-version }}.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.14' && matrix.os == 'ubuntu-latest'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          flags: pip
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-pip-${{ matrix.os }}-${{ matrix.python-version }}
          path: junit-pip-${{ matrix.python-version }}.xml

  # ===========================================================================
  # Test Suite - uv (Python Matrix)
  # ===========================================================================
  # Uses uv for fast dependency resolution (10-100x faster than pip)
  # See: https://docs.astral.sh/uv/guides/integration/github/
  test-uv:
    name: Test uv (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      PYTHONUTF8: "1"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12", "3.13", "3.14"]
        exclude:
          - os: windows-latest
            python-version: "3.11"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.11"
          - os: macos-latest
            python-version: "3.12"

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies (uv)
        run: uv sync --extra test

      - name: Run tests with coverage
        shell: bash
        run: |
          # Skip HTML report generation - uv's coverage install may have incomplete htmlfiles
          # HTML report is generated by pip test jobs instead
          # Exclude llm tests (slow, expensive, on-demand) and subprocess tests
          # (require mkdocs-material from dev group, not available in --extra test)
          uv run pytest \
            -m "not llm and not subprocess" \
            --cov=src \
            --cov-branch \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --junitxml=junit-uv-${{ matrix.python-version }}.xml \
            -v
        # Skip coverage check for refactoring PRs
        if: ${{ !contains(github.event.head_commit.message, '[skip-coverage]') }}
        continue-on-error: ${{ contains(github.event.head_commit.message, '[skip-coverage]') }}

      - name: Run tests without coverage threshold (skip-coverage)
        if: ${{ contains(github.event.head_commit.message, '[skip-coverage]') }}
        shell: bash
        run: |
          # Skip HTML report generation - uv's coverage install may have incomplete htmlfiles
          # Exclude llm tests (slow, expensive, on-demand) and subprocess tests
          # (require mkdocs-material from dev group, not available in --extra test)
          uv run pytest \
            -m "not llm and not subprocess" \
            --cov=src \
            --cov-branch \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=junit-uv-${{ matrix.python-version }}.xml \
            -v

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.14' && matrix.os == 'ubuntu-latest'
        with:
          name: coverage-report-uv
          path: |
            coverage.xml
            junit-uv-${{ matrix.python-version }}.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.14' && matrix.os == 'ubuntu-latest'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          flags: uv
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-uv-${{ matrix.os }}-${{ matrix.python-version }}
          path: junit-uv-${{ matrix.python-version }}.xml

  # ===========================================================================
  # Coverage Report on PR
  # ===========================================================================
  # Uses uv coverage report (primary) for PR comments
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-pip, test-uv]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5

      - name: Download uv coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-uv

      - name: Add coverage comment to PR
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: coverage.xml
          junitxml-path: junit-uv-3.14.xml
          title: "Coverage Report (uv)"
          badge-title: "Coverage"
          hide-badge: false
          hide-report: false
          create-new-comment: false
          hide-comment: false

  # ===========================================================================
  # Version Sync Validation (EN-108)
  # ===========================================================================
  version-sync:
    name: Version Sync Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync

      - name: Validate version consistency
        run: uv run python scripts/sync_versions.py --check

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  # Both pip and uv test jobs must pass for CI to succeed
  # This ensures compatibility with both installation methods
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, type-check, security, plugin-validation, template-validation, license-headers, cli-integration, test-pip, test-uv, version-sync]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.plugin-validation.result }}" != "success" ]] || \
             [[ "${{ needs.template-validation.result }}" != "success" ]] || \
             [[ "${{ needs.license-headers.result }}" != "success" ]] || \
             [[ "${{ needs.cli-integration.result }}" != "success" ]] || \
             [[ "${{ needs.test-pip.result }}" != "success" ]] || \
             [[ "${{ needs.test-uv.result }}" != "success" ]] || \
             [[ "${{ needs.version-sync.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            echo "  lint: ${{ needs.lint.result }}"
            echo "  type-check: ${{ needs.type-check.result }}"
            echo "  security: ${{ needs.security.result }}"
            echo "  plugin-validation: ${{ needs.plugin-validation.result }}"
            echo "  template-validation: ${{ needs.template-validation.result }}"
            echo "  license-headers: ${{ needs.license-headers.result }}"
            echo "  cli-integration: ${{ needs.cli-integration.result }}"
            echo "  test-pip: ${{ needs.test-pip.result }}"
            echo "  test-uv: ${{ needs.test-uv.result }}"
            echo "  version-sync: ${{ needs.version-sync.result }}"
            exit 1
          fi
          echo "All CI checks passed!"
          echo "  - Linting: OK"
          echo "  - Type checking: OK"
          echo "  - Security scan: OK"
          echo "  - Plugin validation: OK"
          echo "  - Template validation: OK"
          echo "  - License headers: OK"
          echo "  - CLI integration: OK"
          echo "  - Tests (pip): OK"
          echo "  - Tests (uv): OK"
          echo "  - Version sync: OK"
