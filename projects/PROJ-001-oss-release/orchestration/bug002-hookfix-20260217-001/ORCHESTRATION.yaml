# ORCHESTRATION.yaml
# Machine-readable orchestration state for BUG-002 Hook Schema Validation Fixes
# Document ID: PROJ-001-ORCH-STATE-002
# Version: 2.0
# Last Updated: 2026-02-17
# Schema Evolution: See docs/schemas/SCHEMA_VERSIONING.md

# Schema version for evolution support (semver format)
# Increment MAJOR for breaking changes, MINOR for additions, PATCH for fixes
schema_version: "2.0.0"

# =============================================================================
# WORKFLOW METADATA
# =============================================================================
workflow:
  id: "bug002-hookfix-20260217-001"
  name: "BUG-002 Hook Schema Validation Fixes"
  project_id: "PROJ-001-oss-release"
  version: "2.0"
  created_at: "2026-02-17"
  updated_at: "2026-02-17T22:30:00Z"
  status: "ACTIVE"  # ACTIVE | PAUSED | COMPLETE | FAILED | CANCELLED

  # Workflow ID configuration (WI-SAO-021)
  id_source: "auto"
  id_format: "semantic-date-seq"
  # Format: {purpose}-{YYYYMMDD}-{NNN}
  # Result: bug002-hookfix-20260217-001

  # Orchestration pattern classification
  patterns:
    - SEQUENTIAL       # Phases execute in order
    - FAN_OUT          # Phase 2: parallel hook fix streams
    - BARRIER_SYNC     # 3 barriers gate phase transitions
    - C4_TOURNAMENT    # Phase 4: all 10 adversarial strategies

  # Constraints from Jerry Constitution
  constraints:
    max_agent_nesting: 1          # P-003: Single nesting
    file_persistence: true        # P-002: All state to filesystem
    no_deception: true            # P-022: Transparent reasoning
    user_authority: true          # P-020: User approves gates
    uv_only: true                 # H-05/H-06: All Python via uv run
    max_concurrent_agents: 3      # Phase 2 fan-out: 3 parallel fix streams
    max_barrier_retries: 2        # Circuit breaker
    max_tournament_iterations: 3  # H-14 minimum, circuit breaker after 3
    checkpoint_frequency: "PHASE" # AGENT | PHASE | BARRIER

# =============================================================================
# PATH CONFIGURATION (WI-SAO-021)
# =============================================================================
paths:
  # Base path for all orchestration artifacts
  base: "orchestration/bug002-hookfix-20260217-001/"

  # Pipeline artifact path pattern (AC-012-004: Agent-level isolation)
  pipeline: "{base}{pipeline_alias}/{phase_id}/{agent_id}/"

  # Barrier artifact path pattern
  barrier: "{base}barriers/{barrier_id}/"

  # Resolved paths:
  # - Pipeline: orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/fix-researcher-task006/
  # - Barrier:  orchestration/bug002-hookfix-20260217-001/barriers/barrier-1/

# =============================================================================
# PIPELINE DEFINITIONS
# =============================================================================
pipelines:
  fix:
    id: "fix"
    name: "BUG-002 Fix Pipeline"
    description: "Sequential pipeline with fan-out for parallel hook fixes and C4 tournament review"

    # Short alias for path construction (WI-SAO-021)
    short_alias: "fix"
    skill_source: "problem-solving"

    status: "PHASE_4_PENDING"
    current_phase: 4
    total_phases: 5
    progress_percent: 70

    phases:
      # -----------------------------------------------------------------------
      # PHASE 1: Schema Foundation (TASK-006) -- Sequential
      # -----------------------------------------------------------------------
      - id: 1
        name: "Schema Foundation"
        path_id: "phase-1-schema-foundation"
        status: "COMPLETE"   # PENDING | IN_PROGRESS | COMPLETE | BLOCKED
        execution_mode: "SEQUENTIAL"
        tasks: ["TASK-006"]
        started_at: "2026-02-17"
        completed_at: "2026-02-17"
        agents:
          - id: "fix-researcher-task006"
            name: "Research Claude Code for existing hook output JSON Schemas"
            role: "researcher"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/fix-researcher-task006/fix-researcher-task006-research.md"
            inputs:
              - "Context7 Claude Code docs"
              - "WebSearch Claude Code hook schema"
              - "src/hooks/ source code"

          - id: "fix-creator-task006"
            name: "Create JSON Schema files for all hook event types"
            role: "creator"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/fix-creator-task006/fix-creator-task006-implementation.md"
            output_files:
              - "schemas/hooks/*.schema.json"
            inputs:
              - "fix-researcher-task006-research.md"
              - "Claude Code official docs"
            depends_on: ["fix-researcher-task006"]

          - id: "fix-validator-task006"
            name: "Validate schemas against known-good and known-bad outputs"
            role: "validator"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/fix-validator-task006/fix-validator-task006-validation.md"
            inputs:
              - "schemas/hooks/*.schema.json"
              - "session_start_hook.py output (known-good)"
              - "user-prompt-submit.py output (known-bad)"
            depends_on: ["fix-creator-task006"]

          - id: "adv-executor-p1"
            name: "C3 adversarial review of schema deliverable"
            role: "executor"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/adv-executor-p1/adv-executor-p1-adversarial-review.md"
            inputs:
              - "fix-creator-task006-implementation.md"
              - "fix-validator-task006-validation.md"
              - "schemas/hooks/*.schema.json"
              - "Strategy templates from .context/templates/adversarial/"
            depends_on: ["fix-validator-task006"]

          - id: "adv-scorer-p1"
            name: "S-014 quality scoring of schema deliverable"
            role: "scorer"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/adv-scorer-p1/adv-scorer-p1-quality-score.md"
            inputs:
              - "adv-executor-p1-adversarial-review.md"
              - "quality-enforcement.md"
            depends_on: ["adv-executor-p1"]

          - id: "fix-reviser-p1"
            name: "Conditional revision based on adversarial feedback (score < 0.92)"
            role: "reviser"
            status: "COMPLETE"
            conditional: true
            condition: "adv-scorer-p1 quality score < 0.92"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-1-schema-foundation/fix-reviser-p1/fix-reviser-p1-revision.md"
            inputs:
              - "adv-executor-p1-adversarial-review.md"
              - "adv-scorer-p1-quality-score.md"
              - "schemas/hooks/*.schema.json"
            depends_on: ["adv-scorer-p1"]
        artifacts: []
        exit_criteria:
          - "JSON Schema files exist for all hook event types"
          - "Schemas use JSON Schema draft 2020-12"
          - "Schemas validate session_start_hook.py output (known-good)"
          - "Schemas reject current user-prompt-submit.py output (known-bad)"

      # -----------------------------------------------------------------------
      # PHASE 2: Parallel Hook Fixes (TASK-001, TASK-002, TASK-003/004) -- Fan-Out
      # -----------------------------------------------------------------------
      - id: 2
        name: "Parallel Hook Fixes"
        path_id: "phase-2-parallel-fixes"
        status: "COMPLETE"
        blocked_by: null  # barrier-1 COMPLETE
        execution_mode: "FAN_OUT"
        tasks: ["TASK-001", "TASK-002", "TASK-003", "TASK-004"]
        started_at: "2026-02-17"
        completed_at: "2026-02-17"
        agents:
          # Stream 1: TASK-001 UserPromptSubmit (CRITICAL priority)
          - id: "fix-creator-task001"
            name: "Fix UserPromptSubmit hook - add hookEventName to hookSpecificOutput"
            role: "creator"
            stream: "task-001-userpromptsubmit"
            priority: "CRITICAL"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-2-parallel-fixes/fix-creator-task001/fix-creator-task001-report.md"
            inputs:
              - "TASK-001.md"
              - "hooks/user-prompt-submit.py"
              - "schemas/hooks/*.schema.json"
            changes:
              - "hooks/user-prompt-submit.py: Added hookEventName: UserPromptSubmit to hookSpecificOutput"

          - id: "fix-validator-task001"
            name: "Validate UserPromptSubmit fix against schema"
            role: "validator"
            stream: "task-001-userpromptsubmit"
            status: "COMPLETE"
            note: "Validation performed inline — schema validation 8/8 PASS, 3128/3128 tests PASS"
            depends_on: ["fix-creator-task001"]

          # Stream 2: TASK-002 PreToolUse (HIGH priority)
          - id: "fix-creator-task002"
            name: "Fix PreToolUse hook - migrate to hookSpecificOutput API"
            role: "creator"
            stream: "task-002-pretooluse"
            priority: "HIGH"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-2-parallel-fixes/fix-creator-task002/fix-creator-task002-report.md"
            inputs:
              - "TASK-002.md"
              - "scripts/pre_tool_use.py"
              - "schemas/hooks/*.schema.json"
            changes:
              - "scripts/pre_tool_use.py: Added make_decision() helper, migrated all 7 output points to hookSpecificOutput.permissionDecision"
              - "tests/hooks/test_pre_tool_use.py: Updated all assertions to new format"
              - "tests/integration/test_pretool_hook_integration.py: Updated all assertions to new format"
              - "tests/e2e/test_quality_framework_e2e.py: Updated PreToolUse assertions"

          - id: "fix-validator-task002"
            name: "Validate PreToolUse fix against schema"
            role: "validator"
            stream: "task-002-pretooluse"
            status: "COMPLETE"
            note: "Validation performed inline — schema validation 8/8 PASS, 3128/3128 tests PASS"
            depends_on: ["fix-creator-task002"]

          # Stream 3: TASK-003 + TASK-004 SubagentStop + hooks.json (HIGH priority)
          - id: "fix-creator-task003"
            name: "Fix SubagentStop hook + hooks.json config"
            role: "creator"
            stream: "task-003-004-subagentstop"
            priority: "HIGH"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-2-parallel-fixes/fix-creator-task003/fix-creator-task003-report.md"
            inputs:
              - "TASK-003.md"
              - "TASK-004.md"
              - "scripts/subagent_stop.py"
              - "hooks/hooks.json"
              - "schemas/hooks/*.schema.json"
            changes:
              - "scripts/subagent_stop.py: Changed output to {decision: block, reason: ...}, fixed exit codes"
              - "hooks/hooks.json: Added SubagentStop event, removed invalid matcher from UserPromptSubmit"
              - "schemas/hooks.schema.json: Added SubagentStop property, made matcher optional"

          - id: "fix-validator-task003"
            name: "Validate SubagentStop + hooks.json fix against schema"
            role: "validator"
            stream: "task-003-004-subagentstop"
            status: "COMPLETE"
            note: "Validation performed inline — schema validation 8/8 PASS, 3128/3128 tests PASS"
            depends_on: ["fix-creator-task003"]
        artifacts: []
        exit_criteria:
          - "user-prompt-submit.py includes hookEventName: UserPromptSubmit"
          - "pre_tool_use.py uses hookSpecificOutput.permissionDecision"
          - "pre_tool_use.py uses allow/deny (not approve/block)"
          - "pre_tool_use.py exits 0 on errors (fail-open)"
          - "subagent_stop.py registered under SubagentStop in hooks.json"
          - "subagent_stop.py outputs schema-compliant JSON"
          - "hooks.json has no matchers on events that don't support them"
          - "All hooks pass schema validation against Phase 1 schemas"

      # -----------------------------------------------------------------------
      # PHASE 3: Schema Validation Tests (TASK-005) -- Sequential
      # -----------------------------------------------------------------------
      - id: 3
        name: "Schema Tests"
        path_id: "phase-3-schema-tests"
        status: "COMPLETE"
        blocked_by: null  # barrier-2 COMPLETE
        execution_mode: "SEQUENTIAL"
        tasks: ["TASK-005"]
        started_at: "2026-02-17"
        completed_at: "2026-02-17"
        agents:
          - id: "fix-creator-task005"
            name: "Create schema validation test file"
            role: "creator"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-3-schema-tests/fix-creator-task005/fix-creator-task005-implementation.md"
            output_files:
              - "tests/test_hook_schema_compliance.py"
            inputs:
              - "TASK-005.md"
              - "schemas/hooks/*.schema.json"
              - "All fixed hook scripts"

          - id: "fix-validator-task005"
            name: "Validate all tests pass with no regressions"
            role: "validator"
            status: "COMPLETE"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-3-schema-tests/fix-validator-task005/fix-validator-task005-validation.md"
            inputs:
              - "tests/test_hook_schema_compliance.py"
              - "uv run pytest output"
            depends_on: ["fix-creator-task005"]
        artifacts: []
        exit_criteria:
          - "tests/test_hook_schema_compliance.py exists"
          - "All 4 hook scripts have schema validation tests"
          - "uv run pytest tests/test_hook_schema_compliance.py passes"
          - "Full suite uv run pytest passes with 0 failures"

      # -----------------------------------------------------------------------
      # PHASE 4: C4 Tournament Review -- All 10 Strategies
      # -----------------------------------------------------------------------
      - id: 4
        name: "C4 Tournament"
        path_id: "phase-4-c4-tournament"
        status: "BLOCKED"
        blocked_by: "barrier-3"
        execution_mode: "SEQUENTIAL"
        tasks: []
        started_at: null
        completed_at: null
        agents:
          - id: "adv-selector"
            name: "Select C4 strategy set (all 10 strategies mandatory)"
            role: "selector"
            status: "BLOCKED"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-4-c4-tournament/adv-selector/adv-selector-strategy-selection.md"
            inputs:
              - "quality-enforcement.md"
              - "BUG-002.md"

          - id: "adv-executor"
            name: "Execute tournament with all 10 adversarial strategies"
            role: "executor"
            status: "BLOCKED"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-4-c4-tournament/adv-executor/adv-executor-tournament-results.md"
            inputs:
              - "All fix artifacts from Phase 1-3"
              - "Strategy templates from .context/templates/adversarial/"
            depends_on: ["adv-selector"]

          - id: "adv-scorer"
            name: "Score deliverable with S-014 LLM-as-Judge 6-dimension rubric"
            role: "scorer"
            status: "BLOCKED"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-4-c4-tournament/adv-scorer/adv-scorer-quality-score.md"
            inputs:
              - "adv-executor-tournament-results.md"
              - "quality-enforcement.md"
            depends_on: ["adv-executor"]
        artifacts: []
        exit_criteria:
          - "All 10 strategies executed"
          - "Quality score >= 0.92 weighted composite"
          - "No critical findings unaddressed"

      # -----------------------------------------------------------------------
      # PHASE 5: Revision & Closure -- Conditional
      # -----------------------------------------------------------------------
      - id: 5
        name: "Revision & Closure"
        path_id: "phase-5-revision-closure"
        status: "BLOCKED"
        blocked_by: "phase-4"
        execution_mode: "CONDITIONAL"
        tasks: []
        started_at: null
        completed_at: null
        agents:
          - id: "fix-reviser"
            name: "Revise based on tournament feedback (conditional: score < 0.92)"
            role: "reviser"
            status: "BLOCKED"
            conditional: true
            condition: "adv-scorer quality score < 0.92"
            artifact: "orchestration/bug002-hookfix-20260217-001/fix/phase-5-revision-closure/fix-reviser/fix-reviser-revision.md"
            inputs:
              - "adv-executor-tournament-results.md"
              - "adv-scorer-quality-score.md"
        artifacts: []
        exit_criteria:
          - "Tournament score >= 0.92 (pass) OR revisions applied and re-scored"
          - "BUG-002 marked complete in WORKTRACKER.md"
          - "L2 reinforcement confirmed working"

# =============================================================================
# SYNC BARRIERS
# =============================================================================
barriers:
  - id: "barrier-1"
    name: "Schema Foundation Gate"
    status: "COMPLETE"  # PENDING | IN_PROGRESS | COMPLETE
    completed_at: "2026-02-17"
    after_phase: 1
    before_phase: 2
    depends_on:
      - "fix.phase.1"
    conditions:
      - "fix-validator-task006 reports VALIDATED"
      - "schemas/hooks/*.schema.json files exist"
      - "Schemas validated against session_start_hook.py known-good output"
      - "Schemas reject known-bad user-prompt-submit.py output"
      - "adv-scorer-p1 reports quality score >= 0.92"
    post_barrier_actions:
      - "Phase 2 agents unblocked"
      - "Hook fix agents can reference schemas for validation"
    artifact:
      path: "orchestration/bug002-hookfix-20260217-001/barriers/barrier-1/barrier-1-gate-check.md"
      status: "COMPLETE"
      key_content: "All 5 barrier conditions met. Phase 1 quality score 0.927 >= 0.92 threshold. Schemas validated."

  - id: "barrier-2"
    name: "Hook Fixes Validation Gate"
    status: "COMPLETE"
    completed_at: "2026-02-17"
    after_phase: 2
    before_phase: 3
    depends_on:
      - "fix.phase.2"
    conditions:
      - "fix-validator-task001 reports VALIDATED (UserPromptSubmit fixed)"
      - "fix-validator-task002 reports VALIDATED (PreToolUse fixed)"
      - "fix-validator-task003 reports VALIDATED (SubagentStop + hooks.json fixed)"
      - "All hook outputs pass schema validation against Phase 1 schemas"
    post_barrier_actions:
      - "Phase 3 agents unblocked"
      - "Test creation can begin with confidence all hooks are fixed"
    artifact:
      path: "orchestration/bug002-hookfix-20260217-001/barriers/barrier-2/barrier-2-gate-check.md"
      status: "COMPLETE"
      key_content: "All 4 conditions met. Schema validation 8/8 PASS. Full test suite 3128/3128 PASS. Commit a18d0a8 pushed."

  - id: "barrier-3"
    name: "Test Suite Gate"
    status: "COMPLETE"
    completed_at: "2026-02-17"
    after_phase: 3
    before_phase: 4
    depends_on:
      - "fix.phase.3"
    conditions:
      - "fix-validator-task005 reports VALIDATED"
      - "tests/hooks/test_hook_schema_compliance.py exists"
      - "uv run pytest tests/hooks/test_hook_schema_compliance.py passes (31/31)"
      - "Full test suite (uv run pytest) passes with 0 failures (3159/3159)"
    post_barrier_actions:
      - "Phase 4 (C4 Tournament) unblocked"
      - "Complete deliverable package ready for adversarial review"
    artifact:
      path: "orchestration/bug002-hookfix-20260217-001/barriers/barrier-3/barrier-3-gate-check.md"
      status: "COMPLETE"
      key_content: "All 4 conditions met. 31 new schema compliance tests pass. Full suite 3159/3159 PASS."

# =============================================================================
# EXECUTION QUEUE
# =============================================================================
execution_queue:
  current_group: 5
  groups:
    - id: 1
      name: "Phase 1: Schema Foundation (Sequential)"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"  # READY | IN_PROGRESS | COMPLETE | BLOCKED
      agents:
        - "fix-researcher-task006"
        - "fix-creator-task006"
        - "fix-validator-task006"
        - "adv-executor-p1"
        - "adv-scorer-p1"
        - "fix-reviser-p1"

    - id: 2
      name: "Barrier 1: Schema Foundation Gate"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      blocked_by: null  # group-1 COMPLETE
      tasks:
        - "validate-barrier-1-conditions"
        - "create-barrier-1-gate-check"

    - id: 3
      name: "Phase 2: Parallel Hook Fixes (Fan-Out, 3 streams)"
      execution_mode: "PARALLEL"
      status: "COMPLETE"
      blocked_by: null  # group-2 COMPLETE
      streams:
        - name: "Stream 1: TASK-001 UserPromptSubmit"
          agents: ["fix-creator-task001", "fix-validator-task001"]
          internal_mode: "SEQUENTIAL"
        - name: "Stream 2: TASK-002 PreToolUse"
          agents: ["fix-creator-task002", "fix-validator-task002"]
          internal_mode: "SEQUENTIAL"
        - name: "Stream 3: TASK-003/004 SubagentStop + hooks.json"
          agents: ["fix-creator-task003", "fix-validator-task003"]
          internal_mode: "SEQUENTIAL"

    - id: 4
      name: "Barrier 2: Hook Fixes Validation Gate"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      blocked_by: null  # group-3 COMPLETE
      tasks:
        - "validate-barrier-2-conditions"
        - "create-barrier-2-gate-check"

    - id: 5
      name: "Phase 3: Schema Tests (Sequential)"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      blocked_by: null  # group-4 COMPLETE
      agents:
        - "fix-creator-task005"
        - "fix-validator-task005"

    - id: 6
      name: "Barrier 3: Test Suite Gate"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      blocked_by: null  # group-5 COMPLETE
      tasks:
        - "validate-barrier-3-conditions"
        - "create-barrier-3-gate-check"

    - id: 7
      name: "Phase 4: C4 Tournament Review (Sequential)"
      execution_mode: "SEQUENTIAL"
      status: "READY"
      blocked_by: null  # group-6 COMPLETE
      agents:
        - "adv-selector"
        - "adv-executor"
        - "adv-scorer"

    - id: 8
      name: "Phase 5: Revision & Closure (Conditional)"
      execution_mode: "CONDITIONAL"
      status: "BLOCKED"
      blocked_by: "group-7"
      condition: "adv-scorer quality score < 0.92 triggers fix-reviser"
      agents:
        - "fix-reviser"

# =============================================================================
# QUALITY
# =============================================================================
quality:
  criticality: "C4"  # C1 | C2 | C3 | C4
  criticality_rationale:
    - "L2 enforcement layer completely disabled (quality framework integrity)"
    - "Security guardrails (PreToolUse) on deprecated API (AE-005 -> auto-C3+)"
    - "Affects hook infrastructure used by all Jerry sessions (high blast radius)"
    - "User explicitly requested C4 tournament review"

  threshold: 0.92  # H-13: >= 0.92 weighted composite for C2+
  max_iterations: 3  # H-14: minimum 3 creator-critic-revision
  escalation: "After 3 failed iterations, human escalation (AE-006)"

  score_bands:
    - band: "PASS"
      range: ">= 0.92"
      outcome: "Proceed to BUG-002 closure"
    - band: "REVISE"
      range: "0.85 - 0.91"
      outcome: "Targeted revision, re-run tournament"
    - band: "REJECTED"
      range: "< 0.85"
      outcome: "Significant rework, re-run from Phase 2"

  # Phase 1 C3 adversarial review (schema foundation quality gate)
  phase_1_review:
    criticality: "C3"
    criticality_rationale: "Schema foundation affects all downstream phases; >10 files impacted; API contract definitions"
    threshold: 0.92  # H-13: same threshold as C4 tournament
    strategies:
      required:
        - id: "S-010"
          name: "Self-Refine"
          family: "Iterative Self-Correction"
        - id: "S-003"
          name: "Steelman Technique"
          family: "Dialectical Synthesis"
        - id: "S-002"
          name: "Devil's Advocate"
          family: "Role-Based Adversarialism"
          constraint: "H-16: Must be applied AFTER S-003 Steelman"
        - id: "S-007"
          name: "Constitutional AI Critique"
          family: "Iterative Self-Correction"
        - id: "S-014"
          name: "LLM-as-Judge"
          family: "Iterative Self-Correction"
        - id: "S-013"
          name: "Inversion Technique"
          family: "Structured Decomposition"
        - id: "S-011"
          name: "Chain-of-Verification"
          family: "Structured Decomposition"
      optional: []  # C3 required set covers 7 strategies per criticality table
    score:
      composite: 0.927
      band: "PASS"
      iteration: 1
      scored_at: "2026-02-17"
      dimension_scores:
        completeness: 0.93
        internal_consistency: 0.94
        methodological_rigor: 0.92
        evidence_quality: 0.91
        actionability: 0.93
        traceability: 0.92

  # All 10 strategies required for C4 (no optional at C4)
  strategies:
    required:
      - id: "S-014"
        name: "LLM-as-Judge"
        family: "Iterative Self-Correction"
        composite_score: 4.40
        execution_order: 5
      - id: "S-003"
        name: "Steelman Technique"
        family: "Dialectical Synthesis"
        composite_score: 4.30
        execution_order: 2
      - id: "S-013"
        name: "Inversion Technique"
        family: "Structured Decomposition"
        composite_score: 4.25
        execution_order: 7
      - id: "S-007"
        name: "Constitutional AI Critique"
        family: "Iterative Self-Correction"
        composite_score: 4.15
        execution_order: 4
      - id: "S-002"
        name: "Devil's Advocate"
        family: "Role-Based Adversarialism"
        composite_score: 4.10
        execution_order: 3
        constraint: "H-16: Must be applied AFTER S-003 Steelman"
      - id: "S-004"
        name: "Pre-Mortem Analysis"
        family: "Role-Based Adversarialism"
        composite_score: 4.10
        execution_order: 6
      - id: "S-010"
        name: "Self-Refine"
        family: "Iterative Self-Correction"
        composite_score: 4.00
        execution_order: 1
      - id: "S-012"
        name: "FMEA"
        family: "Structured Decomposition"
        composite_score: 3.75
        execution_order: 8
      - id: "S-011"
        name: "Chain-of-Verification"
        family: "Structured Decomposition"
        composite_score: 3.75
        execution_order: 9
      - id: "S-001"
        name: "Red Team Analysis"
        family: "Role-Based Adversarialism"
        composite_score: 3.35
        execution_order: 10
    optional: []  # None -- all 10 strategies are required at C4

  # Strategy execution order (per H-16: Steelman before Devil's Advocate)
  execution_order:
    - order: 1
      strategy: "S-010"
      focus: "Self-review of complete fix set"
    - order: 2
      strategy: "S-003"
      focus: "Strengthen the fix approach before critique"
    - order: 3
      strategy: "S-002"
      focus: "Challenge assumptions about schema compliance"
    - order: 4
      strategy: "S-007"
      focus: "Verify fixes comply with Jerry Constitution"
    - order: 5
      strategy: "S-014"
      focus: "Score against 6-dimension rubric"
    - order: 6
      strategy: "S-004"
      focus: "Imagine these fixes failed -- why?"
    - order: 7
      strategy: "S-013"
      focus: "How could these fixes still break?"
    - order: 8
      strategy: "S-012"
      focus: "Systematic failure mode enumeration"
    - order: 9
      strategy: "S-011"
      focus: "Verify factual claims (schema fields, exit codes)"
    - order: 10
      strategy: "S-001"
      focus: "Adversary simulation: bypass hook guardrails"

  # S-014 LLM-as-Judge scoring dimensions
  scoring_dimensions:
    - dimension: "Completeness"
      weight: 0.20
      application: "All 7 root causes addressed across all 4 files"
    - dimension: "Internal Consistency"
      weight: 0.20
      application: "All hooks follow same pattern as session_start_hook.py reference"
    - dimension: "Methodological Rigor"
      weight: 0.20
      application: "Fixes derived from authoritative Claude Code docs, not guesswork"
    - dimension: "Evidence Quality"
      weight: 0.15
      application: "Schema validation tests prove compliance"
    - dimension: "Actionability"
      weight: 0.15
      application: "Fixes are directly applicable, no ambiguity"
    - dimension: "Traceability"
      weight: 0.10
      application: "Each fix traces to specific root cause (RC-1 through RC-7)"

  # Current scores (populated during Phase 4)
  current_score: null
  iteration: 0

# =============================================================================
# CHECKPOINTS
# =============================================================================
checkpoints:
  latest_id: "CP-002"
  entries:
    - id: "CP-001"
      trigger: "PHASE_COMPLETE"
      description: "Phase 1 complete - Schema Foundation rollback point"
      recovery_point: "barrier-1-start"
      created_at: "2026-02-17"
      state_snapshot:
        phase_1: "COMPLETE"
        barrier_1: "COMPLETE"
        phase_1_quality_score: 0.927
        agents_complete: 6
        artifacts: ["schemas/hooks/*.schema.json", "Phase 1 agent reports"]
    - id: "CP-002"
      trigger: "PHASE_COMPLETE"
      description: "Phase 2 complete - All hooks fixed, tests updated, pre-test state"
      recovery_point: "barrier-2-start"
      created_at: "2026-02-17"
      git_commit: "a18d0a8"
      state_snapshot:
        phase_1: "COMPLETE"
        phase_2: "COMPLETE"
        barrier_1: "COMPLETE"
        barrier_2: "COMPLETE"
        agents_complete: 12
        schema_validation: "8/8 PASS"
        test_suite: "3128/3128 PASS"
        files_changed:
          - "hooks/user-prompt-submit.py"
          - "scripts/pre_tool_use.py"
          - "scripts/subagent_stop.py"
          - "hooks/hooks.json"
          - "schemas/hooks.schema.json"
          - "tests/hooks/test_pre_tool_use.py"
          - "tests/integration/test_pretool_hook_integration.py"
          - "tests/e2e/test_quality_framework_e2e.py"
  # Planned checkpoints:
  # - id: "CP-001"
  #   trigger: "PHASE_COMPLETE"
  #   description: "Phase 1 complete - Schema rollback point"
  #   recovery_point: "barrier-1-start"
  # - id: "CP-002"
  #   trigger: "PHASE_COMPLETE"
  #   description: "Phase 2 complete - Pre-test state"
  #   recovery_point: "barrier-2-start"
  # - id: "CP-003"
  #   trigger: "PHASE_COMPLETE"
  #   description: "Phase 3 complete - Pre-tournament state"
  #   recovery_point: "barrier-3-start"
  # - id: "CP-004"
  #   trigger: "PHASE_COMPLETE"
  #   description: "Phase 4 complete - Quality gate decision point"
  #   recovery_point: "phase-5-start"
  # - id: "CP-005"
  #   trigger: "WORKFLOW_COMPLETE"
  #   description: "Phase 5 complete - Final state snapshot"
  #   recovery_point: null

# =============================================================================
# METRICS
# =============================================================================
metrics:
  execution:
    phases_complete: 3
    phases_total: 5
    phases_percent: 70
    barriers_complete: 3
    barriers_total: 3
    barriers_percent: 100
    agents_executed: 14  # 6 (P1) + 6 (P2) + 2 (P3)
    agents_total: 19
    agents_percent: 74
    artifacts_created: 14
    artifacts_total: 22
    artifacts_percent: 64

  quality:
    agent_success_rate: 100  # 14/14 agents succeeded
    barrier_validation_pass_rate: 100  # 3/3 barriers passed
    checkpoint_recovery_tested: false
    phase_1_score: 0.927
    tournament_score: null
    tournament_iteration: 0

  timing:
    workflow_started: "2026-02-17"
    last_activity: "2026-02-17"
    estimated_completion: null

# =============================================================================
# RECOVERY STRATEGIES
# =============================================================================
recovery:
  strategies:
    - failure_mode: "Schema generation fails"
      detection: "fix-validator-task006 FAILED"
      recovery: "Re-run research with alternative sources"
    - failure_mode: "Hook fix introduces new bug"
      detection: "fix-validator-task00N FAILED"
      recovery: "Roll back specific hook, fix, re-validate"
    - failure_mode: "Tests fail on fixed hooks"
      detection: "fix-validator-task005 FAILED"
      recovery: "Debug test vs implementation mismatch"
    - failure_mode: "Tournament score < 0.92"
      detection: "adv-scorer output"
      recovery: "Revise based on feedback, re-run tournament"
    - failure_mode: "Full test suite regression"
      detection: "pytest non-zero exit"
      recovery: "Investigate regression, fix without changing hook behavior"

# =============================================================================
# BLOCKERS AND ISSUES
# =============================================================================
blockers:
  active: []

issues:
  resolved: []

# =============================================================================
# NEXT ACTIONS
# =============================================================================
next_actions:
  immediate:
    - action: "Complete Phase 3: fix-creator-task005 creating tests/hooks/test_hook_schema_compliance.py"
      agents: ["fix-creator-task005"]
      execution_mode: "SEQUENTIAL"
    - action: "Validate Phase 3: Run full test suite including new schema compliance tests"
      agents: ["fix-validator-task005"]
      depends_on: "fix-creator-task005 complete"

  subsequent:
    - action: "Check barrier-3 gate: All tests pass, full suite green"
      depends_on: "Phase 3 complete"
    - action: "Execute Phase 4: C4 tournament review (all 10 strategies via /adversary skill)"
      depends_on: "Barrier 3 complete"
    - action: "Phase 5: Revision if needed, then BUG-002 closure"
      depends_on: "Phase 4 complete"

# =============================================================================
# RESUMPTION CONTEXT
# =============================================================================
resumption:
  last_checkpoint: "CP-003"
  current_state: "Phases 1-3 COMPLETE. All 3 barriers PASSED. 3159 tests pass. Phase 4 (C4 Tournament) READY."
  next_step: "Execute Phase 4: C4 tournament review with all 10 adversarial strategies via /adversary skill"
  overall_progress: "70%"

  files_to_read:
    - "ORCHESTRATION_PLAN.md"           # Strategic context
    - "ORCHESTRATION_WORKTRACKER.md"    # Tactical documentation
    - "ORCHESTRATION.yaml"              # This file - machine-readable state

  cross_session_portable: true
  ephemeral_references: false
