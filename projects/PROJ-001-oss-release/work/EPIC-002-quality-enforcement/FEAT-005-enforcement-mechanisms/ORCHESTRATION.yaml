# ORCHESTRATION.yaml
# Machine-readable orchestration state for FEAT-005 enforcement mechanisms workflow
# Document ID: PROJ-001-ORCH-STATE-FEAT005
# Version: 2.0
# Last Updated: 2026-02-12T00:00:00Z
# Generated by: orch-planner agent v2.1.0
#
# DISCLAIMER: This file was generated by the orch-planner agent (v2.1.0).
# All state transitions must be validated before execution.
# This is the Single Source of Truth (SSOT) for workflow state.

# Schema version for evolution support (semver format)
schema_version: "2.0.0"

# =============================================================================
# WORKFLOW METADATA
# =============================================================================
workflow:
  id: "enforcement-qual-20260212-001"
  name: "FEAT-005 Quality Framework Enforcement Mechanisms"
  project_id: "PROJ-001-oss-release"
  feature_id: "FEAT-005"
  epic_id: "EPIC-002"
  version: "2.0"
  created_at: "2026-02-12T00:00:00Z"
  updated_at: "2026-02-12T00:00:00Z"
  status: "ACTIVE"  # ACTIVE | PAUSED | COMPLETE | FAILED | CANCELLED

  # Workflow ID configuration
  id_source: "auto"
  id_format: "semantic-date-seq"
  # Format: {purpose}-{YYYYMMDD}-{NNN}

  # Orchestration pattern classification
  patterns:
    - SEQUENTIAL           # Phases 1->2 and Phase 3->4 execute in order
    - FAN_OUT              # Phase 3 fans out into 3 parallel enablers
    - FAN_IN               # Phase 4 waits for all Phase 3 enablers
    - ADVERSARIAL_REVIEW   # Creator->critic->revision loops per enabler
    - HIERARCHICAL         # Orchestrator delegates to agents

  # Quality framework
  quality:
    target_score: 0.92
    max_iterations: 3
    escalation_policy: "USER_DECISION"  # P-020: user authority
    scoring_scale: "0.0-1.0"

  # Constraints from Jerry Constitution
  constraints:
    max_agent_nesting: 1          # P-003: Single nesting
    file_persistence: true        # P-002: All state to filesystem
    user_authority: true          # P-020: User approves gates
    no_deception: true            # P-022: Transparent reasoning
    max_concurrent_agents: 3      # Soft constraint (Phase 3 fan-out)
    max_barrier_retries: 2        # Circuit breaker
    checkpoint_frequency: "PHASE" # AGENT | PHASE | BARRIER

# =============================================================================
# PATH CONFIGURATION
# =============================================================================
paths:
  # Base path for all orchestration artifacts (relative to feature directory)
  base: "orchestration/enforcement-qual-20260212-001/"

  # Pipeline artifact path pattern
  pipeline: "{base}{pipeline_alias}/{phase_id}/{agent_id}/"

  # Barrier artifact path pattern
  barrier: "{base}barriers/{barrier_id}/"

# =============================================================================
# PIPELINE DEFINITION
# =============================================================================
pipelines:
  enforcement:
    id: "pipeline-enforcement"
    name: "Enforcement Mechanisms Pipeline"
    description: "Sequential pipeline with fan-out/fan-in for FEAT-005 enforcement implementation"

    short_alias: "enforcement"
    skill_source: "problem-solving"

    status: "PHASE_1_PENDING"
    current_phase: 1
    total_phases: 6  # Phase 1, 2, 3a, 3b, 3c, 4
    progress_percent: 0

    phases:
      # -----------------------------------------------------------------------
      # PHASE 1: RESEARCH (EN-401)
      # -----------------------------------------------------------------------
      - id: 1
        name: "Research: Enforcement Vectors & Best Practices"
        path_id: "phase-1-research"
        enabler_id: "EN-401"
        status: "PENDING"       # PENDING | IN_PROGRESS | COMPLETE | BLOCKED | FAILED
        started_at: null
        completed_at: null
        dependencies: []

        adversarial_review:
          creator_agent: "ps-researcher"
          critic_agent: "ps-critic"
          patterns: ["devils_advocate", "red_team"]
          quality_target: 0.92
          max_iterations: 3
          current_iteration: 0
          iterations: []
          # iterations format when populated:
          # - iteration: 1
          #   score: 0.85
          #   critique_path: "enforcement/phase-1-research/ps-critic/critique-iter-1.md"
          #   revision_path: "enforcement/phase-1-research/ps-researcher/research-output-rev-1.md"
          #   status: "COMPLETE"

        agents:
          - id: "ps-researcher"
            name: "Problem-Solving Researcher"
            role: "creator"
            status: "PENDING"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-1-research/ps-researcher/research-output.md"
            inputs: []

          - id: "ps-critic-p1"
            name: "Problem-Solving Critic (Phase 1)"
            role: "adversarial_reviewer"
            status: "PENDING"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-1-research/ps-critic/critique-iter-{N}.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-1-research/ps-researcher/research-output.md"

        artifacts: []

      # -----------------------------------------------------------------------
      # PHASE 2: ANALYSIS & DECISION (EN-402)
      # -----------------------------------------------------------------------
      - id: 2
        name: "Enforcement Priority Analysis & Decision"
        path_id: "phase-2-analysis"
        enabler_id: "EN-402"
        status: "BLOCKED"
        blocked_by: "phase-1"
        started_at: null
        completed_at: null
        dependencies:
          - "phase-1"

        adversarial_review:
          creator_agent: "ps-analyst"
          critic_agent: "ps-critic"
          patterns: ["steelman", "devils_advocate"]
          quality_target: 0.92
          max_iterations: 3
          current_iteration: 0
          iterations: []

        agents:
          - id: "ps-analyst"
            name: "Problem-Solving Analyst"
            role: "creator"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-analyst/analysis-output.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-1-research/ps-researcher/research-output.md"

          - id: "ps-critic-p2"
            name: "Problem-Solving Critic (Phase 2)"
            role: "adversarial_reviewer"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-critic/critique-iter-{N}.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-analyst/analysis-output.md"

        artifacts: []

      # -----------------------------------------------------------------------
      # PHASE 3a: HOOK-BASED ENFORCEMENT (EN-403) [FAN-OUT]
      # -----------------------------------------------------------------------
      - id: "3a"
        name: "Hook-Based Enforcement Implementation"
        path_id: "phase-3-impl"
        enabler_id: "EN-403"
        status: "BLOCKED"
        blocked_by: "fan-out-barrier"
        started_at: null
        completed_at: null
        execution_mode: "PARALLEL"  # Part of fan-out group
        fan_out_group: "phase-3"
        dependencies:
          - "phase-2"

        adversarial_review:
          creator_agent: "ps-architect"
          critic_agent: "ps-critic"
          patterns: ["blue_team", "red_team"]
          quality_target: 0.92
          max_iterations: 3
          current_iteration: 0
          iterations: []

        agents:
          - id: "ps-architect-hooks"
            name: "Problem-Solving Architect (Hooks)"
            role: "creator"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-hooks/impl-output.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-analyst/analysis-output.md"

          - id: "ps-critic-p3a"
            name: "Problem-Solving Critic (Phase 3a)"
            role: "adversarial_reviewer"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-hooks/critique-iter-{N}.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-hooks/impl-output.md"

        artifacts: []

      # -----------------------------------------------------------------------
      # PHASE 3b: RULE-BASED ENFORCEMENT (EN-404) [FAN-OUT]
      # -----------------------------------------------------------------------
      - id: "3b"
        name: "Rule-Based Enforcement Enhancement"
        path_id: "phase-3-impl"
        enabler_id: "EN-404"
        status: "BLOCKED"
        blocked_by: "fan-out-barrier"
        started_at: null
        completed_at: null
        execution_mode: "PARALLEL"
        fan_out_group: "phase-3"
        dependencies:
          - "phase-2"

        adversarial_review:
          creator_agent: "ps-architect"
          critic_agent: "ps-critic"
          patterns: ["red_team", "strawman"]
          quality_target: 0.92
          max_iterations: 3
          current_iteration: 0
          iterations: []

        agents:
          - id: "ps-architect-rules"
            name: "Problem-Solving Architect (Rules)"
            role: "creator"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-rules/impl-output.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-analyst/analysis-output.md"

          - id: "ps-critic-p3b"
            name: "Problem-Solving Critic (Phase 3b)"
            role: "adversarial_reviewer"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-rules/critique-iter-{N}.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-rules/impl-output.md"

        artifacts: []

      # -----------------------------------------------------------------------
      # PHASE 3c: SESSION CONTEXT ENFORCEMENT (EN-405) [FAN-OUT]
      # -----------------------------------------------------------------------
      - id: "3c"
        name: "Session Context Enforcement Injection"
        path_id: "phase-3-impl"
        enabler_id: "EN-405"
        status: "BLOCKED"
        blocked_by: "fan-out-barrier"
        started_at: null
        completed_at: null
        execution_mode: "PARALLEL"
        fan_out_group: "phase-3"
        dependencies:
          - "phase-2"

        adversarial_review:
          creator_agent: "ps-architect"
          critic_agent: "ps-critic"
          patterns: ["steelman", "blue_team"]
          quality_target: 0.92
          max_iterations: 3
          current_iteration: 0
          iterations: []

        agents:
          - id: "ps-architect-session"
            name: "Problem-Solving Architect (Session)"
            role: "creator"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-session/impl-output.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-2-analysis/ps-analyst/analysis-output.md"

          - id: "ps-critic-p3c"
            name: "Problem-Solving Critic (Phase 3c)"
            role: "adversarial_reviewer"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-session/critique-iter-{N}.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-session/impl-output.md"

        artifacts: []

      # -----------------------------------------------------------------------
      # PHASE 4: VALIDATION (EN-406) [FAN-IN]
      # -----------------------------------------------------------------------
      - id: 4
        name: "Integration Testing & Cross-Platform Validation"
        path_id: "phase-4-validation"
        enabler_id: "EN-406"
        status: "BLOCKED"
        blocked_by: "fan-in-barrier"
        started_at: null
        completed_at: null
        dependencies:
          - "phase-3a"
          - "phase-3b"
          - "phase-3c"

        adversarial_review: null  # Validation phase uses executor + reviewer pattern

        agents:
          - id: "ps-validator"
            name: "Problem-Solving Validator"
            role: "executor"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-4-validation/ps-validator/validation-output.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-hooks/impl-output.md"
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-rules/impl-output.md"
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-3-impl/ps-architect-session/impl-output.md"

          - id: "nse-qa-auditor"
            name: "NSE QA Auditor"
            role: "reviewer"
            status: "BLOCKED"
            artifact: "orchestration/enforcement-qual-20260212-001/enforcement/phase-4-validation/nse-qa-auditor/audit-report.md"
            inputs:
              - "orchestration/enforcement-qual-20260212-001/enforcement/phase-4-validation/ps-validator/validation-output.md"

        artifacts: []

# =============================================================================
# BARRIERS
# =============================================================================
barriers:
  - id: "fan-out-barrier"
    name: "Fan-Out Barrier: Phase 2 -> Phase 3 (parallel)"
    type: "FAN_OUT"
    status: "PENDING"  # PENDING | IN_PROGRESS | COMPLETE
    completed_at: null
    depends_on:
      - "pipeline.enforcement.phase.2"
    unblocks:
      - "pipeline.enforcement.phase.3a"
      - "pipeline.enforcement.phase.3b"
      - "pipeline.enforcement.phase.3c"
    condition: "Phase 2 (EN-402) adversarial review passed with quality >= 0.92"

  - id: "fan-in-barrier"
    name: "Fan-In Barrier: Phase 3 (all) -> Phase 4"
    type: "FAN_IN"
    status: "PENDING"
    completed_at: null
    depends_on:
      - "pipeline.enforcement.phase.3a"
      - "pipeline.enforcement.phase.3b"
      - "pipeline.enforcement.phase.3c"
    unblocks:
      - "pipeline.enforcement.phase.4"
    condition: "All Phase 3 enablers (EN-403, EN-404, EN-405) adversarial reviews passed with quality >= 0.92"

# =============================================================================
# EXECUTION QUEUE
# =============================================================================
execution_queue:
  current_group: 1
  groups:
    - id: 1
      name: "Phase 1: Research (EN-401)"
      execution_mode: "SEQUENTIAL"
      status: "READY"
      agents:
        - "ps-researcher"
        - "ps-critic-p1"

    - id: 2
      name: "Phase 2: Analysis & Decision (EN-402)"
      execution_mode: "SEQUENTIAL"
      status: "BLOCKED"
      blocked_by: "group-1"
      agents:
        - "ps-analyst"
        - "ps-critic-p2"

    - id: 3
      name: "Fan-Out Barrier Check"
      execution_mode: "SEQUENTIAL"
      status: "BLOCKED"
      blocked_by: "group-2"
      tasks:
        - "verify-phase-2-quality-gate"
        - "unblock-phase-3-parallel"

    - id: 4
      name: "Phase 3: Implementation (EN-403, EN-404, EN-405 parallel)"
      execution_mode: "PARALLEL"
      status: "BLOCKED"
      blocked_by: "group-3"
      agents:
        - "ps-architect-hooks"
        - "ps-critic-p3a"
        - "ps-architect-rules"
        - "ps-critic-p3b"
        - "ps-architect-session"
        - "ps-critic-p3c"

    - id: 5
      name: "Fan-In Barrier Check"
      execution_mode: "SEQUENTIAL"
      status: "BLOCKED"
      blocked_by: "group-4"
      tasks:
        - "verify-phase-3a-quality-gate"
        - "verify-phase-3b-quality-gate"
        - "verify-phase-3c-quality-gate"
        - "unblock-phase-4"

    - id: 6
      name: "Phase 4: Validation (EN-406)"
      execution_mode: "SEQUENTIAL"
      status: "BLOCKED"
      blocked_by: "group-5"
      agents:
        - "ps-validator"
        - "nse-qa-auditor"

# =============================================================================
# ENABLER MAPPING
# =============================================================================
enabler_mapping:
  EN-401:
    phase: 1
    title: "Deep Research: Enforcement Vectors & Best Practices"
    priority: "critical"
    effort: 13
    status: "PENDING"
    dependencies: []
  EN-402:
    phase: 2
    title: "Enforcement Priority Analysis & Decision"
    priority: "critical"
    effort: 8
    status: "BLOCKED"
    dependencies: ["EN-401"]
  EN-403:
    phase: "3a"
    title: "Hook-Based Enforcement Implementation"
    priority: "high"
    effort: 10
    status: "BLOCKED"
    dependencies: ["EN-402"]
  EN-404:
    phase: "3b"
    title: "Rule-Based Enforcement Enhancement"
    priority: "high"
    effort: 5
    status: "BLOCKED"
    dependencies: ["EN-402"]
  EN-405:
    phase: "3c"
    title: "Session Context Enforcement Injection"
    priority: "high"
    effort: 5
    status: "BLOCKED"
    dependencies: ["EN-402"]
  EN-406:
    phase: 4
    title: "Integration Testing & Cross-Platform Validation"
    priority: "high"
    effort: 8
    status: "BLOCKED"
    dependencies: ["EN-403", "EN-404", "EN-405"]

# =============================================================================
# CHECKPOINTS
# =============================================================================
checkpoints:
  latest_id: null
  entries: []
  # Example entry:
  # - id: "CP-001"
  #   timestamp: "2026-02-12T10:00:00Z"
  #   trigger: "PHASE_COMPLETE"
  #   description: "Phase 1 research complete, quality 0.94"
  #   recovery_point: "phase-2-start"
  #   quality_score: 0.94

# =============================================================================
# METRICS
# =============================================================================
metrics:
  execution:
    phases_complete: 0
    phases_total: 6          # 1 + 1 + 3(fan-out) + 1
    phases_percent: 0
    barriers_complete: 0
    barriers_total: 2        # fan-out + fan-in
    barriers_percent: 0
    agents_executed: 0
    agents_total: 12         # 2+2+2+2+2+2 (creator+critic per enabler except Phase 4 executor+reviewer)
    agents_percent: 0
    artifacts_created: 0
    artifacts_total: 14      # 6 creator outputs + 6 critique outputs (assuming 1 iteration min) + validator + auditor
    artifacts_percent: 0
    enablers_complete: 0
    enablers_total: 6
    enablers_percent: 0
    total_effort_points: 49
    completed_effort_points: 0

  quality:
    adversarial_reviews_passed: 0
    adversarial_reviews_total: 5   # EN-401 through EN-405 each have adversarial review
    average_quality_score: 0.0
    quality_scores: {}
    # quality_scores format when populated:
    # EN-401: 0.94
    # EN-402: 0.93
    iterations_total: 0
    escalations: 0

  timing:
    workflow_started: null
    last_activity: null
    estimated_completion: null
    phase_durations: {}

# =============================================================================
# BLOCKERS AND ISSUES
# =============================================================================
blockers:
  active: []

issues:
  resolved: []

# =============================================================================
# NEXT ACTIONS
# =============================================================================
next_actions:
  immediate:
    - action: "Execute Phase 1: Invoke ps-researcher for EN-401 deep research"
      agents: ["ps-researcher"]
      execution_mode: "SEQUENTIAL"
      enabler: "EN-401"
      description: "Research ALL enforcement vectors: hooks, rules, prompts, session context, pre-commit. Include authoritative citations. Assess platform portability."

  subsequent:
    - action: "Adversarial review of Phase 1 output"
      agents: ["ps-critic-p1"]
      depends_on: "ps-researcher output complete"
      description: "Apply Devil's Advocate + Red Team patterns to research. Score quality."

    - action: "Execute Phase 2: Priority analysis and decision"
      agents: ["ps-analyst"]
      depends_on: "Phase 1 quality gate passed (>= 0.92)"
      enabler: "EN-402"

    - action: "Fan-out Phase 3: Parallel implementation"
      agents: ["ps-architect-hooks", "ps-architect-rules", "ps-architect-session"]
      depends_on: "Phase 2 quality gate passed (>= 0.92)"
      enablers: ["EN-403", "EN-404", "EN-405"]

    - action: "Fan-in Phase 4: Integration validation"
      agents: ["ps-validator", "nse-qa-auditor"]
      depends_on: "All Phase 3 quality gates passed (>= 0.92)"
      enabler: "EN-406"

# =============================================================================
# RESUMPTION CONTEXT
# =============================================================================
resumption:
  last_checkpoint: null
  current_state: "Workflow initialized. Phase 1 ready for execution."
  next_step: "Invoke ps-researcher for EN-401 deep research on enforcement vectors"

  files_to_read:
    - "ORCHESTRATION_PLAN.md"           # Strategic context
    - "ORCHESTRATION.yaml"              # This file - machine-readable state (SSOT)
    - "FEAT-005-enforcement-mechanisms.md"  # Feature definition with acceptance criteria

  cross_session_portable: true
  ephemeral_references: false
