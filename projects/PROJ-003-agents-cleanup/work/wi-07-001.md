# WI-07-001: Quick fix pytest pythonpath issue

> **Status:** IN_PROGRESS
> **Phase:** 7 - Python Environment Standardization
> **Created:** 2026-01-12
> **Assignee:** Claude
> **Related Bug:** BUG-001

---

## Objective

Fix the pytest configuration so tests can run locally and in CI without import errors.

---

## Problem Statement

Tests fail to collect with 52 `ModuleNotFoundError: No module named 'src'` errors.

### Root Cause Analysis

| Factor | Current | Expected |
|--------|---------|----------|
| `pytest.ini` pythonpath | `src` | `` (empty) or `.` |
| `--import-mode` | `importlib` | N/A |
| Package install | Editable (`pip install -e .`) | Same |
| Test imports | `from src.xxx` | Same |

The conflict arises because:
1. `pythonpath = src` adds `/project/src` to `sys.path`
2. `--import-mode=importlib` uses Python's import machinery differently
3. Tests import `from src.xxx` which requires `/project` on path, not `/project/src`
4. Editable install makes `src` available as top-level package
5. The redundant `pythonpath = src` setting interferes with this

### Evidence

```bash
# Direct import works
.venv/bin/python -c "from src.infrastructure.adapters.file_repository import FileRepository; print('SUCCESS')"
# Output: SUCCESS

# pytest fails
uv run pytest
# Output: 52 errors - ModuleNotFoundError: No module named 'src'

# Workaround verified
uv run pytest --override-ini="pythonpath="
# Output: 241 passed, 1 failed (unrelated failure)
```

---

## Tasks

- [x] Diagnose root cause of import errors
- [x] Verify workaround (`--override-ini="pythonpath="`)
- [ ] Apply fix to pytest.ini
- [ ] Remove redundant path manipulation from conftest.py
- [ ] Verify all tests pass
- [ ] Verify CI compatibility

---

## Implementation Plan

### Step 1: Fix pytest.ini

**File:** `pytest.ini`

**Change:**
```diff
[pytest]
-pythonpath = src
+pythonpath =
testpaths = tests
addopts = --import-mode=importlib
```

**Rationale:** The editable install (`pip install -e .` or `uv pip install -e .`) makes `src` available as a package. No additional path manipulation is needed.

### Step 2: Clean up conftest.py

**File:** `tests/conftest.py`

**Change:** Remove redundant `sys.path` manipulation that conflicts with the fix.

### Step 3: Verify

```bash
uv run pytest -v
```

Expected: All tests pass (except any pre-existing failures unrelated to imports).

---

## Acceptance Criteria

| Criterion | Validation |
|-----------|------------|
| Tests collect without import errors | `uv run pytest --collect-only` shows 1722 items |
| Tests pass | `uv run pytest` exits with code 0 (or known failures only) |
| CI passes | GitHub Actions workflow succeeds |
| No regression | Same tests pass as with workaround |

---

## References

- [pytest pythonpath docs](https://docs.pytest.org/en/stable/reference/reference.html#confval-pythonpath)
- [pytest import-mode docs](https://docs.pytest.org/en/stable/explanation/goodpractices.html#choosing-a-test-layout-import-rules)
- BUG-001 in WORKTRACKER.md

---

## Progress Log

| Time | Action | Result |
|------|--------|--------|
| 2026-01-12 | Diagnosed root cause | Identified `pythonpath=src` conflict |
| 2026-01-12 | Verified workaround | 241 passed with `--override-ini="pythonpath="` |
| 2026-01-12 | Applied fix to pytest.ini | Changed `pythonpath = src` to `pythonpath =` |
| 2026-01-12 | Cleaned up conftest.py | Removed redundant sys.path manipulation |
| 2026-01-12 | Verified tests pass | **1714 passed**, 5 failed (unrelated - see DISC-005), 3 skipped |

---

## Resolution

**Status: DONE**

The pytest pythonpath fix was successful:
- **Before:** 52 collection errors (`ModuleNotFoundError: No module named 'src'`)
- **After:** 1714 passed, 5 failed (pre-existing, unrelated), 3 skipped

The 5 failing tests are a **separate issue** (DISC-005) - project validation tests use incorrect absolute paths.

**Files Modified:**
1. `pytest.ini` - Removed `pythonpath = src`
2. `tests/conftest.py` - Removed redundant `sys.path` manipulation
