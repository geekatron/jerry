# ORCHESTRATION.yaml
# Machine-readable orchestration state for SPIKE-002 CLI Integration Research
# Document ID: PROJ-004-SPIKE002-ORCH-STATE
# Version: 1.3
# Last Updated: 2026-02-19
# Generated by: main context (orchestrator)

schema_version: "2.0.0"

# =============================================================================
# WORKFLOW METADATA
# =============================================================================
workflow:
  id: "spike002-cli-integration-20260219-001"
  name: "SPIKE-002 Jerry CLI Integration Architecture for Context Resilience"
  project_id: "PROJ-004"
  version: "1.3"
  created_at: "2026-02-19T00:00:00Z"
  updated_at: "2026-02-19T00:00:00Z"
  status: "COMPLETE"

  id_source: "auto"
  id_format: "semantic-date-seq"

  spike_entity: "projects/PROJ-004-context-resilience/work/EPIC-001-context-resilience/FEAT-001-context-detection/SPIKE-002-cli-integration.md"
  predecessor: "spike001-ctxres-20260219-001"
  predecessor_gap: "SPIKE-001 focused entirely on hook scripts; did not audit or factor in Jerry CLI infrastructure (TokenCounter, session lifecycle, config system, enforcement engines)"

  criticality: "C3"
  criticality_rationale: "Architecture revision. Modified ADR (AE-003 = auto-C3). Affects hook integration pattern, bounded context design, and CLI command surface."

  timebox_hours: 6

  patterns:
    - SEQUENTIAL

  constraints:
    max_agent_nesting: 1
    file_persistence: true

# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================
pipelines:
  research:
    short_alias: "res"
    skill_source: "problem-solving"
    current_phase: 5

    phases:
      - id: 1
        name: "CLI Capability Audit"
        status: "COMPLETE"
        agents:
          - id: "cli-auditor"
            role: "ps-researcher"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-1-audit/cli-auditor/cli-capability-audit.md"

      - id: 2
        name: "Gap Analysis"
        status: "COMPLETE"
        agents:
          - id: "gap-analyst"
            role: "ps-analyst"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-2-gap-analysis/gap-analyst/gap-analysis.md"

      - id: 3
        name: "Revised Architecture"
        status: "COMPLETE"
        agents:
          - id: "architecture-designer"
            role: "ps-architect"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-3-architecture/architecture-designer/adr-cli-integration.md"

      - id: 4
        name: "Synthesis & Revised Work Items"
        status: "COMPLETE"
        agents:
          - id: "work-item-synthesizer"
            role: "ps-synthesizer"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-4-synthesis/work-item-synthesizer/revised-work-items.md"

      - id: 5
        name: "Architecture Revision (DISC-001 + DEC-001)"
        status: "COMPLETE"
        note: "User review identified that ADR-SPIKE002-001 chose the wrong alternative. DISC-001 documents hook-CLI violations. DEC-001 captures 4 corrective decisions. Phase 5 revises the ADR, quality gates it, and produces revised work items."
        agents:
          - id: "adr-reviser"
            role: "ps-architect"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-5-revision/adr-reviser/adr-cli-integration-v2.md"
          - id: "qg-2-scorer"
            role: "adv-scorer"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/quality-gates/qg-2/gate-result-iter2.md"
          - id: "work-item-reviser"
            role: "ps-synthesizer"
            status: "COMPLETE"
            artifact: "orchestration/spike002-cli-integration-20260219-001/res/phase-5-revision/work-item-reviser/revised-work-items-v2.md"

# =============================================================================
# QUALITY GATES
# =============================================================================
quality_gates:
  qg-1:
    name: "Architecture Review"
    after_phase: 3
    before_phase: 4
    status: "PASS"
    threshold: 0.92
    strategies: ["S-003", "S-007", "S-002", "S-014"]
    iteration_count: 1
    iteration_history:
      - iteration: 1
        score: 0.94
        verdict: "PASS"
        defects: 1_P2_4_P3
        note: "P2: Missing rollback strategy. User feedback: InMemorySessionRepository should not be treated as hard constraint."

  qg-2:
    name: "Revised Architecture Review (C3)"
    after_agent: "adr-reviser"
    before_agent: "work-item-reviser"
    status: "PASS"
    threshold: 0.92
    strategies: ["S-003", "S-007", "S-002", "S-014", "S-004", "S-012", "S-013"]
    iteration_count: 2
    note: "C3 criticality per AE-003 (modified ADR). 7 strategies required. Iteration 1 scored 0.89 REVISE. ADR revised. Iteration 2 scored 0.92 PASS."
    iteration_history:
      - iteration: 1
        score: 0.89
        verdict: "REVISE"
        defects: 3_REQUIRED_2_RECOMMENDED_3_OPTIONAL
        note: "DEF-001: H-10 violation (3 events in 1 file). DEF-002: ResumptionContextGenerator undefined. DEF-003: session-start wrapper inconsistency."
      - iteration: 2
        score: 0.92
        verdict: "PASS"
        defects: 2_MEDIUM_4_LOW
        note: "All 3 required revisions addressed. Residual: DEF-004 CLI registration underspecified, DEF-005 acknowledgment timing gap."

# =============================================================================
# EXECUTION QUEUE
# =============================================================================
execution_queue:
  current_group: 8
  groups:
    - id: 1
      execution_mode: "SEQUENTIAL"
      agents: ["cli-auditor"]
    - id: 2
      execution_mode: "SEQUENTIAL"
      agents: ["gap-analyst"]
    - id: 3
      execution_mode: "SEQUENTIAL"
      agents: ["architecture-designer"]
    - id: 4
      execution_mode: "SEQUENTIAL"
      agents: ["qg-1-scorer"]
    - id: 5
      execution_mode: "SEQUENTIAL"
      agents: ["work-item-synthesizer"]
    - id: 6
      execution_mode: "SEQUENTIAL"
      agents: ["adr-reviser"]
    - id: 7
      execution_mode: "SEQUENTIAL"
      agents: ["qg-2-scorer"]
    - id: 8
      execution_mode: "SEQUENTIAL"
      agents: ["work-item-reviser"]

# =============================================================================
# CHECKPOINTS
# =============================================================================
checkpoints:
  latest_id: "cp-002"
  entries:
    - id: "cp-001"
      timestamp: "2026-02-19T00:00:00Z"
      trigger: "PHASE_COMPLETE"
      recovery_point: "Phase 2 start"
    - id: "cp-002"
      timestamp: "2026-02-19T00:00:00Z"
      trigger: "USER_FEEDBACK"
      recovery_point: "Phase 5 start -- user review identified ADR chose wrong alternative"

# =============================================================================
# METRICS
# =============================================================================
metrics:
  phases_complete: 5
  phases_total: 5
  agents_executed: 7
  agents_total: 7
  quality_gates_passed: 2
  quality_gates_total: 2
  progress_percent: 100

# =============================================================================
# RESUMPTION
# =============================================================================
resumption:
  last_completed_phase: 5
  next_action: "SPIKE-002 COMPLETE. All 5 phases done, both QGs passed. Next: Accept DEC-001 decisions, update FEAT-001 children with 12 CWIs from revised-work-items-v2.md, begin implementation starting with CWI-00 (FileSystemSessionRepository)."
  files_to_read:
    - "projects/PROJ-004-context-resilience/orchestration/spike002-cli-integration-20260219-001/res/phase-5-revision/work-item-reviser/revised-work-items-v2.md"
    - "projects/PROJ-004-context-resilience/orchestration/spike002-cli-integration-20260219-001/res/phase-5-revision/adr-reviser/adr-cli-integration-v2.md"
    - "projects/PROJ-004-context-resilience/work/EPIC-001-context-resilience/FEAT-001-context-detection/DEC-001-cli-first-architecture.md"
  context_summary: "SPIKE-002 complete. 5 phases, 7 agents, 2 quality gates (QG-1 0.94 PASS, QG-2 0.92 PASS after 2 iterations). ADR-SPIKE002-002 chose Alternative 3: proper bounded context src/context_monitoring/ with CLI-first hooks. 12 revised work items (CWI-00 through CWI-11) ready for FEAT-001 implementation. DEC-001 contains 4 architectural decisions pending user acceptance."
