# BUG-007: Plugin Hook Scripts Require Pip Installation

> **Bug ID:** BUG-007
> **Type:** Bug
> **Status:** FIXED
> **Severity:** HIGH
> **Parent:** [FT-002](./FEATURE-WORKTRACKER.md)
> **Enabler:** [EN-003](./en-003.md)
> **Discovered:** 2026-01-13
> **Resolved:** 2026-01-13

---

## Problem Description

The plugin's SessionStart hook (`scripts/session_start.py`) did not execute, preventing the Jerry Framework startup message from appearing. The root cause was that the script delegated to modules that required `pip install -e .` to function.

---

## Reproduction Steps

1. Install Jerry plugin via local marketplace (succeeds)
2. Start a new Claude Code session
3. **Expected:** Jerry Framework startup message appears with project context
4. **Actual:** No startup message appears

---

## Root Cause Analysis

### File: `scripts/session_start.py` (lines 25-49)

The script was labeled "Legacy Wrapper" and attempted three execution paths, ALL requiring pip:

| Execution Path | Requirement | Evidence |
|----------------|-------------|----------|
| `.venv/bin/jerry-session-start` | Entry point requires `pip install -e .` | `pyproject.toml:48` |
| `.venv/bin/python -m src.interface.cli.session_start` | Requires venv with package installed | Module import path |
| `sys.executable -m src.interface.cli.session_start` | Requires `pip install -e .` | Module import path |

### File: `src/interface/cli/session_start.py` (lines 44-51)

The actual implementation imports from internal packages:

```python
from src.infrastructure.adapters.configuration.layered_config_adapter import LayeredConfigAdapter
from src.infrastructure.adapters.persistence.atomic_file_adapter import AtomicFileAdapter
from src.session_management.application import GetProjectContextQuery
from src.session_management.infrastructure import FilesystemProjectAdapter, OsEnvironmentAdapter
```

These imports require the `src` package to be installed or accessible via PYTHONPATH.

---

## Evidence Sources

| Source | Reference | Citation |
|--------|-----------|----------|
| scripts/session_start.py | Lines 1-16 | Docstring states "DEPRECATED: This script is a legacy wrapper" |
| scripts/session_start.py | Lines 29-49 | All three fallback paths require pip installation |
| hooks/hooks.json | Line 10 | Hook invokes: `python3 ${CLAUDE_PLUGIN_ROOT}/scripts/session_start.py` |
| pyproject.toml | Line 48 | Entry point: `jerry-session-start = "src.interface.cli.session_start:main"` |
| src/interface/cli/session_start.py | Lines 44-51 | Imports from `src.*` packages |

---

## Blast Radius Assessment

**Status:** COMPLETED
**Audit Date:** 2026-01-13

| Script | Status | Imports | Evidence |
|--------|--------|---------|----------|
| `scripts/session_start.py` | **AFFECTED** | Delegates to `src.*` modules | Lines 29-49: All paths require pip |
| `scripts/pre_tool_use.py` | SAFE | stdlib + local `patterns/` | Lines 23-43: graceful fallback |
| `scripts/subagent_stop.py` | SAFE | stdlib only | Lines 16-20: no external deps |
| `scripts/post_tool_use.py` | SAFE | stdlib + local `patterns/` | Lines 22-42: graceful fallback |

**Conclusion:** Only `scripts/session_start.py` was affected. Blast radius LIMITED to SessionStart hook.

---

## Resolution

### Solution Implemented (ADR e-010)

**Option A: uv run with PYTHONPATH**

Changed hook command in `hooks/hooks.json`:

```json
// Before
"command": "python3 ${CLAUDE_PLUGIN_ROOT}/scripts/session_start.py"

// After
"command": "PYTHONPATH=\"${CLAUDE_PLUGIN_ROOT}\" uv run ${CLAUDE_PLUGIN_ROOT}/src/interface/cli/session_start.py"
```

### Changes Made

| File | Change |
|------|--------|
| `hooks/hooks.json` | Updated SessionStart command to use `uv run` with PYTHONPATH |
| `src/interface/cli/session_start.py` | Added PEP 723 inline script metadata |
| `scripts/session_start.py` | Deleted (legacy wrapper no longer needed) |
| `docs/INSTALLATION.md` | Added uv as required dependency |

### Discovery During Implementation

**DISC-005:** PYTHONPATH must be set for `uv run` to access local `src/` imports. PEP 723 dependencies list only handles PyPI packages.

---

## Verification

**Verified Working:**
```bash
$ PYTHONPATH="." uv run src/interface/cli/session_start.py
Jerry Framework initialized. See CLAUDE.md for context.
<project-context>
ProjectActive: PROJ-005-plugin-bugs
...
</project-context>
```

**Exit Code:** 0 (always)

---

## References

| Artifact | Location |
|----------|----------|
| Root Cause Analysis | This document |
| Solution ADR | [e-010](../../../decisions/PROJ-005-e-010-adr-uv-session-start.md) |
| Validation Report | [e-011](../../../analysis/PROJ-005-e-011-validation.md) |
| Trade-off Analysis | [e-009](../../../analysis/PROJ-005-e-009-tradeoffs.md) |
| PYTHONPATH Discovery | [DISC-005](./disc-005.md) |
| Enabler Tasks | [EN-003](./en-003.md) |
| Archived Bug Tracking | [PHASE-BUGS.md](../../archive/PHASE-BUGS.md) |
