# EN-003: Fix session_start.py Pip Dependency (BUG-007)

> **Enabler ID:** EN-003
> **Name:** Fix session_start.py Pip Dependency
> **Type:** Enabler (Technical)
> **Status:** IN PROGRESS
> **Parent:** [FT-002](./FEATURE-WORKTRACKER.md)
> **Created:** 2026-01-13
> **Last Updated:** 2026-01-13

---

## Overview

The plugin's SessionStart hook (`scripts/session_start.py`) does not execute, preventing the Jerry Framework startup message from appearing. The root cause is that the script delegates to modules that require `pip install -e .` to function.

### Bug Addressed

| Bug ID | Description | Status |
|--------|-------------|--------|
| BUG-007 | session_start.py requires pip installation | IN PROGRESS |

### Discoveries

| ID | Description |
|----|-------------|
| DISC-003 | Other hook scripts (pre_tool_use, subagent_stop, post_tool_use) are properly standalone |
| DISC-004 | ps-* artifact naming convention was violated during initial analysis |

---

## Root Cause Analysis

**File:** `scripts/session_start.py` (lines 25-49)

The script is labeled "Legacy Wrapper" and attempts three execution paths, ALL requiring pip:

| Execution Path | Requirement | Evidence |
|----------------|-------------|----------|
| `.venv/bin/jerry-session-start` | Entry point requires `pip install -e .` | `pyproject.toml:48` |
| `.venv/bin/python -m src.interface.cli.session_start` | Requires venv with package installed | Module import path |
| `sys.executable -m src.interface.cli.session_start` | Requires `pip install -e .` | Module import path |

**File:** `src/interface/cli/session_start.py` (lines 44-51)

The actual implementation imports from internal packages:
```python
from src.infrastructure.adapters.configuration.layered_config_adapter import LayeredConfigAdapter
from src.infrastructure.adapters.persistence.atomic_file_adapter import AtomicFileAdapter
from src.session_management.application import GetProjectContextQuery
from src.session_management.infrastructure import FilesystemProjectAdapter, OsEnvironmentAdapter
```

These imports require the `src` package to be installed.

---

## Approved Solution (ADR e-010)

**Option A: uv run in hooks.json** (Score: 44/50)

Per ADR PROJ-005-e-010-adr-uv-session-start.md:

1. Update `hooks/hooks.json` to use `uv run`
2. Add PEP 723 metadata to `src/interface/cli/session_start.py`
3. Delete `scripts/session_start.py` (legacy wrapper)
4. Update INSTALLATION.md with uv requirement
5. Add regression tests

---

## Tasks

### Task 1: Audit blast radius

**Status:** COMPLETED

| Script | Status | Evidence |
|--------|--------|----------|
| session_start.py | AFFECTED | Lines 29-49: All paths require pip |
| pre_tool_use.py | SAFE | stdlib + local patterns with fallback |
| subagent_stop.py | SAFE | stdlib only |
| post_tool_use.py | SAFE | stdlib + local patterns with fallback |

**Conclusion:** Blast radius LIMITED to SessionStart hook only.

---

### Task 2: Research alternatives (uv, pip, etc.)

**Status:** COMPLETED

**Output:** [e-008 uv dependency management research](../../research/PROJ-005-e-008-uv-dependency-management.md)

**Key Findings:**
- Claude Code plugins CAN have Python dependencies
- uv + PEP 723 enables inline script dependencies
- `uv run` creates ephemeral environments automatically
- No manual pip install or venv activation required

---

### Task 3: Analyze trade-offs

**Status:** COMPLETED

**Output:** [e-009 trade-off analysis](../../analysis/PROJ-005-e-009-tradeoffs.md)

**Recommendation:** Option A (uv run in hooks.json) with score 44/50

**Critical Finding:** Options B (sys.path) and D (PYTHONPATH) FAIL because imports require installed packages, not just path manipulation.

---

### Task 4: Create ADR

**Status:** COMPLETED

**Output:** [e-010 ADR uv session start](../../decisions/PROJ-005-e-010-adr-uv-session-start.md)

**Status:** Accepted (supersedes ADR-PROJ005-001)

---

### Task 5: Validate solution

**Status:** COMPLETED

**Output:** [e-011 validation report](../../analysis/PROJ-005-e-011-validation.md)

**Recommendation:** GO (92% confidence, 0 blocking issues)

| Category | Score | Status |
|----------|-------|--------|
| Functional Requirements | 12/12 | PASS |
| User Requirements | 4/4 | PASS |
| Contract Tests | 13/13 | PASS |
| Testing Strategy | Complete | PASS |

---

### Task 6: Update hooks.json

**Status:** PENDING

**Change Required:**
```json
// Before
"command": "python3 ${CLAUDE_PLUGIN_ROOT}/scripts/session_start.py"

// After
"command": "uv run ${CLAUDE_PLUGIN_ROOT}/src/interface/cli/session_start.py"
```

**Acceptance Criteria:**
- [ ] hooks.json updated with uv run command
- [ ] Hook invokes src/interface/cli/session_start.py directly

---

### Task 7: Add PEP 723 metadata and delete legacy wrapper

**Status:** PENDING

**Changes Required:**

1. Add to `src/interface/cli/session_start.py` (after shebang):
```python
# /// script
# dependencies = []
# requires-python = ">=3.11"
# ///
```

2. Delete `scripts/session_start.py`

3. Update `docs/INSTALLATION.md` with uv requirement

**Acceptance Criteria:**
- [ ] PEP 723 metadata added to session_start.py
- [ ] scripts/session_start.py deleted
- [ ] INSTALLATION.md documents uv requirement
- [ ] Hook works on fresh clone without pip install
- [ ] All contract tests pass

---

## Verification Checklist

- [ ] `uv run src/interface/cli/session_start.py` works from plugin root
- [ ] Output matches contract test expectations (13 tests)
- [ ] Works with JERRY_PROJECT set (project-context tag)
- [ ] Works without JERRY_PROJECT (project-required tag)
- [ ] Works with invalid JERRY_PROJECT (project-error tag)
- [ ] Exit code is always 0
- [ ] Works on fresh clone without pip install

---

## References

| Source | Location |
|--------|----------|
| BUG-007 Report | [../../../PHASE-BUGS.md](../../PHASE-BUGS.md) |
| ADR (Accepted) | [e-010](../../decisions/PROJ-005-e-010-adr-uv-session-start.md) |
| Validation | [e-011](../../analysis/PROJ-005-e-011-validation.md) |
| uv Documentation | https://docs.astral.sh/uv/ |
| PEP 723 | https://peps.python.org/pep-0723/ |
