# EN-004: Fix and Enhance session_start.py Tests

> **Enabler ID:** EN-004
> **Name:** Fix and enhance session_start.py tests for new execution model
> **Type:** Enabler (Technical)
> **Status:** IN PROGRESS
> **Parent:** [FT-003](./FEATURE-WORKTRACKER.md)
> **Created:** 2026-01-13
> **Last Updated:** 2026-01-13

---

## Overview

Fix existing comprehensive E2E tests for `session_start.py` that are broken after BUG-007 fix, and enhance them to validate the new `uv run` execution model.

### Problem Addressed

- **TD-001:** No automated tests for plugin hooks (partially addressed - tests exist but are broken)
- **DISC-007:** Existing tests broken after BUG-007 deleted `scripts/session_start.py`
- **Origin:** BUG-007 fix changed script location and execution method

### Discovery Context

**DISC-007** revealed that comprehensive tests already exist:
- **Location:** `tests/session_management/e2e/test_session_start.py`
- **Test Count:** 23 tests (606 lines)
- **Coverage:** All 3 output tags, exit codes, edge cases, failure scenarios
- **Status:** BROKEN - references deleted `scripts/session_start.py`

### Success Criteria

- [x] Tests cover `<project-context>` output (valid project) - EXISTING
- [x] Tests cover `<project-required>` output (no project set) - EXISTING
- [x] Tests cover `<project-error>` output (invalid project) - EXISTING
- [x] Tests verify exit code is always 0 - EXISTING
- [x] Tests updated to use `src/interface/cli/session_start.py` - DONE (Task 2)
- [x] Tests updated to execute via `uv run` - DONE (Task 3)
- [x] Tests set PYTHONPATH for local imports - DONE (Task 4)
- [x] Tests pass with new execution model - DONE (Task 5)
- [x] Tests validate PEP 723 inline metadata presence (NEW) - DONE (Task 6)
- [x] All 25 tests pass (23 + 2 new) - DONE (Task 8)

---

## Tasks

| # | Task | Status | Evidence |
|---|------|--------|----------|
| 1 | Verify existing tests are broken (run pytest) | DONE | 23/23 tests FAIL, exit code 2, references deleted scripts/session_start.py |
| 2 | Update `session_start_script` fixture to new location | DONE | Updated to src/interface/cli/session_start.py |
| 3 | Update `run_session_start` helper to use `uv run` | DONE | Changed from sys.executable to `["uv", "run", str(script_path)]` |
| 4 | Add PYTHONPATH to subprocess environment | DONE | PYTHONPATH=project_root for "from src.X" imports |
| 5 | Run tests and verify they pass | DONE | 23/23 tests PASSED in 3.52s |
| 6 | Add test for PEP 723 metadata presence | DONE | TestSessionStartPEP723::test_pep723_metadata_present PASSED |
| 7 | Add test for standalone execution without pip | DONE | TestSessionStartPEP723::test_pep723_script_executes_standalone PASSED |
| 8 | Verify all 23+ tests pass | DONE | 25/25 tests PASSED in 3.85s |
| 9 | Commit fix with evidence | IN PROGRESS | |

---

## Technical Approach

### Current Broken Code

```python
# tests/session_management/e2e/test_session_start.py:57-59 (BROKEN)
@pytest.fixture
def session_start_script(project_root: Path) -> Path:
    """Get path to the session_start.py script."""
    return project_root / "scripts" / "session_start.py"  # DELETED FILE
```

### Required Fix

```python
# tests/session_management/e2e/test_session_start.py (FIXED)
@pytest.fixture
def session_start_script(project_root: Path) -> Path:
    """Get path to the session_start.py script."""
    return project_root / "src" / "interface" / "cli" / "session_start.py"


def run_session_start(
    script_path: Path,
    env_vars: dict | None = None,
    project_root: Path | None = None,
) -> tuple[int, str, str]:
    """Run the session_start.py script via uv run."""
    env = os.environ.copy()
    if env_vars:
        env.update(env_vars)

    # Set PYTHONPATH for local src/ imports
    if project_root:
        env["PYTHONPATH"] = str(project_root / "src")

    result = subprocess.run(
        ["uv", "run", str(script_path)],
        capture_output=True,
        text=True,
        env=env,
        cwd=str(project_root) if project_root else None,
    )

    return result.returncode, result.stdout, result.stderr
```

### New Test to Add

```python
class TestSessionStartPEP723:
    """Tests for PEP 723 inline metadata."""

    def test_pep723_metadata_present(self, session_start_script: Path) -> None:
        """Script contains valid PEP 723 inline script metadata."""
        content = session_start_script.read_text()

        # Verify PEP 723 marker
        assert "# /// script" in content
        assert "# ///" in content

        # Verify dependencies declared
        assert "dependencies" in content
```

---

## Acceptance Criteria

1. All 9 tasks completed with evidence
2. All 23+ tests pass with `pytest tests/session_management/e2e/test_session_start.py`
3. Tests execute via `uv run` (not direct python)
4. No `pip install -e .` required for tests to pass

---

## Related Artifacts

| Type | Location | Description |
|------|----------|-------------|
| Broken Tests | `tests/session_management/e2e/test_session_start.py` | 23 E2E tests to fix |
| New Script Location | `src/interface/cli/session_start.py` | Target script |
| DISC-007 | [./disc-007.md](./disc-007.md) | Discovery of broken tests |
| BUG-007 | [../../SE-001/FT-002/bug-007.md](../../SE-001/FT-002/bug-007.md) | Fix that broke tests |
| ADR e-010 | [../../../decisions/PROJ-005-e-010-adr-uv-session-start.md](../../../decisions/PROJ-005-e-010-adr-uv-session-start.md) | Decision record |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-13 | Created EN-004 for session_start.py testing | Claude |
| 2026-01-13 | SCOPE CHANGE: Fix existing tests (DISC-007) instead of creating new | Claude |
