# EN-005: Pre-commit/CI Hooks for Plugin Validation

> **Enabler ID:** EN-005
> **Name:** Pre-commit/CI hooks for plugin validation
> **Type:** Enabler (Technical)
> **Status:** IN PROGRESS
> **Parent:** [FT-003](./FEATURE-WORKTRACKER.md)
> **Created:** 2026-01-13
> **Last Updated:** 2026-01-13

---

## Overview

Implement pre-commit hooks and CI pipeline checks to validate plugin artifacts (manifests, hooks, scripts) before merge, preventing regressions like BUG-007.

### Problem Addressed

- **TD-002:** No CI validation of standalone script execution
- **DISC-008:** Pre-commit pytest uses `.venv/bin/python -m pytest` instead of `uv run pytest`
- **Origin:** BUG-007 - broken hook shipped because no CI validation existed

### Success Criteria

- [ ] JSON Schemas obtained (official) or created (via Context7) for all manifests
- [ ] Pre-commit hook validates `.claude-plugin/plugin.json` schema
- [ ] Pre-commit hook validates `.claude-plugin/marketplace.json` schema
- [ ] Pre-commit hook validates `hooks/hooks.json` (root level)
- [ ] Pre-commit pytest hook fixed to use `uv run pytest` (DISC-008)
- [ ] CI job (in existing `ci.yml`) validates plugin manifests
- [ ] CI job executes `session_start.py` standalone via `uv run`
- [ ] CI fails if any hook script returns non-zero or has import errors
- [ ] Documentation for hook configuration

---

## Decisions

### DEC-001: Extend ci.yml vs New Workflow

**Decision:** Extend existing `.github/workflows/ci.yml` instead of creating new `plugin-integration.yml`.

**Rationale:**
- Single source of truth for all CI validation
- Unified test gate ("everything tested before commit or release")
- Avoids duplicate setup steps and maintenance burden
- Plugin validation is just another quality check - belongs with the rest of CI

**Alternatives Considered:**
- Separate `plugin-integration.yml` - rejected due to fragmentation

### DEC-002: Schema Validation Approach

**Decision:** Full JSON Schema validation using official schemas where available, custom schemas (via Context7) otherwise.

**Rationale:**
- Full validation catches more errors than structural checks
- Official schemas ensure compliance with Claude Code requirements
- Custom schemas documented and versioned in repo

### DEC-003: Fix Pre-commit Pytest Hook

**Decision:** Fix existing pytest pre-commit hook to use `uv run pytest` as part of this enabler.

**Rationale:**
- DISC-008 established `uv run pytest` is required for correct execution model
- Current `.venv/bin/python -m pytest` bypasses uv dependency management
- In-scope for EN-005 as it's a pre-commit hook fix

---

## Tasks

| # | Task | Status | Evidence |
|---|------|--------|----------|
| 1 | Obtain/create JSON schemas for plugin.json, marketplace.json, hooks.json | PENDING | |
| 2 | Fix pre-commit pytest hook to use `uv run pytest` (DISC-008) | PENDING | |
| 3 | Implement `scripts/validate_plugin_manifests.py` with full JSON Schema validation | PENDING | |
| 4 | Add pre-commit hook entry for plugin manifest validation | PENDING | |
| 5 | Extend `ci.yml` with plugin manifest validation job | PENDING | |
| 6 | Add CI job to execute `session_start.py` standalone via `uv run` | PENDING | |
| 7 | Add CI job to validate other hook scripts | PENDING | |
| 8 | Test pre-commit hooks locally | PENDING | |
| 9 | Document hook configuration | PENDING | |

---

## Technical Approach

### Pre-commit Configuration

```yaml
# .pre-commit-config.yaml (additions/modifications)

# Fix pytest to use uv run (DISC-008)
- repo: local
  hooks:
    - id: pytest
      name: pytest (full suite)
      entry: uv run pytest
      language: system
      types: [python]
      pass_filenames: false
      stages: [pre-commit]
      args: [--tb=short, -q]

# New: Plugin manifest validation
    - id: validate-plugin-manifests
      name: Validate plugin manifests
      entry: uv run python scripts/validate_plugin_manifests.py
      language: system
      files: (plugin\.json|marketplace\.json|hooks\.json)$
      pass_filenames: false
```

### CI Workflow Extension

```yaml
# .github/workflows/ci.yml (additions)
jobs:
  # ... existing jobs ...

  plugin-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Validate plugin manifests
        run: uv run python scripts/validate_plugin_manifests.py

      - name: Validate session_start.py standalone
        run: |
          PYTHONPATH="." uv run src/interface/cli/session_start.py
        env:
          JERRY_PROJECT: ""
          CLAUDE_PROJECT_DIR: ${{ github.workspace }}

      - name: Validate hook scripts syntax
        run: |
          for script in hooks/*.py; do
            uv run python -m py_compile "$script"
          done
```

### Validation Script

```python
# scripts/validate_plugin_manifests.py
"""Validate plugin manifest files against JSON Schema.

Uses official Claude Code schemas where available, custom schemas otherwise.
Schemas are stored in schemas/ directory and versioned with the repo.
"""

import json
from pathlib import Path
import jsonschema

SCHEMA_DIR = Path(__file__).parent.parent / "schemas"

def validate_plugin_json() -> bool: ...
def validate_marketplace_json() -> bool: ...
def validate_hooks_json() -> bool: ...

def main() -> int:
    """Run all validations, return 0 on success, 1 on failure."""
    ...
```

---

## Acceptance Criteria

1. All 9 tasks completed with evidence
2. Pre-commit hook catches manifest errors locally
3. Pre-commit pytest uses `uv run pytest` (DISC-008 resolved)
4. CI validation runs on all PRs (in existing ci.yml)
5. CI fails if hook scripts have import errors
6. JSON Schemas stored in `schemas/` directory
7. Documentation updated

---

## Related Artifacts

| Type | Location | Description |
|------|----------|-------------|
| Plugin Manifest | `.claude-plugin/plugin.json` | Target validation |
| Marketplace Manifest | `.claude-plugin/marketplace.json` | Target validation |
| Hooks Config | `hooks/hooks.json` | Target validation (root level) |
| Pre-commit Config | `.pre-commit-config.yaml` | Hook configuration |
| CI Workflow | `.github/workflows/ci.yml` | Existing CI to extend |
| DISC-008 | [./disc-008.md](./disc-008.md) | pytest must use uv |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-13 | Created EN-005 for pre-commit/CI hooks | Claude |
| 2026-01-13 | **REVISED**: Updated tasks, added decisions (DEC-001 to DEC-003) | Claude |
| 2026-01-13 | Corrected hooks.json location (root, not .claude-plugin/) | Claude |
| 2026-01-13 | Added DISC-008 fix (pytest hook) to scope | Claude |
