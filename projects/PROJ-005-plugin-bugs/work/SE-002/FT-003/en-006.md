# EN-006: Integration Test Suite for CLI Commands

> **Enabler ID:** EN-006
> **Name:** Integration test suite for CLI commands
> **Type:** Enabler (Technical)
> **Status:** COMPLETED
> **Parent:** [FT-003](./FEATURE-WORKTRACKER.md)
> **Created:** 2026-01-13
> **Last Updated:** 2026-01-13

---

## Overview

Create integration tests that verify Jerry CLI commands work correctly in plugin mode (without `pip install -e .`), ensuring the CLI integration remains functional.

### Problem Addressed

- **TD-001:** No automated tests for plugin functionality
- **Origin:** BUG-007 - CLI functionality was untested in plugin context

### Success Criteria

- [x] Integration tests for `jerry session` commands
- [x] Integration tests for `jerry items` commands
- [x] Integration tests for `jerry projects` commands
- [x] Tests execute via `uv run` (plugin mode)
- [x] Tests validate JSON output format
- [x] Tests validate exit codes
- [x] Coverage >= 80% for CLI adapter (existing tests cover this)

---

## Tasks

| # | Task | Status | Evidence |
|---|------|--------|----------|
| 1 | Create test directory `tests/integration/cli/` | DONE | Directory exists, `__init__.py` present |
| 2 | Implement tests for `jerry session start/end/status` | DONE | `test_jerry_cli_subprocess.py::TestSessionCommands` - 5 tests |
| 3 | Implement tests for `jerry items list/show` | DONE | `test_jerry_cli_subprocess.py::TestItemsCommands` - 5 tests |
| 4 | Implement tests for `jerry projects context/list/validate` | DONE | `test_jerry_cli_subprocess.py::TestProjectsCommands` - 6 tests |
| 5 | Implement tests for `--json` output format | DONE | `test_jerry_cli_subprocess.py::TestJsonOutput` - 3 tests |
| 6 | Implement tests for exit code validation | DONE | `test_jerry_cli_subprocess.py::TestExitCodes` - 5 tests |
| 7 | Configure pytest to run integration tests via uv | DONE | `pytest.ini` markers: `integration`, `subprocess` |
| 8 | Add integration test job to CI | DONE | `.github/workflows/ci.yml` - `cli-integration` job |
| 9 | Document integration test patterns | DONE | This document, Technical Approach section |

---

## Technical Approach

### Test File

**Location:** `tests/integration/cli/test_jerry_cli_subprocess.py`

### Test Classes

| Class | Purpose | Tests |
|-------|---------|-------|
| `TestProjectsCommands` | jerry projects context/list/validate | 6 |
| `TestSessionCommands` | jerry session start/end/status/abandon | 5 |
| `TestItemsCommands` | jerry items list/show/create | 5 |
| `TestExitCodes` | Exit code validation | 5 |
| `TestJsonOutput` | JSON output format validation | 3 |
| `TestPluginModeExecution` | Plugin mode (no pip install) validation | 3 |

**Total: 27 tests**

### Helper Function

```python
def run_jerry(
    args: list[str],
    project_root: Path,
    env: dict[str, str],
    input_text: str | None = None,
) -> subprocess.CompletedProcess[str]:
    """Execute jerry CLI via uv run.

    Args:
        args: Command arguments (e.g., ["projects", "context"])
        project_root: Project root path for cwd
        env: Environment variables (must include PYTHONPATH)
        input_text: Optional input for interactive commands

    Returns:
        CompletedProcess with stdout, stderr, and returncode
    """
    return subprocess.run(
        ["uv", "run", "jerry", *args],
        capture_output=True,
        text=True,
        env=env,
        cwd=str(project_root),
        input=input_text,
    )
```

### Fixtures

```python
@pytest.fixture
def project_root() -> Path:
    """Get the project root directory."""
    return Path(__file__).parent.parent.parent.parent

@pytest.fixture
def env_with_pythonpath(project_root: Path) -> dict[str, str]:
    """Create environment with PYTHONPATH set to project root."""
    env = os.environ.copy()
    existing = env.get("PYTHONPATH", "")
    env["PYTHONPATH"] = f"{project_root}:{existing}" if existing else str(project_root)
    return env
```

### Pytest Markers

Tests are marked with:
- `@pytest.mark.integration` - Integration test (may use filesystem/subprocess)
- `@pytest.mark.subprocess` - Executes CLI via subprocess (plugin mode validation)

Run only subprocess tests:
```bash
uv run pytest -m subprocess
```

### CI Job

```yaml
cli-integration:
  name: CLI Integration Tests
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v5
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Set up Python
      run: uv python install 3.14
    - name: Install dependencies
      run: uv sync --extra dev
    - name: Run CLI subprocess tests
      run: |
        PYTHONPATH="." uv run pytest \
          tests/integration/cli/test_jerry_cli_subprocess.py \
          -v --tb=short
```

---

## Test Pattern: Plugin Mode Validation

The key pattern for EN-006 is **subprocess CLI testing**, which validates:

1. **No pip install required** - Tests run via `uv run jerry` without editable install
2. **PYTHONPATH sufficiency** - Setting `PYTHONPATH="."` enables all imports
3. **Exit code correctness** - CLI returns proper exit codes (0=success, 1=error, 2=usage)
4. **JSON output validity** - All `--json` outputs are parseable JSON
5. **Error handling** - Error responses include `error` key in JSON mode

### Anti-patterns Detected

| Anti-pattern | Detection Method | Test |
|--------------|-----------------|------|
| ModuleNotFoundError | Check stderr for import errors | `test_imports_work_with_pythonpath` |
| Invalid JSON output | Parse all JSON outputs | `test_json_output_is_parseable` |
| Wrong exit codes | Assert return codes | `TestExitCodes` class |
| Namespace not accessible | Test all namespace --help | `test_all_namespaces_accessible_in_plugin_mode` |

---

## Acceptance Criteria

1. ✅ All 9 tasks completed with evidence
2. ✅ Integration tests pass via `uv run` (27 tests, 100% pass)
3. ✅ Tests run in CI without `pip install -e .` (cli-integration job)
4. ✅ Coverage meets target (existing adapter tests + new subprocess tests)
5. ✅ Test patterns documented (this document)

---

## Related Artifacts

| Type | Location | Description |
|------|----------|-------------|
| CLI Adapter | `src/interface/cli/` | Target under test |
| CLI Entry Point | `src/interface/cli/main.py` | Jerry CLI main |
| Test File | `tests/integration/cli/test_jerry_cli_subprocess.py` | 27 subprocess tests |
| CI Workflow | `.github/workflows/ci.yml` | cli-integration job |
| pytest.ini | `pytest.ini` | integration, subprocess markers |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-13 | Created EN-006 for CLI integration tests | Claude |
| 2026-01-13 | Tasks 1-6 DONE: Created test_jerry_cli_subprocess.py with 27 tests | Claude |
| 2026-01-13 | Task 7 DONE: Added pytest markers (integration, subprocess) | Claude |
| 2026-01-13 | Task 8 DONE: Added cli-integration job to CI | Claude |
| 2026-01-13 | Task 9 DONE: Documented test patterns, EN-006 COMPLETED | Claude |
