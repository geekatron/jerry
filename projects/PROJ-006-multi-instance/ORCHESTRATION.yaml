# ORCHESTRATION.yaml
# Machine-readable orchestration state for multi-agent workflows
# Document ID: PROJ-006-ORCH-STATE
# Version: 2.0
# Last Updated: 2026-02-20T00:00:00Z
# Schema Evolution: See docs/schemas/SCHEMA_VERSIONING.md
#
# DISCLAIMER: This file was generated by the orch-planner agent (v2.2.0).
# All paths, identifiers, and structural elements are auto-generated.
# Verify against ORCHESTRATION_PLAN.md before execution.

# Schema version for evolution support (semver format)
schema_version: "2.0.0"

# =============================================================================
# WORKFLOW METADATA
# =============================================================================
workflow:
  id: "multi-instance-20260220-001"
  name: "PROJ-006 Multi-Instance Strategy Assessment"
  project_id: "PROJ-006-multi-instance"
  version: "2.0"
  created_at: "2026-02-20T00:00:00Z"
  updated_at: "2026-02-20T00:00:00Z"
  status: "COMPLETE"
  started_at: "2026-02-20"
  completed_at: "2026-02-20"

  # Workflow ID configuration (WI-SAO-021)
  id_source: "auto"
  id_format: "semantic-date-seq"
  # Format: {purpose}-{YYYYMMDD}-{NNN}

  # Orchestration pattern classification
  patterns:
    - SEQUENTIAL      # Phases execute in order within each pipeline
    - CONCURRENT      # Pipelines A and B run in parallel
    - BARRIER_SYNC    # Cross-pollination at barriers 1 and 2
    - FAN_IN          # Convergent Phase 3 synthesizes both pipelines

  # Criticality assessment
  criticality:
    workflow_level: "C2"       # Standard: reversible within 1 day, 3-10 files
    phase_3_level: "C3"        # ADR auto-escalated per AE-003
    escalation_rules:
      - rule: "AE-003"
        condition: "New ADR in Phase 3"
        escalation: "auto-C3 minimum"

  # Constraints from Jerry Constitution
  constraints:
    max_agent_nesting: 1          # P-003: Single nesting
    file_persistence: true        # P-002: All state to filesystem
    user_authority: true          # P-020: User approves gates
    max_concurrent_agents: 2      # One per pipeline in parallel
    max_barrier_retries: 2        # Circuit breaker
    checkpoint_frequency: "PHASE" # AGENT | PHASE | BARRIER

# =============================================================================
# QUALITY FRAMEWORK
# =============================================================================
quality:
  threshold: 0.92
  min_iterations: 3  # Creator-critic-revision cycle (H-14)

  dimensions:
    - name: "Completeness"
      weight: 0.20
    - name: "Internal Consistency"
      weight: 0.20
    - name: "Methodological Rigor"
      weight: 0.20
    - name: "Evidence Quality"
      weight: 0.15
    - name: "Actionability"
      weight: 0.15
    - name: "Traceability"
      weight: 0.10

  score_bands:
    - band: "PASS"
      range: ">= 0.92"
      outcome: "Accepted"
    - band: "REVISE"
      range: "0.85 - 0.91"
      outcome: "Rejected (H-13), targeted revision"
    - band: "REJECTED"
      range: "< 0.85"
      outcome: "Rejected (H-13), significant rework"

  strategies_by_criticality:
    C2:
      required: ["S-007", "S-002", "S-014"]
      optional: ["S-003", "S-010"]
    C3:
      required: ["S-007", "S-002", "S-004", "S-012", "S-013", "S-014"]
      optional: ["S-001", "S-003", "S-010", "S-011"]

  enforcement:
    - id: "H-15"
      rule: "Self-review (S-010) before presenting any deliverable"
    - id: "H-16"
      rule: "Steelman (S-003) before Devil's Advocate (S-002)"
    - id: "H-18"
      rule: "Constitutional compliance check (S-007) for C2+ deliverables"

# =============================================================================
# PATH CONFIGURATION (WI-SAO-021)
# =============================================================================
paths:
  base: "orchestration/multi-instance-20260220-001/"
  pipeline: "{base}{pipeline_alias}/{phase_id}/{agent_id}/"
  barrier: "{base}cross-pollination/{barrier_id}/{direction}/"
  convergent: "{base}convergent/{phase_id}/{agent_id}/"

# =============================================================================
# PIPELINE DEFINITIONS
# =============================================================================
pipelines:
  pipeline_a:
    id: "pipeline-a"
    name: "SPIKE-001: SDK vs CLI Instance Comparison"
    description: "Research and analyze SDK (Anthropic Agent SDK) vs CLI (Claude Code) approaches for programmatic multi-instance management"
    short_alias: "spike-001"
    skill_source: "problem-solving"
    status: "COMPLETE"
    current_phase: 2
    total_phases: 2
    progress_percent: 100

    phases:
      - id: 1
        name: "Research"
        path_id: "phase-1-research"
        status: "COMPLETE"
        started_at: "2026-02-20"
        completed_at: "2026-02-20"
        agents:
          - id: "agent-a-001"
            name: "ps-researcher"
            status: "COMPLETE"
            artifact: "orchestration/multi-instance-20260220-001/spike-001/phase-1-research/agent-a-001/agent-a-001-research.md"
            inputs: []
            research_scope:
              - "Claude SDK (Anthropic Agent SDK) API surface -- Context7 + Web Search"
              - "Claude Code CLI flags, subprocess patterns, --print mode"
              - "Tool availability and control per approach"
              - "Session persistence mechanisms"
        artifacts: []

      - id: 2
        name: "Analysis"
        path_id: "phase-2-analysis"
        status: "COMPLETE"
        blocked_by: null
        started_at: "2026-02-20"
        completed_at: "2026-02-20"
        agents:
          - id: "agent-a-002"
            name: "ps-analyst"
            status: "COMPLETE"
            artifact: "orchestration/multi-instance-20260220-001/spike-001/phase-2-analysis/agent-a-002/agent-a-002-analysis.md"
            inputs:
              - "orchestration/multi-instance-20260220-001/spike-001/phase-1-research/agent-a-001/agent-a-001-research.md"
              - "orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-002-to-spike-001/handoff.md"
            analysis_dimensions:
              - dimension: "Programmatic Control"
                weight: 0.20
              - dimension: "Tool Surface"
                weight: 0.20
              - dimension: "Session Persistence"
                weight: 0.15
              - dimension: "Error Handling"
                weight: 0.10
              - dimension: "Developer Experience"
                weight: 0.10
              - dimension: "Cost"
                weight: 0.10
              - dimension: "Jerry Integration"
                weight: 0.10
              - dimension: "Scalability"
                weight: 0.05
        artifacts: []

  pipeline_b:
    id: "pipeline-b"
    name: "SPIKE-002: Worktree & Session Lifecycle"
    description: "Research and design automated worktree provisioning, session lifecycle management, and cross-instance coordination"
    short_alias: "spike-002"
    skill_source: "problem-solving"
    status: "COMPLETE"
    current_phase: 2
    total_phases: 2
    progress_percent: 100

    phases:
      - id: 1
        name: "Research"
        path_id: "phase-1-research"
        status: "COMPLETE"
        started_at: "2026-02-20"
        completed_at: "2026-02-20"
        agents:
          - id: "agent-b-001"
            name: "ps-researcher"
            status: "COMPLETE"
            artifact: "orchestration/multi-instance-20260220-001/spike-002/phase-1-research/agent-b-001/agent-b-001-research.md"
            inputs: []
            research_scope:
              - "Current manual worktree workflow (step-by-step documentation)"
              - "Git worktree API options (gitpython, subprocess, alternatives)"
              - "Environment provisioning requirements (JERRY_PROJECT, uv sync, hooks)"
              - "State coordination mechanisms across worktrees"
        artifacts: []

      - id: 2
        name: "Analysis"
        path_id: "phase-2-analysis"
        status: "COMPLETE"
        blocked_by: null
        started_at: "2026-02-20"
        completed_at: "2026-02-20"
        agents:
          - id: "agent-b-002"
            name: "ps-analyst"
            status: "COMPLETE"
            artifact: "orchestration/multi-instance-20260220-001/spike-002/phase-2-analysis/agent-b-002/agent-b-002-analysis.md"
            inputs:
              - "orchestration/multi-instance-20260220-001/spike-002/phase-1-research/agent-b-001/agent-b-001-research.md"
              - "orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-001-to-spike-002/handoff.md"
            analysis_scope:
              - "SDK session binding vs CLI subprocess binding to worktrees"
              - "Dispatch and monitoring patterns"
              - "Merge coordination strategies"
              - "Session lifecycle state machine"
        artifacts: []

  # Convergent pipeline (Fan-In)
  convergent:
    id: "convergent"
    name: "Decision Synthesis"
    description: "Convergent phase synthesizing both pipelines into a go/no-go ADR"
    short_alias: "convergent"
    skill_source: "problem-solving"
    status: "COMPLETE"
    current_phase: 3
    total_phases: 1
    progress_percent: 100

    phases:
      - id: 3
        name: "Decision"
        path_id: "phase-3-decision"
        status: "COMPLETE"
        blocked_by: null
        started_at: "2026-02-20"
        completed_at: "2026-02-20"
        criticality: "C3"  # Auto-escalated per AE-003 (new ADR)
        agents:
          - id: "agent-c-001"
            name: "ps-architect"
            status: "COMPLETE"
            artifact: "orchestration/multi-instance-20260220-001/convergent/phase-3-decision/agent-c-001/agent-c-001-adr.md"
            inputs:
              - "orchestration/multi-instance-20260220-001/spike-001/phase-2-analysis/agent-a-002/agent-a-002-analysis.md"
              - "orchestration/multi-instance-20260220-001/spike-002/phase-2-analysis/agent-b-002/agent-b-002-analysis.md"
              - "orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-001-to-spike-002/handoff.md"
              - "orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-002-to-spike-001/handoff.md"
            adr_scope:
              - "Recommended approach (SDK / CLI / hybrid)"
              - "Integration architecture"
              - "MVP scope definition"
              - "Risk assessment with mitigations"
        artifacts: []

# =============================================================================
# SYNC BARRIERS
# =============================================================================
barriers:
  - id: "barrier-1"
    name: "Phase 1 Cross-Pollination"
    status: "COMPLETE"
    completed_at: "2026-02-20"
    depends_on:
      - "pipeline_a.phase.1"
      - "pipeline_b.phase.1"
    quality_gate:
      threshold: 0.92
      strategies: ["S-014", "S-010"]
    artifacts:
      a_to_b:
        path: "orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-001-to-spike-002/handoff.md"
        status: "COMPLETE"
        key_content: "Instance approach options with capabilities/limitations per approach (SDK API surface, CLI flags, tool availability)"
      b_to_a:
        path: "orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-002-to-spike-001/handoff.md"
        status: "COMPLETE"
        key_content: "Worktree constraints and requirements (directory structure, env provisioning needs, state coordination requirements)"

  - id: "barrier-2"
    name: "Phase 2 Cross-Pollination"
    status: "COMPLETE"
    completed_at: "2026-02-20"
    depends_on:
      - "pipeline_a.phase.2"
      - "pipeline_b.phase.2"
    quality_gate:
      threshold: 0.92
      strategies: ["S-014", "S-010"]
    artifacts:
      a_to_b:
        path: "orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-001-to-spike-002/handoff.md"
        status: "COMPLETE"
        key_content: "Scored comparison matrix with weighted recommendation -- informs final lifecycle architecture choice"
      b_to_a:
        path: "orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-002-to-spike-001/handoff.md"
        status: "COMPLETE"
        key_content: "Session lifecycle feasibility assessment per approach (what works, what's brittle, what's impossible)"

# =============================================================================
# EXECUTION QUEUE
# =============================================================================
execution_queue:
  current_group: 5
  groups:
    - id: 1
      name: "Phase 1 Research Agents"
      execution_mode: "PARALLEL"
      status: "COMPLETE"
      agents:
        - "agent-a-001"
        - "agent-b-001"

    - id: 2
      name: "Barrier 1 Cross-Pollination"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      completed_at: "2026-02-20"
      blocked_by: "group-1"
      tasks:
        - "create-spike-001-to-spike-002-handoff"
        - "create-spike-002-to-spike-001-handoff"
        - "quality-gate-barrier-1"

    - id: 3
      name: "Phase 2 Analysis Agents"
      execution_mode: "PARALLEL"
      status: "COMPLETE"
      completed_at: "2026-02-20"
      blocked_by: "group-2"
      agents:
        - "agent-a-002"
        - "agent-b-002"

    - id: 4
      name: "Barrier 2 Cross-Pollination"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      completed_at: "2026-02-20"
      blocked_by: "group-3"
      tasks:
        - "create-spike-001-to-spike-002-handoff"
        - "create-spike-002-to-spike-001-handoff"
        - "quality-gate-barrier-2"

    - id: 5
      name: "Phase 3 Convergent Decision"
      execution_mode: "SEQUENTIAL"
      status: "COMPLETE"
      completed_at: "2026-02-20"
      blocked_by: "group-4"
      agents:
        - "agent-c-001"

# =============================================================================
# CHECKPOINTS
# =============================================================================
checkpoints:
  latest_id: "CP-005"
  entries:
    - id: "CP-001"
      timestamp: "2026-02-20"
      trigger: "PHASE_COMPLETE"
      description: "Phase 1 complete — both research agents delivered artifacts"
      recovery_point: "barrier-1-start"
    - id: "CP-002"
      timestamp: "2026-02-20"
      trigger: "BARRIER_COMPLETE"
      description: "Barrier 1 complete — cross-pollination handoffs created for both directions"
      recovery_point: "phase-2-start"
    - id: "CP-003"
      timestamp: "2026-02-20"
      trigger: "PHASE_COMPLETE"
      description: "Phase 2 complete — agent-a-002 trade-off scoring (Agent SDK wins 8.70) and agent-b-002 lifecycle design (9-state machine) delivered"
      recovery_point: "barrier-2-start"
    - id: "CP-004"
      timestamp: "2026-02-20"
      trigger: "BARRIER_COMPLETE"
      description: "Barrier 2 complete — scored recommendation and lifecycle feasibility handoffs created"
      recovery_point: "phase-3-start"
    - id: "CP-005"
      timestamp: "2026-02-20"
      trigger: "WORKFLOW_COMPLETE"
      description: "Workflow complete — ADR-PROJ006-001 delivered. GO decision: Agent SDK with CLI fallback. Status: PROPOSED."
      recovery_point: "workflow-complete"
  # Expected checkpoints:
  # - CP-001: Phase 1 complete (both pipelines)
  # - CP-002: Barrier 1 complete
  # - CP-003: Phase 2 complete (both pipelines)
  # - CP-004: Barrier 2 complete
  # - CP-005: Phase 3 (ADR) complete

# =============================================================================
# METRICS
# =============================================================================
metrics:
  execution:
    phases_complete: 5
    phases_total: 5    # 2 per pipeline (4) + 1 convergent
    phases_percent: 100
    barriers_complete: 2
    barriers_total: 2
    barriers_percent: 100
    agents_executed: 5
    agents_total: 5    # 2 research + 2 analysis + 1 architect
    agents_percent: 100
    artifacts_created: 9
    artifacts_total: 9  # 5 phase artifacts + 4 barrier handoffs
    artifacts_percent: 100

  quality:
    agent_success_rate: 0
    barrier_validation_pass_rate: 0
    checkpoint_recovery_tested: false
    current_scores: {}  # Populated during execution with S-014 scores

  timing:
    workflow_started: "2026-02-20"
    last_activity: "2026-02-20"
    estimated_completion: null

# =============================================================================
# BLOCKERS AND ISSUES
# =============================================================================
blockers:
  active: []

issues:
  resolved: []

# =============================================================================
# NEXT ACTIONS
# =============================================================================
next_actions:
  immediate:
    - action: "User reviews ADR-PROJ006-001 (PROPOSED status)"
      agents: []
      execution_mode: "MANUAL"
      description: "User accepts or requests revision of the go/no-go ADR. If accepted, workflow is finalized."

  subsequent:
    - action: "Begin FEAT-001 implementation based on ADR decision"
      depends_on: "ADR-PROJ006-001 accepted by user"

# =============================================================================
# RESUMPTION CONTEXT
# =============================================================================
resumption:
  last_checkpoint: "CP-005"
  current_state: "WORKFLOW COMPLETE. All 5 phases, 2 barriers, 5 agents, 9 artifacts delivered. ADR-PROJ006-001 status: PROPOSED."
  next_step: "User reviews ADR-PROJ006-001. If ACCEPTED, proceed to EPIC-001 FEAT-001 implementation."

  files_to_read:
    - "ORCHESTRATION_PLAN.md"           # Strategic context
    - "ORCHESTRATION_WORKTRACKER.md"    # Tactical documentation
    - "ORCHESTRATION.yaml"              # This file - machine-readable state

  cross_session_portable: true
  ephemeral_references: false
