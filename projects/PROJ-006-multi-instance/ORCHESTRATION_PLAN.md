# ORCHESTRATION_PLAN.md

> **Document ID:** PROJ-006-ORCH-PLAN
> **Project:** PROJ-006-multi-instance
> **Workflow ID:** `multi-instance-20260220-001`
> **Status:** ACTIVE
> **Version:** 2.0
> **Created:** 2026-02-20
> **Last Updated:** 2026-02-20

> **DISCLAIMER:** This document was generated by the orch-planner agent (v2.2.0). All paths, identifiers, and structural elements are auto-generated. Verify against project PLAN.md and WORKTRACKER.md before execution.

---

## Document Sections

| Section | Purpose |
|---------|---------|
| [Executive Summary](#1-executive-summary) | Workflow purpose, current state, identification |
| [Workflow Architecture](#2-workflow-architecture) | Pipeline diagram, pattern classification |
| [Phase Definitions](#3-phase-definitions) | Per-pipeline phase details |
| [Sync Barrier Protocol](#4-sync-barrier-protocol) | Barrier transition rules, definitions |
| [Agent Registry](#5-agent-registry) | All agents with inputs/outputs |
| [Quality Framework](#6-quality-framework) | Criticality, strategies, gate definitions |
| [State Management](#7-state-management) | State files, paths, checkpoints |
| [Execution Constraints](#8-execution-constraints) | Hard and soft constraints |
| [Success Criteria](#9-success-criteria) | Phase and workflow exit criteria |
| [Risk Mitigations](#10-risk-mitigations) | Identified risks and mitigations |
| [Resumption Context](#11-resumption-context) | Current state, next actions |

---

## 1. Executive Summary

This orchestration plan defines a **cross-pollinated research pipeline** (Pattern 5) with a **convergent synthesis** (Fan-In, Pattern 4) for PROJ-006's multi-instance strategy assessment. Two research spikes run in parallel -- SPIKE-001 (SDK vs CLI instance comparison) and SPIKE-002 (worktree and session lifecycle) -- with sync barriers enabling cross-pollination of findings, followed by a convergent decision phase producing a go/no-go ADR.

The workflow answers a single strategic question: **What is the best approach (SDK, CLI, or hybrid) for Jerry to programmatically manage multiple Claude instances with automated worktree lifecycle?**

**Current State:** Workflow not started. All phases PENDING.

**Orchestration Pattern:** Cross-Pollinated Pipeline (Pattern 5) + Convergent Synthesis (Pattern 4)

### 1.1 Workflow Identification

| Field | Value | Source |
|-------|-------|--------|
| Workflow ID | `multi-instance-20260220-001` | auto |
| ID Format | `{purpose}-{YYYYMMDD}-{NNN}` | semantic-date-seq |
| Base Path | `orchestration/multi-instance-20260220-001/` | Dynamic |

**Artifact Output Locations:**
- Pipeline A (SPIKE-001): `orchestration/multi-instance-20260220-001/spike-001/`
- Pipeline B (SPIKE-002): `orchestration/multi-instance-20260220-001/spike-002/`
- Cross-pollination: `orchestration/multi-instance-20260220-001/cross-pollination/`
- Convergent phase: `orchestration/multi-instance-20260220-001/convergent/`

---

## 2. Workflow Architecture

### 2.1 Pipeline Diagram

```
    PIPELINE A (SPIKE-001)                      PIPELINE B (SPIKE-002)
    SDK vs CLI Comparison                       Worktree & Session Lifecycle
    ==========================                  =============================

┌──────────────────────────┐                ┌──────────────────────────┐
│ PHASE 1: Research        │                │ PHASE 1: Research        │
│ ──────────────────────── │                │ ──────────────────────── │
│ agent-a-001              │                │ agent-b-001              │
│ (ps-researcher)          │                │ (ps-researcher)          │
│ SDK caps + CLI audit     │                │ Worktree API + lifecycle │
│ STATUS: PENDING          │                │ STATUS: PENDING          │
└────────────┬─────────────┘                └────────────┬─────────────┘
             │                                           │
             ▼                                           ▼
    ╔════════════════════════════════════════════════════════════════╗
    ║                       SYNC BARRIER 1                          ║
    ║  ┌──────────────────────────────────────────────────────────┐ ║
    ║  │ a-->b: Instance approach options + capabilities/limits   │ ║
    ║  │ b-->a: Worktree constraints + provisioning requirements  │ ║
    ║  └──────────────────────────────────────────────────────────┘ ║
    ║  QUALITY GATE: >= 0.92 weighted composite (S-014)            ║
    ║  STATUS: PENDING                                             ║
    ╚════════════════════════════════════════════════════════════════╝
             │                                           │
             ▼                                           ▼
┌──────────────────────────┐                ┌──────────────────────────┐
│ PHASE 2: Analysis        │                │ PHASE 2: Analysis        │
│ ──────────────────────── │                │ ──────────────────────── │
│ agent-a-002              │                │ agent-b-002              │
│ (ps-analyst)             │                │ (ps-analyst)             │
│ 8-dim trade-off scoring  │                │ Session lifecycle design │
│ INPUT: barrier-1 b-->a   │                │ INPUT: barrier-1 a-->b   │
│ STATUS: BLOCKED          │                │ STATUS: BLOCKED          │
└────────────┬─────────────┘                └────────────┬─────────────┘
             │                                           │
             ▼                                           ▼
    ╔════════════════════════════════════════════════════════════════╗
    ║                       SYNC BARRIER 2                          ║
    ║  ┌──────────────────────────────────────────────────────────┐ ║
    ║  │ a-->b: Scored comparison matrix + weighted recommendation│ ║
    ║  │ b-->a: Lifecycle feasibility per approach                │ ║
    ║  └──────────────────────────────────────────────────────────┘ ║
    ║  QUALITY GATE: >= 0.92 weighted composite (S-014)            ║
    ║  STATUS: PENDING                                             ║
    ╚════════════════════════════════════════════════════════════════╝
             │                                           │
             └─────────────────┬─────────────────────────┘
                               ▼
                ┌──────────────────────────┐
                │ PHASE 3: Decision        │
                │ ──────────────────────── │
                │ agent-c-001              │
                │ (ps-architect)           │
                │ Go/no-go ADR synthesis   │
                │ CRITICALITY: C3 (AE-003) │
                │ STATUS: BLOCKED          │
                └──────────────────────────┘
```

### 2.2 Orchestration Pattern Classification

| Pattern | Applied | Description |
|---------|---------|-------------|
| Sequential | Yes | Phases execute in order within each pipeline |
| Concurrent | Yes | Pipeline A and B run in parallel within each phase |
| Barrier Sync | Yes | Cross-pollination at barriers 1 and 2 |
| Hierarchical | Yes | Orchestrator delegates to agents (1 level, P-003) |
| Fan-In | Yes | Convergent Phase 3 synthesizes both pipelines |

### 2.3 Output Levels

| Level | Audience | Content |
|-------|----------|---------|
| L0 | Stakeholders | Go/no-go recommendation, ADR summary, risk assessment |
| L1 | Developers | Trade-off matrix, lifecycle architecture, integration patterns |
| L2 | Orchestrator | Raw research data, dimension scores, barrier handoff artifacts |

---

## 3. Phase Definitions

### 3.1 Pipeline A Phases (SPIKE-001: SDK vs CLI Instance Comparison)

| Phase | Name | Purpose | Agents | Status |
|-------|------|---------|--------|--------|
| 1 | Research | SDK capabilities audit (Context7 + Web Search for Claude SDK/Agent SDK APIs) + CLI automation audit (Claude Code CLI flags, subprocess patterns, --print mode) | agent-a-001 | PENDING |
| 2 | Analysis | Trade-off scoring on 8 dimensions (Programmatic Control 0.20, Tool Surface 0.20, Session Persistence 0.15, Error Handling 0.10, DX 0.10, Cost 0.10, Jerry Integration 0.10, Scalability 0.05). Informed by worktree constraints from SPIKE-002 via Barrier 1. | agent-a-002 | BLOCKED |

### 3.2 Pipeline B Phases (SPIKE-002: Worktree & Session Lifecycle)

| Phase | Name | Purpose | Agents | Status |
|-------|------|---------|--------|--------|
| 1 | Research | Current workflow audit (document manual worktree steps), git worktree API research (gitpython, subprocess), environment provisioning requirements (JERRY_PROJECT, uv sync, hooks) | agent-b-001 | PENDING |
| 2 | Analysis | Session lifecycle design for both approaches (SDK session binding vs CLI subprocess binding to worktrees), dispatch/monitoring patterns, merge coordination strategies. Informed by SDK/CLI capabilities from SPIKE-001 via Barrier 1. | agent-b-002 | BLOCKED |

### 3.3 Convergent Phase

| Phase | Name | Purpose | Agents | Status |
|-------|------|---------|--------|--------|
| 3 | Decision | Go/no-go ADR synthesis from both pipelines. ADR covers: recommended approach (SDK/CLI/hybrid), integration architecture, MVP scope, risk assessment. Auto-C3 per AE-003. | agent-c-001 | BLOCKED |

---

## 4. Sync Barrier Protocol

### 4.1 Barrier Transition Rules

```
1. PRE-BARRIER CHECK
   [ ] All phase agents have completed execution
   [ ] All phase artifacts exist and are valid
   [ ] No blocking errors or unresolved issues
   [ ] Quality gate: >= 0.92 weighted composite on phase artifacts (S-014)

2. CROSS-POLLINATION EXECUTION
   [ ] Extract key findings from source pipeline
   [ ] Transform into cross-pollination handoff artifact
   [ ] Validate artifact schema and content
   [ ] Self-review (S-010) applied to handoff artifact

3. POST-BARRIER VERIFICATION
   [ ] Target pipeline acknowledges receipt
   [ ] Inputs incorporated into next phase context
   [ ] Barrier status updated to COMPLETE
   [ ] Checkpoint created (CP-NNN)
```

### 4.2 Barrier Definitions

| Barrier | After Phase | Direction | Artifact | Key Content | Status |
|---------|-------------|-----------|----------|-------------|--------|
| barrier-1 | Phase 1 | a-->b | `orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-001-to-spike-002/handoff.md` | Instance approach options with capabilities/limitations per approach (SDK API surface, CLI flags, tool availability) | PENDING |
| barrier-1 | Phase 1 | b-->a | `orchestration/multi-instance-20260220-001/cross-pollination/barrier-1/spike-002-to-spike-001/handoff.md` | Worktree constraints and requirements (directory structure, env provisioning needs, state coordination requirements) | PENDING |
| barrier-2 | Phase 2 | a-->b | `orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-001-to-spike-002/handoff.md` | Scored comparison matrix with weighted recommendation -- informs final lifecycle architecture choice | PENDING |
| barrier-2 | Phase 2 | b-->a | `orchestration/multi-instance-20260220-001/cross-pollination/barrier-2/spike-002-to-spike-001/handoff.md` | Session lifecycle feasibility assessment per approach (what works, what's brittle, what's impossible) -- strengthens or weakens recommendation | PENDING |

### 4.3 Quality Gate at Barriers

Each barrier enforces:
- **Threshold:** >= 0.92 weighted composite score (S-014 LLM-as-Judge)
- **Minimum iterations:** 3 creator-critic-revision cycles (H-14)
- **Strategy ordering:** S-003 (Steelman) before S-002 (Devil's Advocate) per H-16
- **Self-review:** S-010 required before presenting to critic (H-15)
- **Constitutional check:** S-007 for governance compliance (H-18)

---

## 5. Agent Registry

### 5.1 Phase 1 Agents (Research)

| Agent ID | Pipeline | Role | Skill Source | Input Artifacts | Output Artifacts | Status |
|----------|----------|------|-------------|-----------------|------------------|--------|
| agent-a-001 | SPIKE-001 | ps-researcher | problem-solving | PLAN.md, SPIKE-001 entity | `orchestration/multi-instance-20260220-001/spike-001/phase-1-research/agent-a-001/agent-a-001-research.md` | PENDING |
| agent-b-001 | SPIKE-002 | ps-researcher | problem-solving | PLAN.md, SPIKE-002 entity | `orchestration/multi-instance-20260220-001/spike-002/phase-1-research/agent-b-001/agent-b-001-research.md` | PENDING |

### 5.2 Phase 2 Agents (Analysis)

| Agent ID | Pipeline | Role | Skill Source | Input Artifacts | Output Artifacts | Status |
|----------|----------|------|-------------|-----------------|------------------|--------|
| agent-a-002 | SPIKE-001 | ps-analyst | problem-solving | agent-a-001-research.md, barrier-1 b-->a handoff | `orchestration/multi-instance-20260220-001/spike-001/phase-2-analysis/agent-a-002/agent-a-002-analysis.md` | BLOCKED |
| agent-b-002 | SPIKE-002 | ps-analyst | problem-solving | agent-b-001-research.md, barrier-1 a-->b handoff | `orchestration/multi-instance-20260220-001/spike-002/phase-2-analysis/agent-b-002/agent-b-002-analysis.md` | BLOCKED |

### 5.3 Phase 3 Agent (Convergent Decision)

| Agent ID | Pipeline | Role | Skill Source | Input Artifacts | Output Artifacts | Status |
|----------|----------|------|-------------|-----------------|------------------|--------|
| agent-c-001 | Convergent | ps-architect | problem-solving | agent-a-002-analysis.md, agent-b-002-analysis.md, barrier-2 handoffs (both directions) | `orchestration/multi-instance-20260220-001/convergent/phase-3-decision/agent-c-001/agent-c-001-adr.md` | BLOCKED |

---

## 6. Quality Framework

### 6.1 Criticality Assessment

| Component | Criticality | Rationale | Auto-Escalation |
|-----------|-------------|-----------|-----------------|
| Workflow (overall) | C2 (Standard) | Reversible within 1 day; research spikes with no code changes; 3-10 files | -- |
| Phase 1 artifacts | C2 | Research deliverables, 3-10 files | -- |
| Phase 2 artifacts | C2 | Analysis deliverables, 3-10 files | -- |
| Phase 3 ADR | C3 (Significant) | New ADR triggers AE-003 (auto-C3 minimum) | AE-003 |
| Barrier handoffs | C2 | Cross-pollination artifacts | -- |

### 6.2 Required Adversarial Strategies by Phase

| Phase | Criticality | Required Strategies | Optional Strategies |
|-------|-------------|---------------------|---------------------|
| Phase 1 (Research) | C2 | S-007 (Constitutional AI), S-002 (Devil's Advocate), S-014 (LLM-as-Judge) | S-003 (Steelman), S-010 (Self-Refine) |
| Phase 2 (Analysis) | C2 | S-007, S-002, S-014 | S-003, S-010 |
| Barrier 1 | C2 | S-014 (scoring), S-010 (self-review) | S-003 |
| Barrier 2 | C2 | S-014 (scoring), S-010 (self-review) | S-003 |
| Phase 3 (ADR) | C3 | S-007, S-002, S-004 (Pre-Mortem), S-012 (FMEA), S-013 (Inversion), S-014 | S-001 (Red Team), S-003, S-010, S-011 (Chain-of-Verification) |

### 6.3 Quality Gate Definitions

**At Every Barrier and Phase Transition:**

| Dimension | Weight | Description |
|-----------|--------|-------------|
| Completeness | 0.20 | All required aspects covered |
| Internal Consistency | 0.20 | No contradictions within or across artifacts |
| Methodological Rigor | 0.20 | Sound research/analysis methodology |
| Evidence Quality | 0.15 | Claims backed by verifiable evidence |
| Actionability | 0.15 | Findings lead to clear next steps |
| Traceability | 0.10 | Traceable to project requirements and spikes |

**Score Bands:**

| Band | Score Range | Outcome |
|------|------------|---------|
| PASS | >= 0.92 | Accepted, proceed to next phase |
| REVISE | 0.85 - 0.91 | Rejected (H-13), targeted revision |
| REJECTED | < 0.85 | Rejected (H-13), significant rework |

---

## 7. State Management

### 7.1 State Files

| File | Purpose |
|------|---------|
| `ORCHESTRATION.yaml` | Machine-readable state (SSOT) |
| `ORCHESTRATION_WORKTRACKER.md` | Tactical execution documentation |
| `ORCHESTRATION_PLAN.md` | This file -- strategic context |

### 7.2 Artifact Path Structure (WI-SAO-021)

All artifacts are stored under the workflow's base path using dynamic identifiers:

```
orchestration/multi-instance-20260220-001/
├── spike-001/
│   ├── phase-1-research/
│   │   └── agent-a-001/
│   │       └── agent-a-001-research.md
│   └── phase-2-analysis/
│       └── agent-a-002/
│           └── agent-a-002-analysis.md
├── spike-002/
│   ├── phase-1-research/
│   │   └── agent-b-001/
│   │       └── agent-b-001-research.md
│   └── phase-2-analysis/
│       └── agent-b-002/
│           └── agent-b-002-analysis.md
├── convergent/
│   └── phase-3-decision/
│       └── agent-c-001/
│           └── agent-c-001-adr.md
└── cross-pollination/
    ├── barrier-1/
    │   ├── spike-001-to-spike-002/
    │   │   └── handoff.md
    │   └── spike-002-to-spike-001/
    │       └── handoff.md
    └── barrier-2/
        ├── spike-001-to-spike-002/
        │   └── handoff.md
        └── spike-002-to-spike-001/
            └── handoff.md
```

**Pipeline Alias Resolution:**
1. Workflow YAML override (highest priority): `spike-001`, `spike-002`
2. Skill registration default: `ps` (problem-solving)
3. Auto-derived from skill name (fallback)

### 7.3 Checkpoint Strategy

| Trigger | When | Purpose |
|---------|------|---------|
| PHASE_COMPLETE | After each phase completes | Phase-level rollback point |
| BARRIER_COMPLETE | After each sync barrier | Cross-pollination recovery |
| MANUAL | User-triggered | Debug and inspection |

---

## 8. Execution Constraints

### 8.1 Hard Constraints (Jerry Constitution)

| Constraint | ID | Enforcement |
|------------|----|----|
| Single agent nesting | P-003 | Orchestrator -> Worker only (max 1 level) |
| File persistence | P-002 | All state to filesystem |
| No deception | P-022 | Transparent reasoning |
| User authority | P-020 | User approves gates |
| UV only | H-05/H-06 | All Python via `uv run`, deps via `uv add` |
| Quality gate | H-13 | >= 0.92 for C2+ deliverables |
| Creator-critic cycle | H-14 | Minimum 3 iterations |
| Self-review | H-15 | Before presenting any deliverable |
| Steelman first | H-16 | S-003 before S-002 |
| Governance escalation | H-19 | Per AE rules |

### 8.1.1 Worktracker Entity Templates

> **WTI-007:** Entity files (EPIC, FEATURE, ENABLER, TASK, etc.) created during orchestration MUST use canonical templates from `.context/templates/worktracker/`. Read the appropriate template first, then populate. Do not create entity files from memory or by copying other instance files.

### 8.2 Soft Constraints

| Constraint | Value | Rationale |
|------------|-------|-----------|
| Max concurrent agents | 2 | One per pipeline in parallel phases |
| Max barrier retries | 2 | Circuit breaker to prevent infinite loops |
| Checkpoint frequency | PHASE | Recovery granularity at phase level |

---

## 9. Success Criteria

### 9.1 Phase 1 Exit Criteria (Research)

| Criterion | Validation |
|-----------|------------|
| SDK API surface documented | agent-a-001 artifact lists available SDK methods, tool support, session management APIs |
| CLI automation patterns documented | agent-a-001 artifact covers --print mode, subprocess patterns, flag inventory |
| Worktree manual workflow documented | agent-b-001 artifact has step-by-step current manual process |
| Git worktree API options catalogued | agent-b-001 artifact covers gitpython, subprocess, and alternative approaches |
| Environment provisioning requirements identified | agent-b-001 artifact lists JERRY_PROJECT, uv sync, hooks, and other env requirements |
| Quality gate passed | All Phase 1 artifacts score >= 0.92 via S-014 |

### 9.2 Phase 2 Exit Criteria (Analysis)

| Criterion | Validation |
|-----------|------------|
| 8-dimension trade-off matrix complete | agent-a-002 artifact has all 8 dimensions scored with evidence |
| Cross-pollinated constraints incorporated | agent-a-002 used barrier-1 worktree constraints; agent-b-002 used barrier-1 SDK/CLI capabilities |
| Session lifecycle design for both approaches | agent-b-002 covers SDK session binding AND CLI subprocess binding |
| Dispatch/monitoring patterns defined | agent-b-002 artifact includes dispatch and monitoring architecture |
| Quality gate passed | All Phase 2 artifacts score >= 0.92 via S-014 |

### 9.3 Phase 3 Exit Criteria (Decision)

| Criterion | Validation |
|-----------|------------|
| ADR created with go/no-go recommendation | agent-c-001 artifact follows ADR template |
| All three approaches evaluated | ADR covers SDK, CLI, and hybrid options |
| Risk assessment included | ADR has risk section with mitigations |
| MVP scope defined | ADR includes concrete MVP deliverables |
| C3 quality gate passed | ADR scores >= 0.92 with full C3 strategy set |
| Pre-mortem applied | S-004 pre-mortem analysis documented |

### 9.4 Workflow Completion Criteria

| Criterion | Validation |
|-----------|------------|
| All phases complete | All phase status = COMPLETE |
| All barriers synced | All barrier status = COMPLETE |
| Final ADR created | `orchestration/multi-instance-20260220-001/convergent/phase-3-decision/agent-c-001/agent-c-001-adr.md` exists |
| SPIKE-001 entity updated | Work tracker reflects completion |
| SPIKE-002 entity updated | Work tracker reflects completion |
| FEAT-001 updated with findings | Feature entity reflects spike outcomes |

---

## 10. Risk Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| SDK API insufficient for instance management | M | H | Phase 1 research audits actual API surface; CLI fallback available |
| CLI subprocess approach too brittle for production | M | M | Phase 2 lifecycle analysis evaluates robustness; hybrid approach as fallback |
| Worktree provisioning complexity underestimated | L | M | Phase 1 documents full manual workflow; identifies all provisioning steps |
| Cross-pollination artifacts lose critical nuance | L | M | Barrier quality gates enforce >= 0.92; handoff templates ensure structured transfer |
| Context exhaustion during research phases | M | H | Phase 1 agents use Context7 + Web Search rather than loading large codebases; checkpoint at phase boundaries |
| ADR decision inconclusive | L | H | Pre-mortem (S-004) applied in Phase 3; FMEA (S-012) identifies failure modes early |
| Token budget exceeded in single session | M | M | Checkpoint strategy enables cross-session resumption; ORCHESTRATION.yaml preserves state |

---

## 11. Resumption Context

### 11.1 Current Execution State

```
WORKFLOW STATUS AS OF 2026-02-20
================================

Pipeline A (SPIKE-001):
  Phase 1 (Research):   PENDING
  Phase 2 (Analysis):   BLOCKED (by barrier-1)

Pipeline B (SPIKE-002):
  Phase 1 (Research):   PENDING
  Phase 2 (Analysis):   BLOCKED (by barrier-1)

Convergent Phase:
  Phase 3 (Decision):   BLOCKED (by barrier-2)

Barriers:
  Barrier 1: PENDING
  Barrier 2: PENDING
```

### 11.2 Next Actions

1. Execute Phase 1 agents in parallel (agent-a-001 + agent-b-001)
2. agent-a-001: SDK capabilities audit via Context7 + Web Search, CLI automation audit
3. agent-b-001: Current manual workflow documentation, git worktree API research, env provisioning requirements
4. Upon Phase 1 completion, execute Barrier 1 cross-pollination
5. Quality gate check at Barrier 1 (>= 0.92)

---

*Document ID: PROJ-006-ORCH-PLAN*
*Workflow ID: multi-instance-20260220-001*
*Version: 2.0*
*Cross-Session Portable: All paths are repository-relative*
