# ORCHESTRATION.yaml - Machine-readable state for session recovery
# If Claude loses context, read this file to resume work
#
# Version: 2.0 - Added critic loop architecture
#
# Usage: On session start, if working on PROJ-006/FT-001:
#   1. Read this file
#   2. Check if any critic_loops have status: pending or in_progress
#   3. If critic pending, execute critic review before proceeding
#   4. Find first task with status: in_progress or pending
#   5. Resume from that task
#   6. Update this file after each task/critic completion

meta:
  project: PROJ-006-worktracker-ontology
  feature: FT-001
  feature_name: Domain Discovery
  schema_version: "2.1"  # Bumped for artifact_paths addition
  last_updated: "2026-01-14T09:20:00Z"
  last_commit: "d72f1c0"
  pr_url: null

# Artifact Paths Configuration (NEW in v2.1)
# All paths are relative to PROJECT ROOT (projects/PROJ-006-worktracker-ontology/)
# NOT relative to this file's location (work/SE-001/FT-001/)
#
# RULE: Pipeline artifacts (research, analysis, synthesis, reviews, discoveries, etc.)
#       go at PROJECT ROOT. Work tracking documents (enablers, work items, orchestration)
#       go in work/ hierarchy.
artifact_paths:
  # Pipeline artifacts at project root
  research: "research/"
  analysis: "analysis/"
  synthesis: "synthesis/"
  decisions: "decisions/"
  templates: "templates/"
  reviews: "reviews/"           # Critic review artifacts
  discoveries: "discoveries/"   # Discovery documents
  bugs: "bugs/"                 # Bug tracking documents
  reports: "reports/"
  runbooks: "runbooks/"

  # Work tracking documents in work/ hierarchy
  work_tracking: "work/"
  solution_epic: "work/SE-{id}/"
  feature: "work/SE-{se_id}/FT-{id}/"
  orchestration: "work/SE-{se_id}/FT-{ft_id}/ORCHESTRATION.yaml"

# Current overall status
status: IN_PROGRESS
completion: 95%
current_phase: "PHASE_7_RELEASE"
current_phase_name: "Phase 7 - PR to Main & CI Validation (EN-005)"
phase_6_completed: "2026-01-14T15:48:00Z"
phase_5_completed: "2026-01-14T10:30:00Z"  # WI-002 templates done
sync_barrier_5_passed: "2026-01-14T11:50:00Z"  # CL-005 approved
phase_1_completed: "2026-01-13T21:17:00Z"
phase_2_completed: "2026-01-13T22:30:00Z"
phase_3_completed: "2026-01-13T23:45:00Z"
sync_barrier_3_passed: "2026-01-14T02:00:00Z"  # Human approval received
phase_4_completed: "2026-01-14T04:30:00Z"  # WI-001 complete
sync_barrier_4_passed: "2026-01-14T09:15:00Z"  # CL-004 approved

# Critic Loop Configuration (NEW in v2.0)
critic_config:
  enabled: true
  default_max_iterations: 2
  escalation_policy: human_on_max_iterations
  timeout_minutes: 30
  criteria_types:
    lightweight:
      - consistency_check
      - completeness_check
    full:
      - completeness
      - accuracy
      - consistency
      - coverage
      - traceability

# Critic Loops (NEW in v2.0)
critic_loops:
  - id: CL-003
    name: "Synthesis Review"
    reviews: EN-004
    artifact_under_review: "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    validation_sources:
      - "analysis/ADO-SCRUM-MODEL.md"
      - "analysis/SAFE-MODEL.md"
      - "analysis/JIRA-MODEL.md"
    critic_type: full
    primary_agent: ps-reviewer
    secondary_agent: nse-reviews
    status: approved  # pending | in_progress | approved | revise | document_proceed
    iteration: 1
    max_iterations: 2
    review_artifact: "reviews/CL-003-synthesis-review.md"
    criteria:
      - id: completeness
        weight: high
        check: "All entities from source models mapped"
        status: pass
      - id: accuracy
        weight: critical
        check: "Mappings reflect source semantics"
        status: pass
      - id: consistency
        weight: high
        check: "No contradictions in canonical definitions"
        status: pass
      - id: coverage
        weight: medium
        check: "All properties, relationships, states addressed"
        status: partial
    findings:
      - id: ISS-001
        severity: low
        description: "ADO 5 state categories simplified to 3"
      - id: ISS-002
        severity: low
        description: "Sprint/Iteration entity not resolved"
      - id: ISS-003
        severity: low
        description: "SAFe Defect terminology cross-reference missing"
      - id: ISS-004
        severity: info
        description: "External relationships ADO-focused"
      - id: ISS-005
        severity: info
        description: "JSM types exclusion not explicitly stated"
    decision: approved
    decision_reason: "All criteria PASS or PARTIAL with no CRITICAL issues. Synthesis provides solid foundation for ontology design."
    human_approved: true
    human_approved_at: "2026-01-14T02:00:00Z"

  - id: CL-004
    name: "Ontology Review"
    reviews: WI-001
    artifact_under_review: "synthesis/ONTOLOGY-v1.md"
    validation_sources:
      - "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    critic_type: full
    primary_agent: ps-architect
    secondary_agent: nse-reviews
    status: approved
    blocked_by: []
    iteration: 1
    max_iterations: 2
    review_artifact: "reviews/CL-004-ontology-review.md"
    completed_at: "2026-01-14T09:15:00Z"
    criteria:
      - id: completeness
        weight: high
        check: "All canonical entities defined"
        status: pass
      - id: accuracy
        weight: critical
        check: "Entity schemas match synthesis"
        status: pass
      - id: consistency
        weight: high
        check: "State machine valid"
        status: pass
      - id: coverage
        weight: medium
        check: "All system mappings complete"
        status: pass
    findings:
      - id: ISS-001
        severity: info
        description: "Epic excludes IN_REVIEW state by design; organizations may customize"
      - id: ISS-002
        severity: info
        description: "realizes relationship is SAFe-specific; workarounds documented"
      - id: ISS-003
        severity: low
        description: "5 gaps documented (version, comments, attachments, audit, sprint) not yet modeled"
      - id: ISS-004
        severity: info
        description: "Document size (~5,700 lines) may affect maintainability"
    decision: approved
    decision_reason: "All 4 criteria PASS. Issues identified are informational or low severity. Ontology ready for template generation."
    human_approved: false  # Auto-approve since all criteria passed

  - id: CL-005
    name: "Templates Review"
    reviews: WI-002
    artifact_under_review: "templates/*.md"
    validation_sources:
      - "synthesis/ONTOLOGY-v1.md"
    critic_type: full
    primary_agent: ps-reviewer
    secondary_agent: null
    status: approved
    blocked_by: []
    iteration: 1
    max_iterations: 2
    started_at: "2026-01-14T10:45:00Z"
    completed_at: "2026-01-14T11:50:00Z"
    review_artifact: "reviews/CL-005-templates-review.md"
    criteria:
      - id: completeness
        weight: high
        check: "All template types created"
        status: pass
      - id: accuracy
        weight: high
        check: "Templates match ontology"
        status: pass
      - id: consistency
        weight: medium
        check: "Consistent format across templates"
        status: pass
    findings:
      - id: ISS-001
        severity: info
        description: "EPIC.md comment uses alternate field name (business_outcome_hypothesis vs business_outcome)"
      - id: ISS-002
        severity: info
        description: "ENABLER.md technical_debt_category field is practical extension not in ontology"
      - id: ISS-003
        severity: info
        description: "SPIKE.md timebox initialized as null with REQUIRED comment"
    decision: approved
    decision_reason: "All 3 criteria PASS. Zero critical/high/medium issues. 3 info-level observations only. Templates ready for Phase 6."
    human_approved: false  # Auto-approve since all criteria passed

# Enablers (technical prerequisites)
enablers:
  - id: EN-001
    name: ADO Scrum Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped  # retroactive - infrastructure added after execution
    research_output: "research/ADO-SCRUM-RAW.md"
    analysis_output: "analysis/ADO-SCRUM-MODEL.md"
    tasks:
      - id: 1
        name: "Research ADO Scrum work item types"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 1"
      - id: 2
        name: "Research ADO Scrum properties and fields"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 2"
      - id: 3
        name: "Research ADO Scrum states and transitions"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 3-4"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md section 5"

  - id: EN-002
    name: SAFe Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped
    research_output: "research/SAFE-RAW.md"
    analysis_output: "analysis/SAFE-MODEL.md"
    tasks:
      - id: 1
        name: "Research SAFe hierarchy levels"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 1"
      - id: 2
        name: "Research SAFe work item types"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 2"
      - id: 3
        name: "Research SAFe PI concepts"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 6"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md section 5"

  - id: EN-003
    name: JIRA Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped
    research_output: "research/JIRA-RAW.md"
    analysis_output: "analysis/JIRA-MODEL.md"
    tasks:
      - id: 1
        name: "Research JIRA issue types"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md section 1"
      - id: 2
        name: "Research JIRA fields and custom fields"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md sections 2-3"
      - id: 3
        name: "Research JIRA workflows"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md section 4"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md section 5"

  - id: EN-004
    name: Cross-Domain Synthesis
    status: COMPLETED
    tasks_done: 4
    tasks_total: 4
    phase: 3
    agent: ps-synthesizer
    blocked_by: [EN-001, EN-002, EN-003]
    critic: CL-003  # Pending critic review
    critic_status: pending
    synthesis_output: "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    completed_at: "2026-01-13T23:45:00Z"
    tasks:
      - id: 1
        name: "Create entity alignment matrix"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 2"
      - id: 2
        name: "Create property alignment matrix"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 3"
      - id: 3
        name: "Analyze relationship patterns"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 4"
      - id: 4
        name: "Compare state machines"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 5"

  - id: EN-005
    name: PR to Main & CI Pipeline Validation
    status: IN_PROGRESS
    tasks_done: 0
    tasks_total: 6
    phase: 7
    agent: claude-opus-4.5
    blocked_by: []
    enabler_type: INFRASTRUCTURE
    started_at: "2026-01-14T16:00:00Z"
    tasks:
      - id: 1
        name: "Stage PROJ-006 artifacts (exclude lock files)"
        status: pending
      - id: 2
        name: "Commit with proper message"
        status: pending
      - id: 3
        name: "Create PR against main"
        status: pending
      - id: 4
        name: "Monitor CI pipeline"
        status: pending
      - id: 5
        name: "Handle CI failures (if any)"
        status: pending
      - id: 6
        name: "Final validation & merge readiness"
        status: pending

# Work Items (deliverables)
work_items:
  - id: WI-001
    name: Parent Ontology Design
    status: COMPLETED
    tasks_done: 5
    tasks_total: 5
    phase: 4
    agent: nse-architecture, ps-architect
    blocked_by: []
    critic: CL-004
    critic_status: approved  # CL-004 passed all criteria
    started_at: "2026-01-14T02:00:00Z"
    completed_at: "2026-01-14T04:30:00Z"
    tasks:
      - id: 1
        name: "Design entity hierarchy"
        status: completed
        completed_at: "2026-01-14T02:30:00Z"
        agent: nse-architecture
        evidence: "synthesis/ONTOLOGY-v1.md Sections 1-2"
      - id: 2
        name: "Define entity schemas"
        status: completed
        completed_at: "2026-01-14T03:15:00Z"
        agent: nse-architecture
        evidence: "synthesis/ONTOLOGY-v1.md Section 3"
      - id: 3
        name: "Design relationship types"
        status: completed
        completed_at: "2026-01-14T04:00:00Z"
        agent: nse-architecture
        evidence: "synthesis/ONTOLOGY-v1.md Section 4"
      - id: 4
        name: "Design canonical state machine"
        status: completed
        completed_at: "2026-01-14T04:15:00Z"
        agent: nse-architecture
        evidence: "synthesis/ONTOLOGY-v1.md Section 5"
      - id: 5
        name: "Document system mappings"
        status: completed
        completed_at: "2026-01-14T04:30:00Z"
        agent: nse-architecture
        evidence: "synthesis/ONTOLOGY-v1.md Section 6"

  - id: WI-002
    name: Markdown Template Generation
    status: COMPLETED
    tasks_done: 7
    tasks_total: 7
    phase: 5
    agent: ps-synthesizer
    blocked_by: []
    critic: CL-005
    critic_status: pending
    started_at: "2026-01-14T09:25:00Z"
    completed_at: "2026-01-14T10:30:00Z"
    tasks:
      - id: 1
        name: "Generate EPIC.md template"
        status: completed
        completed_at: "2026-01-14T10:24:00Z"
        agent_batch: 1
        evidence: "templates/EPIC.md"
      - id: 2
        name: "Generate FEATURE.md template"
        status: completed
        completed_at: "2026-01-14T10:25:00Z"
        agent_batch: 1
        evidence: "templates/FEATURE.md"
      - id: 3
        name: "Generate STORY.md template"
        status: completed
        completed_at: "2026-01-14T10:27:00Z"
        agent_batch: 1
        evidence: "templates/STORY.md"
      - id: 4
        name: "Generate TASK.md template"
        status: completed
        completed_at: "2026-01-14T10:07:00Z"
        agent_batch: 2
        evidence: "templates/TASK.md"
      - id: 5
        name: "Generate BUG.md template"
        status: completed
        completed_at: "2026-01-14T10:13:00Z"
        agent_batch: 2
        evidence: "templates/BUG.md"
      - id: 6
        name: "Generate SPIKE.md template"
        status: completed
        completed_at: "2026-01-14T10:20:00Z"
        agent_batch: 2
        evidence: "templates/SPIKE.md"
      - id: 7
        name: "Generate ENABLER.md template"
        status: completed
        completed_at: "2026-01-14T10:27:00Z"
        agent_batch: 2
        evidence: "templates/ENABLER.md"

  - id: WI-003
    name: Design Review & Validation
    status: COMPLETED
    tasks_done: 4
    tasks_total: 4
    phase: 6
    agent: nse-reviews
    blocked_by: []
    critic: final_gate
    critic_status: approved
    started_at: "2026-01-14T11:55:00Z"
    completed_at: "2026-01-14T15:48:00Z"
    final_approval: "reports/WI-003-final-approval.md"
    tasks:
      - id: 1
        name: "Review ontology completeness"
        status: completed
        completed_at: "2026-01-14T15:40:00Z"
        evidence: "ONTOLOGY-v1.md verified (6056 lines, 11 entities)"
      - id: 2
        name: "Validate template accuracy"
        status: completed
        completed_at: "2026-01-14T15:42:00Z"
        evidence: "All 7 templates verified, CL-005 APPROVED"
      - id: 3
        name: "Check system mappings"
        status: completed
        completed_at: "2026-01-14T15:44:00Z"
        evidence: "ADO/SAFe/JIRA mappings complete in Section 6"
      - id: 4
        name: "Final approval"
        status: completed
        completed_at: "2026-01-14T15:48:00Z"
        evidence: "reports/WI-003-final-approval.md - APPROVED"

# Sync barriers (updated with critic gates)
sync_barriers:
  - id: SYNC-1
    name: "All research complete"
    requires: [EN-001-research, EN-002-research, EN-003-research]
    critic: null  # skipped retroactively
    status: completed
    completed_at: "2026-01-13T21:17:00Z"

  - id: SYNC-2
    name: "All analysis complete"
    requires: [EN-001, EN-002, EN-003]
    critic: null  # skipped retroactively
    status: completed
    ready_at: "2026-01-13T22:30:00Z"
    completed_at: "2026-01-13T23:00:00Z"
    artifacts:
      - "analysis/ADO-SCRUM-MODEL.md"
      - "analysis/SAFE-MODEL.md"
      - "analysis/JIRA-MODEL.md"

  - id: SYNC-3
    name: "Synthesis complete"
    requires: [EN-004]
    critic: CL-003
    critic_status: approved
    human_approval: received
    status: completed
    ready_at: "2026-01-13T23:45:00Z"
    critic_approved_at: "2026-01-14T01:00:00Z"
    human_approved_at: "2026-01-14T02:00:00Z"
    completed_at: "2026-01-14T02:00:00Z"
    artifacts:
      - "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
      - "reviews/CL-003-synthesis-review.md"

  - id: SYNC-4
    name: "Ontology approved"
    requires: [WI-001]
    critic: CL-004
    critic_status: approved
    human_approval: not_required  # All criteria passed, auto-proceed
    status: completed
    ready_at: "2026-01-14T04:30:00Z"
    critic_approved_at: "2026-01-14T09:15:00Z"
    completed_at: "2026-01-14T09:15:00Z"
    artifacts:
      - "synthesis/ONTOLOGY-v1.md"
      - "reviews/CL-004-ontology-review.md"

  - id: SYNC-5
    name: "Templates ready"
    requires: [WI-002]
    critic: CL-005
    critic_status: approved
    human_approval: not_required  # All criteria passed, auto-proceed
    status: completed
    ready_at: "2026-01-14T10:30:00Z"
    critic_approved_at: "2026-01-14T11:50:00Z"
    completed_at: "2026-01-14T11:50:00Z"
    artifacts:
      - "templates/*.md"
      - "reviews/CL-005-templates-review.md"

# Loop history (tracks revision iterations)
loop_history: []
  # Example entry:
  # - id: LB-001
  #   critic_loop: CL-003
  #   from_phase: SYNC-3
  #   to_enabler: EN-004
  #   iteration: 1
  #   reason: "Accuracy issues found"
  #   initiated_at: "2026-01-14T..."
  #   resolved_at: null
  #   resolution: null

# Recovery instructions (updated for v2.0)
recovery:
  if_session_lost: |
    1. Read this file: projects/PROJ-006-worktracker-ontology/work/SE-001/FT-001/ORCHESTRATION.yaml
    2. Check critic_loops section for any status: pending or in_progress
       - If CL-003 pending: Execute synthesis review before Phase 4
       - If CL-004 pending: Execute ontology review before Phase 5
       - If CL-005 pending: Execute templates review before Phase 6
    3. Check sync_barriers for current barrier status
    4. If critic approved/document_proceed AND human_approval: proceed to next phase
    5. Find first enabler/work_item with status: in_progress or pending
    6. Check blocked_by dependencies (including critic loops) are complete
    7. Resume that task
    8. After completion, update this file AND the corresponding *.md artifacts

  resume_command: |
    # To sync YAML state to TodoWrite:
    # 1. Parse this YAML
    # 2. Create META items for project context
    # 3. Create todo for current critic loop if pending
    # 4. Create todos for enabler/work_item tasks
    # 5. Respect blocked_by dependencies including critic loops
