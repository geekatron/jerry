# ORCHESTRATION.yaml - Machine-readable state for session recovery
# If Claude loses context, read this file to resume work
#
# Version: 2.0 - Added critic loop architecture
#
# Usage: On session start, if working on PROJ-006/FT-001:
#   1. Read this file
#   2. Check if any critic_loops have status: pending or in_progress
#   3. If critic pending, execute critic review before proceeding
#   4. Find first task with status: in_progress or pending
#   5. Resume from that task
#   6. Update this file after each task/critic completion

meta:
  project: PROJ-006-worktracker-ontology
  feature: FT-001
  feature_name: Domain Discovery
  schema_version: "2.0"
  last_updated: "2026-01-14T00:00:00Z"
  last_commit: "115a5ac"
  pr_url: null

# Current overall status
status: IN_PROGRESS
completion: 57%
current_phase: "SYNC_BARRIER_3"
current_phase_name: "Critic Review CL-003 Pending"
phase_1_completed: "2026-01-13T21:17:00Z"
phase_2_completed: "2026-01-13T22:30:00Z"
phase_3_completed: "2026-01-13T23:45:00Z"

# Critic Loop Configuration (NEW in v2.0)
critic_config:
  enabled: true
  default_max_iterations: 2
  escalation_policy: human_on_max_iterations
  timeout_minutes: 30
  criteria_types:
    lightweight:
      - consistency_check
      - completeness_check
    full:
      - completeness
      - accuracy
      - consistency
      - coverage
      - traceability

# Critic Loops (NEW in v2.0)
critic_loops:
  - id: CL-003
    name: "Synthesis Review"
    reviews: EN-004
    artifact_under_review: "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    validation_sources:
      - "analysis/ADO-SCRUM-MODEL.md"
      - "analysis/SAFE-MODEL.md"
      - "analysis/JIRA-MODEL.md"
    critic_type: full
    primary_agent: ps-reviewer
    secondary_agent: nse-reviews
    status: pending  # pending | in_progress | approved | revise | document_proceed
    iteration: 0
    max_iterations: 2
    review_artifact: "reviews/CL-003-synthesis-review.md"
    criteria:
      - id: completeness
        weight: high
        check: "All entities from source models mapped"
        status: pending
      - id: accuracy
        weight: critical
        check: "Mappings reflect source semantics"
        status: pending
      - id: consistency
        weight: high
        check: "No contradictions in canonical definitions"
        status: pending
      - id: coverage
        weight: medium
        check: "All properties, relationships, states addressed"
        status: pending
    findings: []
    decision: null
    decision_reason: null
    human_approved: false

  - id: CL-004
    name: "Ontology Review"
    reviews: WI-001
    artifact_under_review: "synthesis/ONTOLOGY-v1.md"
    validation_sources:
      - "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    critic_type: full
    primary_agent: ps-architect
    secondary_agent: nse-reviews
    status: blocked
    blocked_by: [CL-003, WI-001]
    iteration: 0
    max_iterations: 2
    review_artifact: "reviews/CL-004-ontology-review.md"
    criteria:
      - id: completeness
        weight: high
        check: "All canonical entities defined"
        status: pending
      - id: accuracy
        weight: critical
        check: "Entity schemas match synthesis"
        status: pending
      - id: consistency
        weight: high
        check: "State machine valid"
        status: pending
      - id: coverage
        weight: medium
        check: "All system mappings complete"
        status: pending
    findings: []
    decision: null
    decision_reason: null
    human_approved: false

  - id: CL-005
    name: "Templates Review"
    reviews: WI-002
    artifact_under_review: "templates/*.md"
    validation_sources:
      - "synthesis/ONTOLOGY-v1.md"
    critic_type: full
    primary_agent: ps-reviewer
    secondary_agent: null
    status: blocked
    blocked_by: [CL-004, WI-002]
    iteration: 0
    max_iterations: 2
    review_artifact: "reviews/CL-005-templates-review.md"
    criteria:
      - id: completeness
        weight: high
        check: "All template types created"
        status: pending
      - id: accuracy
        weight: high
        check: "Templates match ontology"
        status: pending
      - id: consistency
        weight: medium
        check: "Consistent format across templates"
        status: pending
    findings: []
    decision: null
    decision_reason: null
    human_approved: false

# Enablers (technical prerequisites)
enablers:
  - id: EN-001
    name: ADO Scrum Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped  # retroactive - infrastructure added after execution
    research_output: "research/ADO-SCRUM-RAW.md"
    analysis_output: "analysis/ADO-SCRUM-MODEL.md"
    tasks:
      - id: 1
        name: "Research ADO Scrum work item types"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 1"
      - id: 2
        name: "Research ADO Scrum properties and fields"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 2"
      - id: 3
        name: "Research ADO Scrum states and transitions"
        status: completed
        phase: research
        evidence: "research/ADO-SCRUM-RAW.md section 3-4"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/ADO-SCRUM-MODEL.md section 5"

  - id: EN-002
    name: SAFe Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped
    research_output: "research/SAFE-RAW.md"
    analysis_output: "analysis/SAFE-MODEL.md"
    tasks:
      - id: 1
        name: "Research SAFe hierarchy levels"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 1"
      - id: 2
        name: "Research SAFe work item types"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 2"
      - id: 3
        name: "Research SAFe PI concepts"
        status: completed
        phase: research
        evidence: "research/SAFE-RAW.md section 6"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/SAFE-MODEL.md section 5"

  - id: EN-003
    name: JIRA Domain Analysis
    status: COMPLETED
    tasks_done: 6
    tasks_total: 6
    phase: 2
    agent: ps-researcher, ps-analyst
    blocked_by: []
    critic: skipped
    research_output: "research/JIRA-RAW.md"
    analysis_output: "analysis/JIRA-MODEL.md"
    tasks:
      - id: 1
        name: "Research JIRA issue types"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md section 1"
      - id: 2
        name: "Research JIRA fields and custom fields"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md sections 2-3"
      - id: 3
        name: "Research JIRA workflows"
        status: completed
        phase: research
        evidence: "research/JIRA-RAW.md section 4"
      - id: 4
        name: "Extract entity catalog"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md section 2"
      - id: 5
        name: "Extract relationships and behaviors"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md sections 3-4"
      - id: 6
        name: "Document state machine"
        status: completed
        phase: analysis
        evidence: "analysis/JIRA-MODEL.md section 5"

  - id: EN-004
    name: Cross-Domain Synthesis
    status: COMPLETED
    tasks_done: 4
    tasks_total: 4
    phase: 3
    agent: ps-synthesizer
    blocked_by: [EN-001, EN-002, EN-003]
    critic: CL-003  # Pending critic review
    critic_status: pending
    synthesis_output: "synthesis/CROSS-DOMAIN-SYNTHESIS.md"
    completed_at: "2026-01-13T23:45:00Z"
    tasks:
      - id: 1
        name: "Create entity alignment matrix"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 2"
      - id: 2
        name: "Create property alignment matrix"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 3"
      - id: 3
        name: "Analyze relationship patterns"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 4"
      - id: 4
        name: "Compare state machines"
        status: completed
        evidence: "synthesis/CROSS-DOMAIN-SYNTHESIS.md Section 5"

# Work Items (deliverables)
work_items:
  - id: WI-001
    name: Parent Ontology Design
    status: BLOCKED
    tasks_done: 0
    tasks_total: 5
    phase: 4
    agent: nse-architecture, ps-architect
    blocked_by: [EN-004, CL-003]  # Now also blocked by critic
    critic: CL-004
    critic_status: blocked
    tasks:
      - id: 1
        name: "Design entity hierarchy"
        status: pending
      - id: 2
        name: "Define entity schemas"
        status: pending
      - id: 3
        name: "Design relationship types"
        status: pending
      - id: 4
        name: "Design canonical state machine"
        status: pending
      - id: 5
        name: "Document system mappings"
        status: pending

  - id: WI-002
    name: Markdown Template Generation
    status: BLOCKED
    tasks_done: 0
    tasks_total: 7
    phase: 5
    agent: ps-synthesizer
    blocked_by: [WI-001, CL-004]
    critic: CL-005
    critic_status: blocked
    tasks:
      - id: 1
        name: "Generate EPIC.md template"
        status: pending
      - id: 2
        name: "Generate FEATURE.md template"
        status: pending
      - id: 3
        name: "Generate STORY.md template"
        status: pending
      - id: 4
        name: "Generate TASK.md template"
        status: pending
      - id: 5
        name: "Generate BUG.md template"
        status: pending
      - id: 6
        name: "Generate SPIKE.md template"
        status: pending
      - id: 7
        name: "Generate ENABLER.md template"
        status: pending

  - id: WI-003
    name: Design Review & Validation
    status: BLOCKED
    tasks_done: 0
    tasks_total: 4
    phase: 6
    agent: nse-reviews
    blocked_by: [WI-002, CL-005]
    critic: final_gate  # WI-003 is itself the final critic
    critic_status: blocked
    tasks:
      - id: 1
        name: "Review ontology completeness"
        status: pending
      - id: 2
        name: "Validate template accuracy"
        status: pending
      - id: 3
        name: "Check system mappings"
        status: pending
      - id: 4
        name: "Final approval"
        status: pending

# Sync barriers (updated with critic gates)
sync_barriers:
  - id: SYNC-1
    name: "All research complete"
    requires: [EN-001-research, EN-002-research, EN-003-research]
    critic: null  # skipped retroactively
    status: completed
    completed_at: "2026-01-13T21:17:00Z"

  - id: SYNC-2
    name: "All analysis complete"
    requires: [EN-001, EN-002, EN-003]
    critic: null  # skipped retroactively
    status: completed
    ready_at: "2026-01-13T22:30:00Z"
    completed_at: "2026-01-13T23:00:00Z"
    artifacts:
      - "analysis/ADO-SCRUM-MODEL.md"
      - "analysis/SAFE-MODEL.md"
      - "analysis/JIRA-MODEL.md"

  - id: SYNC-3
    name: "Synthesis complete"
    requires: [EN-004]
    critic: CL-003
    critic_status: pending
    human_approval: pending
    status: awaiting_critic
    ready_at: "2026-01-13T23:45:00Z"
    artifacts:
      - "synthesis/CROSS-DOMAIN-SYNTHESIS.md"

  - id: SYNC-4
    name: "Ontology approved"
    requires: [WI-001]
    critic: CL-004
    critic_status: blocked
    human_approval: pending
    status: blocked
    artifacts:
      - "synthesis/ONTOLOGY-v1.md"
      - "decisions/ADR-001-ontology-design.md"

  - id: SYNC-5
    name: "Templates ready"
    requires: [WI-002]
    critic: CL-005
    critic_status: blocked
    human_approval: pending
    status: blocked
    artifacts:
      - "templates/*.md"

# Loop history (tracks revision iterations)
loop_history: []
  # Example entry:
  # - id: LB-001
  #   critic_loop: CL-003
  #   from_phase: SYNC-3
  #   to_enabler: EN-004
  #   iteration: 1
  #   reason: "Accuracy issues found"
  #   initiated_at: "2026-01-14T..."
  #   resolved_at: null
  #   resolution: null

# Recovery instructions (updated for v2.0)
recovery:
  if_session_lost: |
    1. Read this file: projects/PROJ-006-worktracker-ontology/work/SE-001/FT-001/ORCHESTRATION.yaml
    2. Check critic_loops section for any status: pending or in_progress
       - If CL-003 pending: Execute synthesis review before Phase 4
       - If CL-004 pending: Execute ontology review before Phase 5
       - If CL-005 pending: Execute templates review before Phase 6
    3. Check sync_barriers for current barrier status
    4. If critic approved/document_proceed AND human_approval: proceed to next phase
    5. Find first enabler/work_item with status: in_progress or pending
    6. Check blocked_by dependencies (including critic loops) are complete
    7. Resume that task
    8. After completion, update this file AND the corresponding *.md artifacts

  resume_command: |
    # To sync YAML state to TodoWrite:
    # 1. Parse this YAML
    # 2. Create META items for project context
    # 3. Create todo for current critic loop if pending
    # 4. Create todos for enabler/work_item tasks
    # 5. Respect blocked_by dependencies including critic loops
