# BUG-001: Orchestration scaffold creates cartesian product of empty directories

> **Type:** bug
> **Status:** pending
> **Priority:** medium
> **Impact:** low
> **Severity:** minor
> **Created:** 2026-02-21T23:45:00Z
> **Due:** —
> **Completed:** —
> **Parent:** PROJ-007-agent-patterns
> **Owner:** —
> **Found In:** orchestration skill v1.0.0
> **Fix Version:** —

---

## Document Sections

| Section | Purpose |
|---------|---------|
| [Summary](#summary) | Brief description and key details |
| [Reproduction Steps](#reproduction-steps) | Steps to reproduce the issue |
| [Environment](#environment) | Environment where bug occurs |
| [Evidence](#evidence) | Bug documentation |
| [Root Cause Analysis](#root-cause-analysis) | Investigation and root cause details |
| [Acceptance Criteria](#acceptance-criteria) | Conditions for bug to be fixed |
| [Related Items](#related-items) | Hierarchy and related work items |
| [History](#history) | Status changes and key events |

---

## Summary

The `/orchestration` skill's `orch-planner` agent scaffolds output directories using bash brace expansion that creates a cartesian product of `{pipeline} x {phase} x {all agents}`, resulting in 230 directories when only ~20 are needed. Agents then write to differently-named directories (e.g., `phase-2-analysis` vs `phase-2`), leaving the scaffolded directories permanently empty.

**Key Details:**
- **Symptom:** 226 empty directories in orchestration output tree after workflow completion
- **Frequency:** Every orchestration run that uses the scaffold pattern
- **Workaround:** Manual cleanup via `find ... -type d -empty -delete` after run completes

---

## Reproduction Steps

### Prerequisites

- Jerry Framework with `/orchestration` skill active
- A multi-phase, cross-pollinated orchestration plan (e.g., PROJ-007 agent-patterns-20260221-001)

### Steps to Reproduce

1. Invoke `/orchestration` with a plan containing 2 pipelines (PS + NSE), 5 phases, and 23+ agents
2. The `orch-planner` agent generates a scaffold command using bash brace expansion: `mkdir -p orchestration/{run-id}/{ps,nse}/{phase-1,phase-2,...,phase-5}/{agent-1,agent-2,...,agent-23}/`
3. Observe that the brace expansion creates the cartesian product: every agent directory under every phase under every pipeline
4. Background agents execute and write output to correctly-named directories (e.g., `ps/phase-1-research/ps-researcher-001/`)
5. After workflow completes, observe 226 empty directories remain

### Expected Result

Scaffold should create only the directories that agents will actually write to — approximately 23 directories matching the `{pipeline}/{phase-N-name}/{agent-id}/` pattern.

### Actual Result

Scaffold creates 230 directories (cartesian product). Agents write to ~23 directories with different naming. 226 directories remain permanently empty.

---

## Environment

| Attribute | Value |
|-----------|-------|
| **Operating System** | macOS Darwin 24.6.0 |
| **Browser/Runtime** | Claude Code (Claude Opus 4.6) |
| **Application Version** | Jerry Framework v0.8.0 |
| **Configuration** | `/orchestration` skill v1.0.0, `orch-planner` agent |
| **Deployment** | Local development (git worktree) |

### Additional Environment Details

- Discovered during PROJ-007-agent-patterns orchestration run `agent-patterns-20260221-001`
- The originating `mkdir -p` command was executed in session `87eaedd0`
- The `orch-planner` agent itself noted the over-scaffolding: "I can see that the scaffolded directory structure has a flat layout -- all agent directories exist under every phase in both ps and nse pipelines, which is overkill"

---

## Evidence

### Bug Documentation

| Evidence | Type | Description | Date |
|----------|------|-------------|------|
| RCA investigation transcript | Analysis | Full root cause analysis tracing mkdir command to session `87eaedd0` | 2026-02-21 |
| `find ... -type d -empty \| wc -l` = 226 | Command output | Counted 226 empty directories in orchestration tree | 2026-02-21 |
| `find ... -type f \| wc -l` = 39 | Command output | Confirmed all 39 artifacts present — no work lost | 2026-02-21 |
| orch-planner agent self-acknowledgment | Log | Agent noted "flat layout ... is overkill" but did not self-correct | 2026-02-21 |

### Fix Verification

| Verification | Method | Result | Verified By | Date |
|--------------|--------|--------|-------------|------|
| Bug no longer reproducible | Manual test | — | — | — |
| Regression test added | Automated test | — | — | — |
| Related areas tested | — | — | — | — |

### Verification Checklist

- [ ] Bug no longer reproducible with original steps
- [ ] Regression test added and passing
- [ ] No new issues introduced
- [ ] Code review approved

---

## Root Cause Analysis

### Investigation Summary

RCA performed by tracing directory creation back through 3 session transcripts. The originating command was found in session `87eaedd0` where the `orch-planner` agent executed a `mkdir -p` with nested bash brace expansion.

### Root Cause

The `orch-planner` agent uses bash brace expansion to scaffold the orchestration output directory tree. The expansion `{ps,nse}/{phase-1,...,phase-5}/{agent-1,...,agent-23}/` creates a **cartesian product** of all combinations (2 x 5 x 23 = 230 directories), rather than only the specific `{pipeline}/{phase}/{agent}` triples that agents will actually use.

### Contributing Factors

- **Naming mismatch:** Scaffold uses `phase-N` naming (e.g., `phase-2`) while agents write to `phase-N-name` directories (e.g., `phase-2-analysis`), so scaffolded directories are never used even when the correct agent is in the correct pipeline
- **No self-correction:** The `orch-planner` agent detected the over-scaffolding ("flat layout ... is overkill") but did not correct the directory structure
- **No cleanup step:** The orchestration workflow has no post-execution cleanup phase to remove unused scaffold directories
- **Git invisibility:** Git does not track empty directories, so the issue was invisible in version control and only apparent on the local filesystem

---

## Acceptance Criteria

### Fix Verification

- [ ] Scaffold creates only directories matching actual `{pipeline}/{phase-name}/{agent-id}/` triples from the orchestration plan
- [ ] No cartesian product expansion — each directory corresponds to exactly one planned agent execution
- [ ] Naming convention is consistent between scaffold and agent output paths (`phase-N-name` format)
- [ ] Bug no longer reproducible with original steps

### Quality Checklist

- [ ] Regression tests added
- [ ] Existing tests still passing
- [ ] No new issues introduced
- [ ] Documentation updated (if applicable)

---

## Related Items

### Hierarchy

- **Parent:** [PROJ-007-agent-patterns](../../WORKTRACKER.md) (discovery context)

### Related Items

- **Discovery Context:** PROJ-007 orchestration run `agent-patterns-20260221-001`
- **Affected Component:** `/orchestration` skill, `orch-planner` agent (`skills/orchestration/agents/orch-planner.md`)
- **RCA Session:** Session `87eaedd0` (originating `mkdir -p` command)
- **Cleanup Commit:** `3c386de` (PROJ-007 commit — empty dirs were not committed, cleaned locally)
- **GitHub Issue:** [geekatron/jerry#53](https://github.com/geekatron/jerry/issues/53)

---

## History

| Date | Author | Status | Notes |
|------|--------|--------|-------|
| 2026-02-21 | Claude (PROJ-007 orchestrator) | pending | Initial report from RCA during PROJ-007 completion |

---

## System Mapping

| System | Mapping |
|--------|---------|
| **Azure DevOps** | Bug |
| **SAFe** | Defect |
| **JIRA** | Bug |
