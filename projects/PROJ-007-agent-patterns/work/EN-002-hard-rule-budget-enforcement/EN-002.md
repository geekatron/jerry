# EN-002: Implement HARD Rule Budget Enforcement Improvements

> **Type:** enabler
> **Status:** done
> **Priority:** high
> **Impact:** high
> **Enabler Type:** architecture
> **Created:** 2026-02-21T23:50:00Z
> **Due:** —
> **Completed:** 2026-02-21
> **Parent:** PROJ-007-agent-patterns
> **Owner:** —
> **Effort:** 8

---

## Document Sections

| Section | Purpose |
|---------|---------|
| [Summary](#summary) | What this enabler delivers |
| [Problem Statement](#problem-statement) | Why this enabler is needed |
| [Business Value](#business-value) | How it supports framework quality |
| [Technical Approach](#technical-approach) | Implementation strategy |
| [Children (Tasks)](#children-tasks) | Task inventory |
| [Progress Summary](#progress-summary) | Overall progress |
| [Acceptance Criteria](#acceptance-criteria) | Definition of done |
| [Risks and Mitigations](#risks-and-mitigations) | Known risks |
| [Dependencies](#dependencies) | What this blocks and depends on |
| [Related Items](#related-items) | Discoveries, decisions, derivation |
| [History](#history) | Status changes |

---

## Summary

The C4 adversary tournament on the HARD rule budget upper boundary derivation (scored 0.95 PASS, 2 iterations) revealed that the current HARD rule ceiling of 35 has no principled derivation and the L2 prompt reinforcement engine only covers 10/31 H-rules. This enabler implements the recommended improvements: expand L2 engine coverage, consolidate rules to fit within the derived 25-rule ceiling, update governance documentation, add L5 CI enforcement, and measure effectiveness.

**Technical Scope:**
- Expand L2 prompt reinforcement engine to read all auto-loaded rule files
- Consolidate H-25..H-30 (6→2) and H-07..H-09 (3→1) to reduce HARD rule count from 31 to 25
- Update quality-enforcement.md ceiling from 35 to 25 with two-tier model + exception mechanism
- Add L5 CI enforcement gate to prevent silent ceiling breaches
- Measure enforcement effectiveness after changes

---

## Problem Statement

Two critical gaps threaten the framework's enforcement quality:

1. **Unprincipled ceiling (DISC-001):** The 35-slot HARD rule ceiling was set retroactively without derivation. The principled upper boundary derived from three independent constraint families is 25 rules.

2. **L2 engine coverage gap (DISC-002):** The prompt reinforcement engine reads only `quality-enforcement.md`, providing per-prompt L2 protection for 10 of 31 H-rules (32%). The remaining 21 rules are vulnerable to context rot — the core problem Jerry exists to solve.

Without this enabler, adding H-32..H-35 from PROJ-007 would push the rule count to 35/35 (100% utilization of an unprincipled ceiling), degrading enforcement quality for ALL rules.

---

## Business Value

This enabler directly improves the core value proposition of the Jerry Framework — resistance to context rot.

### Features Unlocked

- **EN-001:TASK-016** — H-32..H-35 can be safely added once consolidation creates headroom
- **Future HARD rules** — Principled ceiling with exception mechanism provides a sustainable governance path
- **Enforcement quality** — L2 engine expansion nearly triples per-prompt rule protection

---

## Technical Approach

### Phase 1: Engine Fix (TASK-022)
Expand `prompt_reinforcement_engine.py` to glob all auto-loaded rule files instead of hardcoding `quality-enforcement.md`. Update L2 budget documentation.

### Phase 2: Consolidation (TASK-023, TASK-024)
Consolidate H-25..H-30 into 2 compound rules and H-07..H-09 into 1 compound rule. Verify no L3 AST enforcement dependencies.

### Phase 3: Governance Update (TASK-025, TASK-026)
Classify all rules into Tier A/B. Update quality-enforcement.md with derived 25-rule ceiling, two-tier model, and exception mechanism.

### Phase 4: Enforcement + Measurement (TASK-027, TASK-028)
Add L5 CI gate for ceiling enforcement. Measure pre/post enforcement effectiveness.

### Architecture Diagram

```
BEFORE:                              AFTER:
L2 engine reads 1 file               L2 engine reads 9 files
  quality-enforcement.md                *.md in .claude/rules/
  8 markers, 10 H-rules                16 markers, 21 H-rules (Tier A)
  415 tokens                            559 tokens (65.8% of 850 budget)

31 HARD rules, ceiling 35            25 HARD rules, ceiling 25
  21 rules without engine L2            4 rules without engine L2
  No L5 ceiling enforcement             L5 CI gate enforces ceiling
```

---

## Children (Tasks)

### Task Inventory

| ID | Title | Status | Criticality | Phase |
|----|-------|--------|-------------|-------|
| TASK-022 | Expand L2 engine to read all auto-loaded rule files | DONE | C3 | 1 |
| TASK-023 | Consolidate H-25..H-30 into 2 compound rules | DONE | C3 | 2 |
| TASK-024 | Consolidate H-07..H-09 into 1 compound rule | DONE | C3 | 2 |
| TASK-025 | Classify rules into Tier A/B + add missing L2 markers | DONE | C3 | 3 |
| TASK-026 | Update ceiling 35→25, add two-tier model + exception mechanism | DONE | C3 | 3 |
| TASK-027 | Add L5 CI enforcement gate for HARD rule ceiling | DONE | C3 | 4 |
| TASK-028 | Measure enforcement effectiveness | DONE | C2 | 4 |
| TASK-029 | Empirical behavioral measurement of enforcement effectiveness | PENDING | C2 | Follow-up |

### Discoveries

| ID | Title | Status |
|----|-------|--------|
| DISC-001 | HARD Rule Budget Ceiling Has No Principled Derivation | VALIDATED |
| DISC-002 | L2 Prompt Reinforcement Engine Coverage Gap | VALIDATED |

### Decisions

| ID | Title | Status |
|----|-------|--------|
| DEC-001 | HARD Rule Budget Implementation Plan (5 decisions) | ACCEPTED |

---

## Progress Summary

### Status Overview

```
+------------------------------------------------------------------+
|                   ENABLER PROGRESS TRACKER                        |
+------------------------------------------------------------------+
| Tasks:     [####################] 100% (7/7 completed)           |
| Knowledge: [####################] 100% (2 DISC + 1 DEC)          |
+------------------------------------------------------------------+
| Overall:   [####################] 100%                            |
+------------------------------------------------------------------+
```

### Progress Metrics

| Metric | Value |
|--------|-------|
| **Total Tasks** | 7 |
| **Completed Tasks** | 7 |
| **Discoveries** | 2 (VALIDATED) |
| **Decisions** | 1 (ACCEPTED, 5 decisions) |
| **Completion %** | 100% |

---

## Acceptance Criteria

### Definition of Done

- [x] L2 engine reads all auto-loaded rule files (not just quality-enforcement.md)
- [x] H-25..H-30 consolidated into 2 compound rules
- [x] H-07..H-09 consolidated into 1 compound rule
- [x] HARD rule count <= 25 (post-consolidation: 25)
- [x] quality-enforcement.md updated with 25-rule ceiling, two-tier table, exception mechanism
- [x] All rules classified as Tier A or Tier B
- [x] L5 CI gate enforces HARD rule ceiling (pre-commit + GitHub Actions CI)
- [x] All pre-commit hooks pass
- [x] All tests pass (pytest: 3377 pass, 66 skipped)
- [x] Enforcement effectiveness measured (pre/post comparison)

### Technical Criteria

| # | Criterion | Verified |
|---|-----------|----------|
| TC-1 | Engine reads L2-REINJECT markers from all 9 auto-loaded files | [x] |
| TC-2 | Post-consolidation HARD rule count = 25 | [x] |
| TC-3 | No L3 AST enforcement broken by consolidation | [x] |
| TC-4 | L5 CI gate fails build when H-rule count > ceiling | [x] |
| TC-5 | L2 budget in documentation updated to 850 tokens | [x] |

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Consolidation changes behavior of compound rules | Low | Medium | Verify no L3 AST deps before consolidating; test enforcement post-consolidation |
| L2 budget increase (415→840) adds per-prompt latency | Low | Low | 425 additional tokens is <0.25% of context window |
| Existing tests break on rule renaming | Medium | Low | Update test fixtures alongside consolidation |
| Ceiling of 25 proves too restrictive | Low | Medium | Exception mechanism provides controlled escape valve |
| No automated Two-Tier Model coverage verification | Low | Low | Tier A/B classification is manually maintained; CI gate enforces ceiling, not tier membership. Accepted risk — tier classification changes require .context/rules/ modification (AE-002 auto-C3). |
| Behavioral enforcement effectiveness unmeasured | Medium | Medium | EN-002 provides structural evidence (L2 coverage, token budgets, L5 gates). Behavioral measurement deferred to TASK-029 / DEC-005. Structural-proxy argument documented in implementation summary. |

---

## Dependencies

### Depends On

- DISC-001 (VALIDATED) — Ceiling has no derivation
- DISC-002 (VALIDATED) — L2 engine coverage gap
- DEC-001 (ACCEPTED) — Implementation plan decisions
- C4 derivation (0.95 PASS) — Principled upper boundary

### Enables

- [EN-001:TASK-016](../EN-001-install-agent-pattern-deliverables/TASK-016-integrate-hard-rules/TASK-016.md) — H-32..H-35 integration (blocked until EN-002 completes)

---

## Related Items

### Hierarchy

- **Parent:** PROJ-007-agent-patterns

### Related Items

- **EN-001:** Install PROJ-007 Agent Pattern Deliverables (TASK-016 blocked by this enabler)
- **C4 Derivation:** `orchestration/.../adversary/hard-rule-budget/hard-rule-budget-upper-boundary-derivation-r2.md`
- **Tournament Report:** `orchestration/.../adversary/hard-rule-budget/c4-tournament-execution-report.md`
- **Tournament Score R2:** `orchestration/.../adversary/hard-rule-budget/c4-tournament-score-r2.md`

---

## History

| Date | Author | Status | Notes |
|------|--------|--------|-------|
| 2026-02-21 | Claude (PROJ-007 orchestrator) | pending | Enabler created from C4 derivation findings + DEC-001 decisions |
| 2026-02-21 | Claude (C4 tournament R4) | done | R4 revisions: TASK-029 created for behavioral measurement, deprecated `tokens` field removed from all 17 L2-REINJECT markers, parser updated for backward compatibility |
