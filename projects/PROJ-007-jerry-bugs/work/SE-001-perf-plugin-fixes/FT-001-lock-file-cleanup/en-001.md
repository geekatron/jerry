# EN-001: Investigate Lock File Accumulation

> **Enabler ID:** EN-001
> **Feature:** FT-001 Lock File Cleanup
> **Solution Epic:** SE-001
> **Project:** PROJ-007-jerry-bugs
> **Status:** IN PROGRESS
> **Created:** 2026-01-14
> **Last Updated:** 2026-01-14

---

## Objective

Investigate the root cause of lock file accumulation in `.jerry/local/locks/` causing performance degradation.

---

## Acceptance Criteria

- [ ] AC-001.1: Root cause identified using 5 Whys methodology
- [ ] AC-001.2: Evidence chain documented for each "Why"
- [ ] AC-001.3: Corrective actions proposed with owners
- [ ] AC-001.4: Investigation report created in `investigations/`

---

## Tasks

| ID | Task | Status | Evidence |
|----|------|--------|----------|
| T-001.1 | Count accumulated lock files | DONE | 97 files in .jerry/local/locks/ |
| T-001.2 | Trace lock file creation code | DONE | atomic_file_adapter.py:72-76 |
| T-001.3 | Verify no cleanup mechanism exists | DONE | No delete/cleanup code found |
| T-001.4 | Review ADR-006 for original design intent | DONE | Cleanup was planned but not implemented |
| T-001.5 | Create ps-investigator report | PENDING | - |
| T-001.6 | Propose corrective actions | PENDING | - |

---

## Investigation Notes

### Evidence Gathered

| ID | Type | Source | Finding |
|----|------|--------|---------|
| E-001 | Code | `atomic_file_adapter.py:72-76` | `_get_lock_path()` creates lock files using SHA-256 hash of absolute path |
| E-002 | Code | `atomic_file_adapter.py:95` | `lock_path.touch(exist_ok=True)` creates file but never removes |
| E-003 | Data | `.jerry/local/locks/` | 97 lock files, all 0 bytes |
| E-004 | Doc | ADR-006:195-196 | "Lock file cleanup needed for crashed processes" |
| E-005 | Doc | ADR-006:300-307 | Stale Lock Cleanup section: "Do NOT auto-remove" but provide CLI command |

### Preliminary Root Cause

The `AtomicFileAdapter` creates a lock file for every unique file path it operates on (using SHA-256 hash). These lock files:
1. Are created on first access to any file path
2. Persist indefinitely (no TTL, no cleanup)
3. Are never removed, even when the associated data file is deleted

The ADR-006 design specified lock file cleanup but it was never implemented.

---

## Related Artifacts

| Type | Location | Description |
|------|----------|-------------|
| Feature Tracker | [FEATURE-WORKTRACKER.md](./FEATURE-WORKTRACKER.md) | Parent FT-001 |
| Bug Doc | [bug-001-lock-file-accumulation.md](./bug-001-lock-file-accumulation.md) | Bug documentation |
| Source Code | `src/infrastructure/adapters/persistence/atomic_file_adapter.py` | Code under investigation |
| ADR | `projects/PROJ-001-plugin-cleanup/design/ADR-006-file-locking-strategy.md` | Original design |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-14 | EN-001 created, initial investigation | Claude |
| 2026-01-14 | Tasks T-001.1 through T-001.4 completed | Claude |
