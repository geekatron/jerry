# ORCHESTRATION.yaml - Machine-Readable State (SSOT)
# Workflow: FEAT-005 Skill Compliance
# Version: 3.1.0 (Background execution for parallel tracks)
# Created: 2026-01-30
# Updated: 2026-01-31 - v3.1.0 per DEC-003 execution mode decision

workflow:
  id: "feat-005-compliance-20260130-001"
  name: "FEAT-005 Skill Compliance Execution"
  project_id: "PROJ-008-transcript-skill"
  feature_id: "FEAT-005"
  status: ACTIVE
  version: "3.1.0"
  created_at: "2026-01-30T22:00:00Z"
  updated_at: "2026-01-31T05:00:00Z"

# ============================================================================
# EXECUTION MODE CONFIGURATION (v3.1.0 NEW)
# ============================================================================
# Reference: DEC-003 - Background execution required for true parallelism
#
# Key insight: Each Task agent gets its own context window. Running agents
# in background does NOT degrade quality - they read/write files, not shared
# memory. Foreground execution would make parallel tracks impossible.
# ============================================================================
execution:
  # Phase 0: Foreground - blocking gate, must wait for result
  phase_0_mode: foreground
  phase_0_rationale: |
    TASK-419 is a blocking gate. We must wait for PASS/FAIL before any other
    work can begin. Foreground is simpler since nothing else can start until
    this completes. Background would just mean we poll immediately anyway.

  # Track agents: Background - enables true parallelism
  track_agent_mode: background
  track_agent_rationale: |
    Track A and Track B must run in parallel. With foreground execution,
    the orchestrator (Claude main context) would be blocked waiting for
    each agent to complete. Background execution allows:
    1. Spawn EN-027 (background) -> continues running
    2. Spawn TASK-420 (background) -> continues running
    3. Both progress simultaneously in separate context windows
    4. Orchestrator polls/waits for completion
    5. True parallelism achieved

    Each agent has its own context window. They don't share memory.
    Cross-pollination happens via files - agent A writes, agent B reads.
    Background execution does NOT degrade quality.

  # ps-critic: Foreground - quick evaluation, simpler coordination
  critic_mode: foreground
  critic_rationale: |
    ps-critic evaluations are relatively quick and require immediate
    decision-making (pass/fail/refine). Foreground simplifies the
    iterative refinement loop. Could be background if needed.

  # Orchestrator responsibilities during background execution
  orchestrator:
    responsibilities:
      - "Spawn agents with run_in_background: true"
      - "Track output_file paths for each background agent"
      - "Poll for completion using Read tool or TaskOutput"
      - "Update ORCHESTRATION.yaml after each agent completes"
      - "Coordinate cross-pollination by spawning consumers after producers"
      - "Enforce quality gates before spawning dependent agents"

    # How to check background agent completion
    completion_check:
      method: "TaskOutput or Read output_file"
      poll_interval: "30 seconds for long tasks, immediate for short"
      timeout: "2x estimated effort as safety margin"

    # State update protocol
    state_updates:
      timing: "After each agent completion, BEFORE spawning dependents"
      serialization: "Updates are serialized by orchestrator - no race conditions"
      artifacts:
        - "ORCHESTRATION.yaml"
        - "ORCHESTRATION_WORKTRACKER.md"

  # Parallel execution strategy
  parallel_strategy:
    phase_0:
      agents: ["TASK-419"]
      execution: "sequential_foreground"
      wait_for_all: true
      on_complete: "evaluate G-PHASE0, if PASS spawn parallel tracks"

    day_1_parallel:
      track_a_agents: ["EN-027"]
      track_b_agents: ["TASK-420", "TASK-421"]
      execution: "parallel_background"
      note: "TASK-422 waits for CP-2 (EN-027 complete)"

    subsequent_days:
      strategy: "spawn_when_unblocked"
      description: |
        As agents complete and quality gates pass, spawn the next
        unblocked agents. This maximizes parallelism while respecting
        dependencies. Example:
        - EN-027 completes -> G-027 pass -> TASK-422 can spawn
        - TASK-420 completes -> CP-3 ready -> EN-028 has CLI data

# ============================================================================
# VERSION 3.0.0 CRITICAL CHANGE
# ============================================================================
# DISC-003 identified a dependency chain flaw in v2.x:
# - v2.x incorrectly showed EN-027 and TASK-419 as parallel
# - TASK-419 results MUST inform EN-027 agent definition design
# - v3.0.0 introduces Phase 0 as sequential hard gate
#
# Reference: FEAT-005--DISC-003-orchestration-dependency-chain-flaw.md
# Reference: FEAT-005--DEC-002-orchestration-v3-design-decisions.md
# ============================================================================

# ============================================================================
# PHASE 0: SEQUENTIAL HARD GATE (v3.0.0 NEW)
# ============================================================================
# TASK-419 MUST complete BEFORE any parallel work begins.
# If TASK-419 fails, escalate to user - do NOT proceed with parallel tracks.
# ============================================================================
phase_0:
  name: "Sequential Hard Gate"
  description: "TASK-419 validates Task tool model parameter before parallel execution"
  status: COMPLETE
  is_hard_gate: true
  failure_action: "ESCALATE_TO_USER"
  completed_at: "2026-01-31T05:30:00Z"

  task:
    id: "TASK-419"
    title: "Validate Task tool model parameter"
    effort_hours: 2
    status: COMPLETE
    completed_at: "2026-01-31T05:30:00Z"
    critical: true
    artifact_path: "EN-031-model-selection-capability/TASK-419-validate-task-model.md"
    acceptance_criteria:
      - "Confirm model parameter exists in Task tool schema"
      - "Test invocation with model: haiku - verify haiku model used"
      - "Test invocation with model: sonnet - verify sonnet model used"
      - "Document exact parameter values (haiku vs claude-3-haiku)"
      - "Document any limitations or edge cases"
    validation_results:
      haiku_test: "PASS - claude-haiku-4-5-20251001"
      sonnet_test: "PASS - claude-sonnet-4-5-20250929"
      syntax: "model: haiku | sonnet | opus (simple strings)"
      limitations: "None discovered"

  quality_gate:
    id: "G-PHASE0"
    type: "validation"
    threshold: "PASS"  # Binary pass/fail, not numeric score
    criteria: "Model parameter works as documented"
    status: PASSED
    result: PASS
    evaluated_at: "2026-01-31T05:30:00Z"

  failure_protocol:
    description: "If TASK-419 fails, workflow is blocked until user decision"
    impediment_path: "FEAT-005--IMP-001-task-tool-model-param-failure.md"
    escalation_message: |
      CRITICAL: TASK-419 (Model Parameter Validation) FAILED.

      This blocks the entire EN-031 Model Selection feature and affects
      how EN-027 agent definitions should be structured.

      Options:
      a) Provide workaround or alternative approach
      b) Descope EN-031 entirely, proceed with Track A only
      c) Pause workflow for manual investigation
      d) Accept limitation and document as known constraint
    user_options:
      - id: "a"
        label: "Provide workaround"
        action: "User provides alternative approach"
      - id: "b"
        label: "Descope EN-031"
        action: "Remove EN-031 from scope, continue Track A only"
      - id: "c"
        label: "Pause workflow"
        action: "Halt all work pending investigation"
      - id: "d"
        label: "Accept limitation"
        action: "Document as constraint, proceed with limitations"

# ============================================================================
# ADVERSARIAL FEEDBACK LOOP CONFIGURATION
# ============================================================================
feedback_loop:
  enabled: true
  max_iterations: 3
  escalation_on_failure: true
  critique_artifact_dir: "orchestration/critiques"

  critic_config:
    agent: "ps-critic"
    model: "sonnet"
    output_format: "structured_markdown"

  escalation:
    notify_user: true
    block_downstream: true
    require_human_decision: true

  adversarial_protocol:
    enabled: true
    version: "1.0.0"
    reference: "FEAT-003--DISC-002-adversarial-prompting-protocol.md"

    framing: |
      You are operating as an ADVERSARIAL CRITIC, not a constructive reviewer.
      Assume problems EXIST until proven otherwise. Your job is to FIND flaws,
      not validate work. A "clean" review with no findings is SUSPICIOUS.

    minimum_findings: 3
    perfect_score_threshold: 0.95
    perfect_score_requires_justification: true
    devils_advocate_enabled: true
    challenges_per_section: 1
    checklist_evidence_required: true
    partial_credit_allowed: false
    counter_examples_required: true
    min_counter_examples: 3

    score_calibration:
      expected_first_pass_range: [0.60, 0.80]
      high_score_justification_threshold: 0.90
      exceptional_score_threshold: 0.95
      score_distribution_guidance: |
        0.95-1.00: Exceptional (<5% of reviews) - requires heavy justification
        0.85-0.94: Strong (15-20%) - minor issues only
        0.70-0.84: Acceptable (40-50%) - some issues need attention
        0.50-0.69: Needs Work (20-30%) - significant gaps
        0.00-0.49: Major Revision (10-15%) - fundamental issues

    prompt_template: |
      ## ADVERSARIAL EVALUATION MODE ACTIVATED

      You are operating as an ADVERSARIAL CRITIC for quality gate {gate_id}.
      Apply ALL six adversarial patterns:
      1. Red Team Framing - Assume problems exist
      2. Mandatory Findings - Identify >=3 issues
      3. Devil's Advocate - Challenge each claim
      4. Checklist Enforcement - No partial credit
      5. Counter-Examples - Find failure scenarios
      6. Score Calibration - First-pass typically 0.60-0.80

      **Iteration:** {iteration} of {max_iterations}
      **Previous Score:** {previous_score}
      **Threshold:** {threshold}

      Evaluate the following deliverables against {criteria}:
      {deliverable_list}

      REMEMBER: A review finding zero issues requires explicit justification.

# ============================================================================
# TRACK A: SEQUENTIAL COMPLIANCE CHAIN
# ============================================================================
# BLOCKED BY: Phase 0 (TASK-419 must PASS first)
# ============================================================================
tracks:
  track_a:
    name: "Sequential Compliance Chain"
    description: "EN-027 -> EN-028 -> EN-029 -> EN-030"
    total_effort_hours: 33
    status: IN_PROGRESS
    blocked_by: []  # Phase 0 complete - unblocked
    unblocked_at: "2026-01-31T05:30:00Z"

    enablers:
      - id: "EN-027"
        name: "Agent Definition Compliance"
        status: READY
        effort_hours: 10
        blocked_by: []  # Phase 0 complete - unblocked
        consumes_cross_pollination: ["CP-1"]  # Uses TASK-419 results
        cp_1_available: true  # TASK-419 results ready
        tasks:
          - id: "TASK-400"
            title: "Add identity section"
            effort: 1
            status: PENDING
          - id: "TASK-401"
            title: "Add capabilities section"
            effort: 1.5
            status: PENDING
          - id: "TASK-402"
            title: "Add guardrails section"
            effort: 3
            status: PENDING
          - id: "TASK-403"
            title: "Add validation section"
            effort: 2
            status: PENDING
          - id: "TASK-404"
            title: "Add constitution section"
            effort: 1
            status: PENDING
          - id: "TASK-405"
            title: "Add session_context section"
            effort: 1
            status: PENDING
          - id: "TASK-406"
            title: "Validate agent compliance"
            effort: 0.5
            status: PENDING
        quality_gate:
          id: "G-027"
          type: "ps-critic"
          threshold: 0.90
          criteria: "Agent Compliance Checklist (A-001 through A-043)"
          status: PENDING
          score: null
          iteration:
            current: 0
            max: 3
            history: []
          critique_artifacts: []
          last_critique_path: null

      - id: "EN-028"
        name: "SKILL.md Compliance"
        status: BLOCKED
        effort_hours: 9
        blocked_by: ["EN-027"]
        tasks:
          - id: "TASK-407"
            title: "Add invoking section"
            effort: 1
            status: PENDING
          - id: "TASK-408"
            title: "Enhance state passing"
            effort: 2
            status: PENDING
          - id: "TASK-409"
            title: "Add persistence section"
            effort: 1
            status: PENDING
          - id: "TASK-410"
            title: "Add self-critique"
            effort: 1
            status: PENDING
          - id: "TASK-411"
            title: "Restructure persona/output"
            effort: 2
            status: PENDING
        quality_gate:
          id: "G-028"
          type: "ps-critic"
          threshold: 0.90
          criteria: "SKILL.md Compliance Checklist (S-001 through S-051)"
          status: PENDING
          score: null
          iteration:
            current: 0
            max: 3
            history: []
          critique_artifacts: []
          last_critique_path: null

      - id: "EN-029"
        name: "Documentation Compliance"
        status: BLOCKED
        effort_hours: 9
        blocked_by: ["EN-028"]
        tasks:
          - id: "TASK-412"
            title: "Add L2 architect section"
            effort: 3
            status: PENDING
          - id: "TASK-413"
            title: "Create anti-patterns"
            effort: 3
            status: PENDING
          - id: "TASK-414"
            title: "Declare pattern refs"
            effort: 2
            status: PENDING
          - id: "TASK-415"
            title: "Add constraints section"
            effort: 1
            status: PENDING
        quality_gate:
          id: "G-029"
          type: "ps-critic"
          threshold: 0.90
          criteria: "PLAYBOOK.md Triple-Lens Checklist"
          status: PENDING
          score: null
          iteration:
            current: 0
            max: 3
            history: []
          critique_artifacts: []
          last_critique_path: null

      - id: "EN-030"
        name: "Documentation Polish"
        status: BLOCKED
        effort_hours: 5
        blocked_by: ["EN-029"]
        tasks:
          - id: "TASK-416"
            title: "Add tool examples"
            effort: 2
            status: PENDING
          - id: "TASK-417"
            title: "Add design rationale"
            effort: 2
            status: PENDING
          - id: "TASK-418"
            title: "Add cross-skill refs"
            effort: 1
            status: PENDING
        quality_gate:
          id: "G-030"
          type: "ps-critic"
          threshold: 0.95
          criteria: "Final polish - no regressions, integration complete"
          status: PENDING
          score: null
          iteration:
            current: 0
            max: 3
            history: []
          critique_artifacts: []
          last_critique_path: null

  # ============================================================================
  # TRACK B: MODEL SELECTION (PHASES 2-3 ONLY)
  # ============================================================================
  # Note: TASK-419 (Phase 1) is now in Phase 0 above
  # Track B Phase 2-3 are BLOCKED BY Phase 0
  # ============================================================================
  track_b:
    name: "Model Selection (Phases 2-3)"
    description: "EN-031 Phases 2-3 - Implementation and Testing"
    total_effort_hours: 32  # Reduced: TASK-419 (2h) moved to Phase 0
    status: IN_PROGRESS
    blocked_by: []  # Phase 0 complete - unblocked
    unblocked_at: "2026-01-31T05:30:00Z"

    enablers:
      - id: "EN-031"
        name: "Model Selection Capability (Phases 2-3)"
        status: READY
        effort_hours: 32
        blocked_by: []  # Phase 0 complete - unblocked
        consumes_cross_pollination: ["CP-2"]  # Uses EN-027 patterns for TASK-422
        phases:
          # Note: Phase 1 (TASK-419) is now in phase_0 section above
          - phase: 2
            name: "Implementation"
            blocked_by: []  # Phase 0 complete - unblocked
            tasks:
              - id: "TASK-420"
                title: "Add CLI model params"
                effort: 8
                status: PENDING
                produces_cross_pollination: "CP-3"
              - id: "TASK-421"
                title: "Update SKILL.md docs"
                effort: 4
                status: PENDING
              - id: "TASK-422"
                title: "Update agent definitions"
                effort: 4
                status: PENDING
                consumes_cross_pollination: "CP-2"
              - id: "TASK-423"
                title: "Implement profiles"
                effort: 8
                status: PENDING
          - phase: 3
            name: "Testing"
            blocked_by: ["phase_2"]
            tasks:
              - id: "TASK-424"
                title: "Integration testing"
                effort: 8
                status: PENDING
        quality_gate:
          id: "G-031"
          type: "ps-critic"
          threshold: 0.90
          criteria: "Model selection requirements from EN-031 AC"
          status: PENDING
          score: null
          iteration:
            current: 0
            max: 3
            history: []
          critique_artifacts: []
          last_critique_path: null

# ============================================================================
# CROSS-POLLINATION SPECIFICATION (v3.0.0 DETAILED)
# ============================================================================
# Reference: DEC-002:D-005 requires no ambiguity in cross-pollination
# ============================================================================
cross_pollination:
  - id: "CP-1"
    name: "TASK-419 Results -> EN-027 Agent Definitions"
    trigger: "TASK-419 complete (Phase 0 PASS)"
    trigger_condition: "phase_0.task.status == COMPLETE AND phase_0.quality_gate.result == PASS"
    from:
      phase: "phase_0"
      task: "TASK-419"
    to:
      track: "track_a"
      enabler: "EN-027"
    information:
      summary: "Model parameter validation results inform agent definition design"
      details:
        - "Model parameter syntax (e.g., 'haiku' vs 'claude-3-haiku')"
        - "Validation status (PASS/FAIL)"
        - "Edge cases discovered"
        - "Recommended default values"
      artifact_path: "EN-031-model-selection-capability/TASK-419-validate-task-model.md"
    usage_in_target:
      - "Correct model override syntax in agent YAML sections"
      - "Whether to include model override capability at all"
      - "Guardrails for model selection input_validation rules"
      - "Default model in agent definitions"
    status: READY
    triggered_at: "2026-01-31T05:30:00Z"
    cp_1_output:
      model_syntax: "model: haiku | sonnet | opus"
      default_behavior: "If not specified, inherits from parent"
      recommended_defaults:
        ts-parser: haiku
        ts-extractor: sonnet
        ts-formatter: haiku
        ts-mindmap-mermaid: sonnet
        ts-mindmap-ascii: sonnet
        ps-critic: sonnet

  - id: "CP-2"
    name: "EN-027 Patterns -> TASK-422 Agent Updates"
    trigger: "EN-027 quality gate G-027 PASS"
    trigger_condition: "tracks.track_a.enablers[EN-027].quality_gate.status == PASSED"
    from:
      track: "track_a"
      enabler: "EN-027"
    to:
      track: "track_b"
      task: "TASK-422"
    information:
      summary: "Agent YAML schema patterns for model override"
      details:
        - "Standard YAML structure for agents"
        - "session_context.schema definition"
        - "Constitution compliance patterns"
        - "Guardrails patterns"
      artifact_paths:
        - "skills/transcript/agents/ts-parser.md"
        - "skills/transcript/agents/ts-extractor.md"
        - "skills/transcript/agents/ts-formatter.md"
        - "skills/transcript/agents/ts-mindmap-mermaid.md"
        - "skills/transcript/agents/ts-mindmap-ascii.md"
    usage_in_target:
      - "Add model_override section using consistent structure"
      - "Add model configuration to session_context schema"
      - "Ensure model selection follows P-020 (user authority)"
      - "Add model-specific input validation rules"
    status: PENDING

  - id: "CP-3"
    name: "TASK-420 CLI Design -> SKILL.md Documentation"
    trigger: "TASK-420 complete"
    trigger_condition: "tracks.track_b.enablers[EN-031].phases[2].tasks[TASK-420].status == COMPLETE"
    from:
      track: "track_b"
      task: "TASK-420"
    to:
      track: "track_a"
      enabler: "EN-028"
      task: "TASK-421"
    information:
      summary: "CLI parameter design for SKILL.md documentation"
      details:
        - "Exact CLI flag syntax (e.g., '--model-parser haiku')"
        - "Parameter validation rules"
        - "Default behavior"
        - "Profile definitions"
      artifact_path: "EN-031-model-selection-capability/TASK-420-add-cli-model-params.md"
    usage_in_target:
      - "Usage examples in SKILL.md Invoking section"
      - "Input validation documentation in Parameters table"
      - "Default values in parameter descriptions"
      - "Model profile documentation in new section"
    status: PENDING

# ============================================================================
# QUALITY GATES SUMMARY
# ============================================================================
quality_gates:
  phase_0:
    id: "G-PHASE0"
    type: "validation"
    threshold: "PASS"
    criteria: "TASK-419 model parameter validation"
    status: PASSED
    result: PASS
    evaluated_at: "2026-01-31T05:30:00Z"

  enabler_gates:
    - id: "G-027"
      enabler: "EN-027"
      threshold: 0.90
      status: PENDING
    - id: "G-028"
      enabler: "EN-028"
      threshold: 0.90
      status: PENDING
    - id: "G-029"
      enabler: "EN-029"
      threshold: 0.90
      status: PENDING
    - id: "G-030"
      enabler: "EN-030"
      threshold: 0.95
      status: PENDING
    - id: "G-031"
      enabler: "EN-031"
      threshold: 0.90
      status: PENDING

  final:
    id: "G-FINAL"
    type: "ps-critic"
    threshold: 0.90
    criteria: "Aggregate compliance >= 95%, all 25 tasks complete"
    status: PENDING
    score: null
    iteration:
      current: 0
      max: 1
      history: []
    critique_artifacts: []
    last_critique_path: null

# ============================================================================
# CHECKPOINTS
# ============================================================================
checkpoints:
  definitions:
    - id: "CP-PHASE0"
      trigger: "Phase 0 complete"
      description: "TASK-419 validation complete"
    - id: "CP-001"
      trigger: "EN-027 complete"
      description: "Agent definitions done"
    - id: "CP-002"
      trigger: "EN-028 complete"
      description: "SKILL.md stable"
    - id: "CP-003"
      trigger: "EN-029 complete"
      description: "Documentation structure done"
    - id: "CP-004"
      trigger: "EN-030 complete"
      description: "Track A done"
    - id: "CP-005"
      trigger: "EN-031 complete"
      description: "Track B done"
    - id: "CP-FINAL"
      trigger: "All complete"
      description: "Workflow complete"
  entries:
    - id: "CP-PHASE0"
      timestamp: "2026-01-31T05:30:00Z"
      description: "Phase 0 complete - TASK-419 validation PASS"
      gate_result: "G-PHASE0 PASS"
  latest_id: "CP-PHASE0"

# ============================================================================
# METRICS
# ============================================================================
metrics:
  tasks_total: 25
  tasks_complete: 1  # TASK-419
  phase_0_complete: true
  enablers_total: 5
  enablers_complete: 0
  quality_gates_total: 7  # G-PHASE0 + G-027 to G-031 + G-FINAL
  quality_gates_passed: 1  # G-PHASE0
  effort_total_hours: 67  # 2h (Phase 0) + 33h (Track A) + 32h (Track B)
  effort_complete_hours: 2  # TASK-419
  estimated_days: 6
  actual_days: null
  completion_percentage: 3  # 1/25 tasks = 4%, 2/67 hours = 3%

# ============================================================================
# EXECUTION LOG
# ============================================================================
execution_log:
  - timestamp: "2026-01-30T23:00:00Z"
    event: "WORKFLOW_CREATED"
    details: "Orchestration plan v2.0 created"
  - timestamp: "2026-01-31T00:30:00Z"
    event: "FEEDBACK_LOOP_ADDED"
    details: "v2.1.0 - Added adversarial feedback loop"
  - timestamp: "2026-01-31T02:00:00Z"
    event: "ADVERSARIAL_PROTOCOL_ADDED"
    details: "v2.2.0 - Added 6 adversarial prompting patterns"
  - timestamp: "2026-01-31T04:00:00Z"
    event: "VERSION_3_APPROVED"
    details: "v3.0.0 - TASK-419 as Phase 0 sequential hard gate (DISC-003/DEC-002)"
  - timestamp: "2026-01-31T05:00:00Z"
    event: "EXECUTION_MODE_DEFINED"
    details: "v3.1.0 - Background execution for parallel tracks (DEC-003)"
  - timestamp: "2026-01-31T05:30:00Z"
    event: "PHASE_0_COMPLETE"
    details: "G-PHASE0 PASS - TASK-419 model parameter validation successful"
    results:
      haiku: "claude-haiku-4-5-20251001"
      sonnet: "claude-sonnet-4-5-20250929"
      syntax: "model: haiku | sonnet | opus"
    cp_1_triggered: true
    tracks_unblocked: ["track_a", "track_b"]

# ============================================================================
# SCHEMA DOCUMENTATION
# ============================================================================
# Phase 0 is a NEW construct in v3.0.0:
# - Contains exactly one task (TASK-419) that gates all downstream work
# - Has binary PASS/FAIL quality gate (not numeric score)
# - If FAIL: workflow is BLOCKED, user decision required
# - If PASS: parallel tracks can begin
#
# Cross-pollination now includes:
# - trigger_condition: Machine-readable condition for automation
# - information.details: Array of specific data transferred
# - usage_in_target: How the consuming task uses the information
# ============================================================================
