%%{init: {'theme': 'dark'}}%%
flowchart TB
    %% EN-202 CLAUDE.md REWRITE ORCHESTRATION
    %% Workflow ID: en202-rewrite-20260201-001
    %% Target: 914 LOC to 60-80 LOC

    START([EN-202 Start<br/>914 LOC - 10K tokens])

    %% PHASE 0: NAVIGATION TABLES
    subgraph P0[PHASE 0: Navigation Tables]
        TASK000[TASK-000<br/>Add NAV-006 tables<br/>~23 files<br/>STATUS: COMPLETE]
    end

    CP0{{CP-0: Phase 0 Complete}}

    %% PHASE 1: SECTION CREATION - PARALLEL
    subgraph P1[PHASE 1: Section Creation - PARALLEL]
        direction TB

        subgraph SECTIONS[5 Parallel Section Tasks]
            direction LR
            TASK001[TASK-001<br/>Identity<br/>~10 LOC]
            TASK002[TASK-002<br/>Navigation<br/>~20 LOC]
            TASK003[TASK-003<br/>Active Project<br/>~15 LOC]
            TASK004[TASK-004<br/>Constraints<br/>~15 LOC]
            TASK005[TASK-005<br/>Quick Ref<br/>~15 LOC]
        end

        subgraph BUGS[Bug Fixes During Creation]
            BUG001[BUG-001: typo fix]
            BUG002[BUG-002: StoryId fix]
            BUG003[BUG-003: path fix]
        end

        subgraph DISC002[DISC-002 Review Loop]
            WRITE[ps-writer<br/>Generate Section]
            REVIEW[ps-critic<br/>Review]
            SCORE{Score >= 0.92?}
            ITER{Iteration < 3?}
            REVISE[Revise Section]
            ACCEPT[Accept Section]
            ESCALATE[Escalate to Human]

            WRITE --> REVIEW --> SCORE
            SCORE -->|Yes| ACCEPT
            SCORE -->|No| ITER
            ITER -->|Yes| REVISE --> WRITE
            ITER -->|No| ESCALATE
        end

        SECTIONS --> BUGS --> DISC002
    end

    %% QG-1: Section Review
    subgraph QG1[QG-1: Section Review]
        PS_CRITIC[ps-critic Review<br/>C/A/CL/AC/T criteria]
        NSE_QA1[nse-qa Audit<br/>NASA SE compliance]
        QG1_PASS{Both >= 0.92?}

        PS_CRITIC --> QG1_PASS
        NSE_QA1 --> QG1_PASS
    end

    CP1{{CP-1: Phase 1 Complete}}

    %% PHASE 2: INTEGRATION
    subgraph P2[PHASE 2: Integration]
        NSE_INT[nse-qa Integration Audit]

        subgraph CHECKS[Integration Checks]
            INT001[INT-001: 60-80 LOC]
            INT002[INT-002: ~3500 tokens]
            INT003[INT-003: Pointers resolve]
            INT004[INT-004: No duplicates]
            INT005[INT-005: Bugs fixed]
            INT006[INT-006: Formatting OK]
            INT007[INT-007: Constraints OK]
        end

        NSE_INT --> CHECKS
    end

    %% QG-2: Integration Gate
    subgraph QG2[QG-2: Integration Review]
        QG2_CHECK{92% compliant?<br/>No critical findings?}
    end

    CP2{{CP-2: QG-2 Passed}}

    %% PHASE 3: VALIDATION
    subgraph P3[PHASE 3: Validation]
        TASK006[TASK-006<br/>Validate Pointers]
        TASK007[TASK-007<br/>Verify Line Count]

        TASK006 --> TASK007
    end

    FINISH([EN-202 Complete<br/>60-80 LOC - 3.5K tokens])

    %% CONNECTIONS
    START --> P0
    P0 --> CP0
    CP0 --> P1
    P1 --> QG1
    QG1 -->|Pass| CP1
    QG1 -->|Fail| ESCALATE
    CP1 --> P2
    P2 --> QG2
    QG2 -->|Pass| CP2
    QG2 -->|Fail| P2
    CP2 --> P3
    P3 --> FINISH

    %% STYLING
    classDef complete fill:#2d5a27,stroke:#4a9,color:#fff
    classDef pending fill:#1a4a6e,stroke:#5af,color:#fff
    classDef blocked fill:#6a2c2c,stroke:#f55,color:#fff
    classDef checkpoint fill:#5a3a6a,stroke:#a8f,color:#fff
    classDef gate fill:#2a4a5a,stroke:#8cf,color:#fff

    class TASK000 complete
    class TASK001,TASK002,TASK003,TASK004,TASK005 pending
    class TASK006,TASK007 blocked
    class CP0,CP1,CP2 checkpoint
    class QG1,QG2 gate
