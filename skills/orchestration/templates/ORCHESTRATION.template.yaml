# ORCHESTRATION.yaml
# Machine-readable orchestration state for multi-agent workflows
# Document ID: {PROJECT_ID}-ORCH-STATE
# Version: 2.0
# Last Updated: {TIMESTAMP}
# Schema Evolution: See docs/schemas/SCHEMA_VERSIONING.md

# Schema version for evolution support (semver format)
# Increment MAJOR for breaking changes, MINOR for additions, PATCH for fixes
schema_version: "2.0.0"

# =============================================================================
# WORKFLOW METADATA
# =============================================================================
workflow:
  id: "{WORKFLOW_ID}"
  name: "{WORKFLOW_NAME}"
  project_id: "{PROJECT_ID}"
  version: "2.0"
  created_at: "{CREATED_TIMESTAMP}"
  updated_at: "{UPDATED_TIMESTAMP}"
  status: "ACTIVE"  # ACTIVE | PAUSED | COMPLETE | FAILED | CANCELLED

  # Workflow ID configuration (WI-SAO-021)
  # Supports user-specified or auto-generated identifiers
  id_source: "auto"           # "user" | "auto" - how the workflow ID was determined
  id_format: "semantic-date-seq"  # Format specification for auto-generated IDs
  # Format: {purpose}-{YYYYMMDD}-{NNN}
  # Example: sao-crosspoll-20260110-001

  # Orchestration pattern classification
  patterns:
    - SEQUENTIAL      # Phases execute in order
    - CONCURRENT      # Pipelines run in parallel
    - BARRIER_SYNC    # Cross-pollination at barriers
    # Add patterns as applicable

  # Constraints from Jerry Constitution
  constraints:
    max_agent_nesting: 1          # P-003: Single nesting
    file_persistence: true        # P-002: All state to filesystem
    user_authority: true          # P-020: User approves gates
    max_concurrent_agents: 5      # Soft constraint
    max_barrier_retries: 2        # Circuit breaker
    checkpoint_frequency: "PHASE" # AGENT | PHASE | BARRIER

# =============================================================================
# PATH CONFIGURATION (WI-SAO-021)
# =============================================================================
# All paths are dynamically constructed using workflow and pipeline identifiers.
# No hardcoded pipeline names (ps, nse, etc.) - all derived from configuration.
paths:
  # Base path for all orchestration artifacts
  base: "orchestration/{workflow.id}/"

  # Pipeline artifact path pattern (AC-012-004: Agent-level isolation)
  # {pipeline_alias} is derived from pipelines.{key}.short_alias
  # {phase_id} is the phase identifier (e.g., "phase-1")
  # {agent_id} provides isolation for parallel (fan-out) execution
  pipeline: "{base}{pipeline_alias}/{phase_id}/{agent_id}/"

  # Barrier artifact path pattern
  # {barrier_id} is the barrier number (e.g., "barrier-1")
  # {direction} is "{source_alias}-to-{target_alias}" (e.g., "ps-to-nse")
  barrier: "{base}cross-pollination/{barrier_id}/{direction}/"

  # Examples (with workflow.id = "sao-crosspoll-20260110-001"):
  # - Pipeline: orchestration/sao-crosspoll-20260110-001/ps/phase-1/agent-a-001/output.md
  # - Barrier:  orchestration/sao-crosspoll-20260110-001/cross-pollination/barrier-1/ps-to-nse/handoff.md

# =============================================================================
# PIPELINE DEFINITIONS
# =============================================================================
pipelines:
  # Pipeline A definition
  pipeline_a:
    id: "pipeline-a"
    name: "{PIPELINE_A_NAME}"
    description: "{PIPELINE_A_DESCRIPTION}"

    # Short alias for path construction (WI-SAO-021)
    # Priority: 1) workflow override, 2) skill default, 3) auto-derived
    short_alias: "{PIPELINE_A_ALIAS}"  # e.g., "ps", "nse", "alpha"
    skill_source: "{SKILL_A_NAME}"      # Originating skill (e.g., "problem-solving")

    status: "PHASE_1_PENDING"  # PHASE_N_PENDING | PHASE_N_IN_PROGRESS | COMPLETE
    current_phase: 1
    total_phases: 2  # Update based on workflow
    progress_percent: 0

    phases:
      - id: 1
        name: "{PHASE_1_NAME}"
        path_id: "phase-1"  # Used in path construction
        status: "PENDING"   # PENDING | IN_PROGRESS | COMPLETE | BLOCKED
        started_at: null
        completed_at: null
        agents:
          - id: "agent-a-001"
            name: "{AGENT_NAME}"
            status: "PENDING"
            # Artifact path uses dynamic construction with agent-level isolation (AC-012-004):
            # {paths.pipeline} resolved with agent_id subdirectory
            # Defense in depth: filename includes agent_id for safe flattening
            artifact: "orchestration/{workflow.id}/{pipeline_a.short_alias}/phase-1/agent-a-001/agent-a-001-{artifact_type}.md"
            inputs: []
        artifacts: []

      - id: 2
        name: "{PHASE_2_NAME}"
        path_id: "phase-2"
        status: "BLOCKED"
        blocked_by: "barrier-1"
        started_at: null
        completed_at: null
        agents:
          - id: "agent-a-002"
            name: "{AGENT_NAME}"
            status: "BLOCKED"
            artifact: "orchestration/{workflow.id}/{pipeline_a.short_alias}/phase-2/agent-a-002/{artifact_name}.md"
        artifacts: []

  # Pipeline B definition
  pipeline_b:
    id: "pipeline-b"
    name: "{PIPELINE_B_NAME}"
    description: "{PIPELINE_B_DESCRIPTION}"

    # Short alias for path construction (WI-SAO-021)
    short_alias: "{PIPELINE_B_ALIAS}"  # e.g., "nse", "beta"
    skill_source: "{SKILL_B_NAME}"

    status: "PHASE_1_PENDING"
    current_phase: 1
    total_phases: 2
    progress_percent: 0

    phases:
      - id: 1
        name: "{PHASE_1_NAME}"
        path_id: "phase-1"
        status: "PENDING"
        started_at: null
        completed_at: null
        agents:
          - id: "agent-b-001"
            name: "{AGENT_NAME}"
            status: "PENDING"
            artifact: "orchestration/{workflow.id}/{pipeline_b.short_alias}/phase-1/agent-b-001/{artifact_name}.md"
        artifacts: []

      - id: 2
        name: "{PHASE_2_NAME}"
        path_id: "phase-2"
        status: "BLOCKED"
        blocked_by: "barrier-1"
        started_at: null
        completed_at: null
        agents:
          - id: "agent-b-002"
            name: "{AGENT_NAME}"
            status: "BLOCKED"
            artifact: "orchestration/{workflow.id}/{pipeline_b.short_alias}/phase-2/agent-b-002/{artifact_name}.md"
        artifacts: []

# =============================================================================
# SYNC BARRIERS
# =============================================================================
barriers:
  - id: "barrier-1"
    name: "{BARRIER_NAME}"
    status: "PENDING"  # PENDING | IN_PROGRESS | COMPLETE
    completed_at: null
    depends_on:
      - "pipeline_a.phase.1"
      - "pipeline_b.phase.1"
    artifacts:
      # Dynamic path construction using pipeline aliases
      # Format: {paths.barrier} + artifact filename
      a_to_b:
        path: "orchestration/{workflow.id}/cross-pollination/barrier-1/{pipeline_a.short_alias}-to-{pipeline_b.short_alias}/handoff.md"
        status: "PENDING"
        key_content: null
      b_to_a:
        path: "orchestration/{workflow.id}/cross-pollination/barrier-1/{pipeline_b.short_alias}-to-{pipeline_a.short_alias}/handoff.md"
        status: "PENDING"
        key_content: null

# =============================================================================
# EXECUTION QUEUE
# =============================================================================
execution_queue:
  current_group: 1
  groups:
    - id: 1
      name: "Phase 1 Agents"
      execution_mode: "PARALLEL"  # PARALLEL | SEQUENTIAL
      status: "READY"  # READY | IN_PROGRESS | COMPLETE | BLOCKED
      agents:
        - "agent-a-001"
        - "agent-b-001"

    - id: 2
      name: "Barrier 1 Cross-Pollination"
      execution_mode: "SEQUENTIAL"
      status: "BLOCKED"
      blocked_by: "group-1"
      tasks:
        - "create-a-to-b-artifact"
        - "create-b-to-a-artifact"

    - id: 3
      name: "Phase 2 Agents"
      execution_mode: "PARALLEL"
      status: "BLOCKED"
      blocked_by: "group-2"
      agents:
        - "agent-a-002"
        - "agent-b-002"

# =============================================================================
# CHECKPOINTS
# =============================================================================
checkpoints:
  latest_id: null
  entries: []
  # Example entry:
  # - id: "CP-001"
  #   timestamp: "2026-01-10T09:00:00Z"
  #   trigger: "PHASE_COMPLETE"  # PHASE_COMPLETE | BARRIER_COMPLETE | MANUAL
  #   description: "Phase 1 complete"
  #   recovery_point: "barrier-1-start"

# =============================================================================
# METRICS
# =============================================================================
metrics:
  execution:
    phases_complete: 0
    phases_total: 4  # 2 per pipeline
    phases_percent: 0
    barriers_complete: 0
    barriers_total: 1
    barriers_percent: 0
    agents_executed: 0
    agents_total: 4
    agents_percent: 0
    artifacts_created: 0
    artifacts_total: 6  # 4 phase + 2 cross-pollination
    artifacts_percent: 0

  quality:
    agent_success_rate: 0
    barrier_validation_pass_rate: 0
    checkpoint_recovery_tested: false

  timing:
    workflow_started: null
    last_activity: null
    estimated_completion: null

# =============================================================================
# BLOCKERS AND ISSUES
# =============================================================================
blockers:
  active: []
  # Example:
  # - id: "BLK-001"
  #   description: "Blocking issue description"
  #   blocking: ["agent-a-001"]
  #   severity: "HIGH"  # LOW | MEDIUM | HIGH
  #   created_at: "2026-01-10T09:00:00Z"

issues:
  resolved: []
  # Example:
  # - id: "ISS-001"
  #   description: "Issue description"
  #   resolution: "How it was resolved"
  #   resolved_at: "2026-01-10T10:00:00Z"

# =============================================================================
# NEXT ACTIONS
# =============================================================================
next_actions:
  immediate:
    - action: "Execute Phase 1 agents"
      agents: ["agent-a-001", "agent-b-001"]
      execution_mode: "PARALLEL"

  subsequent:
    - action: "Complete Barrier 1 cross-pollination"
      depends_on: "Phase 1 complete"
    - action: "Execute Phase 2 agents"
      depends_on: "Barrier 1 complete"

# =============================================================================
# RESUMPTION CONTEXT
# =============================================================================
resumption:
  # Sub-section 1: Recovery State (structured replacement for prose current_state)
  recovery_state:
    last_checkpoint: null
    current_phase: 0
    current_phase_name: "Not started"
    workflow_status: "ACTIVE"
    current_activity: "idle"
    next_step: "Execute Phase 1 agents"
    context_fill_at_update: null
    updated_at: "{UPDATED_TIMESTAMP}"
    cross_session_portable: true
    ephemeral_references: false

  # Sub-section 2: Files to Read (structured with priority and purpose)
  files_to_read:
    - path: "ORCHESTRATION.yaml"
      priority: 1
      purpose: "Machine-readable workflow state. Read resumption section first."
    - path: "ORCHESTRATION_PLAN.md"
      priority: 2
      purpose: "Strategic context. Agent definitions, phase descriptions."
    - path: "ORCHESTRATION_WORKTRACKER.md"
      priority: 3
      purpose: "Tactical documentation. Feature status, blockers."

  # Sub-section 3: Quality Trajectory
  quality_trajectory:
    gates_completed: []
    gates_remaining: []
    current_gate: null
    current_gate_iteration: null
    score_history: {}
    lowest_dimension: null
    total_iterations_used: 0

  # Sub-section 4: Defect Summary
  defect_summary:
    total_defects_found: 0
    total_defects_resolved: 0
    unresolved_defects: []
    recurring_patterns: []
    last_gate_primary_defect: null

  # Sub-section 5: Decision Log
  decision_log: []

  # Sub-section 6: Agent Summaries
  agent_summaries: {}

  # Sub-section 7: Compaction Events
  compaction_events:
    count: 0
    events: []
