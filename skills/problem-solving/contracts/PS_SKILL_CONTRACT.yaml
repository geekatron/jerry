# Problem-Solving Skill Interface Contract
# OpenAPI 3.0-inspired schema for PS agent handoffs
#
# Version: 1.0.0
# Skill: problem-solving
# Reference: skills/problem-solving/SKILL.md v2.1.0

openapi: "3.0.3"
info:
  title: Problem-Solving Skill Contract
  version: "1.0.0"
  description: |
    Interface contract for the Problem-Solving skill defining input/output
    schemas for all ps-* agents. This contract enables reliable agent
    orchestration and cross-skill handoffs.
  contact:
    name: Jerry Framework
    url: https://github.com/jerry-framework

# =============================================================================
# AGENTS
# =============================================================================

agents:
  ps-researcher:
    description: "Research Specialist - Gathers information with citations"
    cognitive_mode: divergent
    model: opus
    input_schema:
      $ref: "#/components/schemas/ResearcherInput"
    output_schema:
      $ref: "#/components/schemas/ResearcherOutput"
    output_location: "projects/${JERRY_PROJECT}/research/{ps_id}-{entry_id}-{topic_slug}.md"

  ps-analyst:
    description: "Analysis Specialist - Deep analysis (5 Whys, FMEA, trade-offs)"
    cognitive_mode: convergent
    model: sonnet
    input_schema:
      $ref: "#/components/schemas/AnalystInput"
    output_schema:
      $ref: "#/components/schemas/AnalystOutput"
    output_location: "projects/${JERRY_PROJECT}/analysis/{ps_id}-{entry_id}-{analysis_type}.md"

  ps-architect:
    description: "Architecture Specialist - Creates ADRs with Nygard format"
    cognitive_mode: convergent
    model: opus
    input_schema:
      $ref: "#/components/schemas/ArchitectInput"
    output_schema:
      $ref: "#/components/schemas/ArchitectOutput"
    output_location: "projects/${JERRY_PROJECT}/decisions/{ps_id}-{entry_id}-adr-{slug}.md"

  ps-critic:
    description: "Quality Evaluator - Iterative refinement with quality scores"
    cognitive_mode: convergent
    model: opus
    input_schema:
      $ref: "#/components/schemas/CriticInput"
    output_schema:
      $ref: "#/components/schemas/CriticOutput"
    output_location: "projects/${JERRY_PROJECT}/critiques/{ps_id}-{entry_id}-critique.md"

  ps-validator:
    description: "Validation Specialist - Verifies constraints with evidence"
    cognitive_mode: convergent
    model: sonnet
    input_schema:
      $ref: "#/components/schemas/ValidatorInput"
    output_schema:
      $ref: "#/components/schemas/ValidatorOutput"
    output_location: "projects/${JERRY_PROJECT}/analysis/{ps_id}-{entry_id}-validation.md"

  ps-synthesizer:
    description: "Synthesis Specialist - Pattern extraction across documents"
    cognitive_mode: divergent
    model: opus
    input_schema:
      $ref: "#/components/schemas/SynthesizerInput"
    output_schema:
      $ref: "#/components/schemas/SynthesizerOutput"
    output_location: "projects/${JERRY_PROJECT}/synthesis/{ps_id}-{entry_id}-synthesis.md"

  ps-reviewer:
    description: "Review Specialist - Code/design/security quality reviews"
    cognitive_mode: convergent
    model: sonnet
    input_schema:
      $ref: "#/components/schemas/ReviewerInput"
    output_schema:
      $ref: "#/components/schemas/ReviewerOutput"
    output_location: "projects/${JERRY_PROJECT}/reviews/{ps_id}-{entry_id}-{review_type}.md"

  ps-investigator:
    description: "Investigation Specialist - Root cause of failures"
    cognitive_mode: convergent
    model: opus
    input_schema:
      $ref: "#/components/schemas/InvestigatorInput"
    output_schema:
      $ref: "#/components/schemas/InvestigatorOutput"
    output_location: "projects/${JERRY_PROJECT}/investigations/{ps_id}-{entry_id}-investigation.md"

  ps-reporter:
    description: "Reporting Specialist - Status and progress reports"
    cognitive_mode: convergent
    model: sonnet
    input_schema:
      $ref: "#/components/schemas/ReporterInput"
    output_schema:
      $ref: "#/components/schemas/ReporterOutput"
    output_location: "projects/${JERRY_PROJECT}/reports/{ps_id}-{entry_id}-{report_type}.md"

# =============================================================================
# COMPONENT SCHEMAS
# =============================================================================

components:
  schemas:
    # -------------------------------------------------------------------------
    # Common Types
    # -------------------------------------------------------------------------
    PSContext:
      type: object
      required:
        - ps_id
        - entry_id
        - topic
      properties:
        ps_id:
          type: string
          pattern: "^[a-z]+-\\d+(\\.\\d+)?$"
          description: "Problem-solving identifier (e.g., work-024, phase-1.2)"
          example: "work-024"
        entry_id:
          type: string
          pattern: "^e-\\d+$"
          description: "Entry identifier within the PS workflow"
          example: "e-101"
        topic:
          type: string
          minLength: 1
          maxLength: 200
          description: "Topic or subject of the work"
          example: "Event Sourcing Patterns"

    OutputLevels:
      type: object
      required:
        - L0
        - L1
        - L2
      properties:
        L0:
          type: string
          description: "Executive Summary (ELI5) - 2-3 sentences for non-technical stakeholders"
        L1:
          type: string
          description: "Technical Analysis - Implementation details, code snippets, configurations"
        L2:
          type: string
          description: "Architectural Implications - Trade-offs, risks, strategic considerations"

    Citation:
      type: object
      required:
        - source
        - url
      properties:
        source:
          type: string
          description: "Source name or title"
          example: "Martin Fowler - Event Sourcing"
        url:
          type: string
          format: uri
          description: "Source URL"
          example: "https://martinfowler.com/eaaDev/EventSourcing.html"
        key_insight:
          type: string
          description: "What we learned from this source"
          example: "Event sourcing provides complete audit trails"
        credibility:
          type: string
          enum: [HIGH, MEDIUM, LOW]
          description: "Source credibility rating"
          default: MEDIUM

    UpstreamArtifact:
      type: object
      required:
        - path
        - type
      properties:
        path:
          type: string
          description: "Relative path to the artifact"
          example: "projects/PROJ-002/research/work-024-e-100-caching.md"
        type:
          type: string
          enum: [research, analysis, decision, validation, synthesis, review, investigation, report]
          description: "Type of artifact"
        summary:
          type: string
          description: "Brief summary of the artifact's key findings"

    ConfidenceScore:
      type: object
      required:
        - overall
      properties:
        overall:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: "Overall confidence score (0.0-1.0)"
          example: 0.85
        reasoning:
          type: string
          description: "Explanation for the confidence level"
        breakdown:
          type: object
          additionalProperties:
            type: number
            minimum: 0.0
            maximum: 1.0
          description: "Component confidence scores"

    # -------------------------------------------------------------------------
    # ps-researcher Input/Output
    # -------------------------------------------------------------------------
    ResearcherInput:
      type: object
      required:
        - context
        - research_questions
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        research_questions:
          type: array
          items:
            type: string
          minItems: 1
          description: "Questions to research"
          example:
            - "What are the best practices for event sourcing in Python?"
            - "Which libraries are commonly used?"
        scope:
          type: object
          properties:
            include:
              type: array
              items:
                type: string
              description: "Topics/areas to include"
            exclude:
              type: array
              items:
                type: string
              description: "Topics/areas to exclude"
        source_preferences:
          type: array
          items:
            type: string
            enum: [official_docs, academic, industry_blogs, context7, codebase]
          description: "Preferred source types"
        upstream_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"
          description: "Prior artifacts to reference"

    ResearcherOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - findings
        - citations
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
          description: "Path to persisted research document"
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        findings:
          type: array
          items:
            type: object
            required:
              - id
              - summary
              - category
            properties:
              id:
                type: string
                pattern: "^F-\\d{3}$"
              summary:
                type: string
              category:
                type: string
                enum: [insight, pattern, best_practice, warning, recommendation]
              evidence:
                type: array
                items:
                  type: string
          description: "Research findings"
        citations:
          type: array
          items:
            $ref: "#/components/schemas/Citation"
          minItems: 1
          description: "Required citations (P-001, P-004)"
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        next_agent_hint:
          type: string
          description: "Suggested downstream agent"
          example: "ps-analyst for root cause analysis"
        state_key:
          type: string
          const: "researcher_output"

    # -------------------------------------------------------------------------
    # ps-analyst Input/Output
    # -------------------------------------------------------------------------
    AnalystInput:
      type: object
      required:
        - context
        - analysis_type
        - subject
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        analysis_type:
          type: string
          enum: [root_cause, trade_off, gap, risk, comparison, 5_whys, fmea, ishikawa]
          description: "Type of analysis to perform"
        subject:
          type: string
          description: "Subject of analysis"
          example: "Build failures in CI pipeline"
        constraints:
          type: array
          items:
            type: string
          description: "Constraints to consider in analysis"
        upstream_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"
          description: "Prior artifacts to reference"

    AnalystOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - analysis_type
        - conclusions
        - recommendations
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        analysis_type:
          type: string
        conclusions:
          type: array
          items:
            type: object
            required:
              - id
              - conclusion
              - evidence
            properties:
              id:
                type: string
                pattern: "^C-\\d{3}$"
              conclusion:
                type: string
              evidence:
                type: array
                items:
                  type: string
              confidence:
                type: number
                minimum: 0.0
                maximum: 1.0
        recommendations:
          type: array
          items:
            type: object
            required:
              - id
              - recommendation
              - priority
            properties:
              id:
                type: string
                pattern: "^REC-\\d{3}$"
              recommendation:
                type: string
              priority:
                type: string
                enum: [high, medium, low]
              rationale:
                type: string
        root_cause:
          type: string
          description: "Root cause (for root_cause analysis type)"
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        next_agent_hint:
          type: string
        state_key:
          type: string
          const: "analyst_output"

    # -------------------------------------------------------------------------
    # ps-architect Input/Output
    # -------------------------------------------------------------------------
    ArchitectInput:
      type: object
      required:
        - context
        - decision_topic
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        decision_topic:
          type: string
          description: "Topic requiring architectural decision"
          example: "Caching layer selection"
        constraints:
          type: array
          items:
            type: string
          description: "Architectural constraints"
        alternatives:
          type: array
          items:
            type: string
          description: "Pre-identified alternatives to evaluate"
        upstream_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"

    ArchitectOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - adr
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        adr:
          type: object
          required:
            - number
            - title
            - status
            - decision
            - context
            - consequences
          properties:
            number:
              type: string
              pattern: "^ADR-\\d{3}$"
            title:
              type: string
            status:
              type: string
              enum: [PROPOSED, ACCEPTED, DEPRECATED, SUPERSEDED]
            decision:
              type: string
            context:
              type: string
            consequences:
              type: object
              properties:
                positive:
                  type: array
                  items:
                    type: string
                negative:
                  type: array
                  items:
                    type: string
            alternatives_considered:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  pros:
                    type: array
                    items:
                      type: string
                  cons:
                    type: array
                    items:
                      type: string
                  rejected_reason:
                    type: string
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        next_agent_hint:
          type: string
        state_key:
          type: string
          const: "architect_output"

    # -------------------------------------------------------------------------
    # ps-critic Input/Output
    # -------------------------------------------------------------------------
    CriticInput:
      type: object
      required:
        - context
        - artifact_to_critique
        - quality_dimensions
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_to_critique:
          $ref: "#/components/schemas/UpstreamArtifact"
        quality_dimensions:
          type: array
          items:
            type: string
            enum: [accuracy, completeness, clarity, coherence, evidence_based, actionable]
          minItems: 1
          description: "Dimensions to evaluate"
        iteration:
          type: integer
          minimum: 1
          default: 1
          description: "Current iteration number in refinement cycle"
        target_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          default: 0.85
          description: "Target quality score to achieve"

    CriticOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - quality_assessment
        - improvement_suggestions
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        quality_assessment:
          type: object
          required:
            - overall_score
            - dimensions
            - pass
          properties:
            overall_score:
              type: number
              minimum: 0.0
              maximum: 1.0
            dimensions:
              type: object
              additionalProperties:
                type: number
                minimum: 0.0
                maximum: 1.0
            pass:
              type: boolean
              description: "Whether target score was met"
        improvement_suggestions:
          type: array
          items:
            type: object
            required:
              - dimension
              - suggestion
              - priority
            properties:
              dimension:
                type: string
              suggestion:
                type: string
              priority:
                type: string
                enum: [high, medium, low]
              expected_improvement:
                type: number
                minimum: 0.0
                maximum: 0.2
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        state_key:
          type: string
          const: "critic_output"

    # -------------------------------------------------------------------------
    # ps-validator Input/Output
    # -------------------------------------------------------------------------
    ValidatorInput:
      type: object
      required:
        - context
        - constraints
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        constraints:
          type: array
          items:
            type: object
            required:
              - id
              - description
              - verification_method
            properties:
              id:
                type: string
                pattern: "^c-\\d{3}$"
              description:
                type: string
              verification_method:
                type: string
                enum: [analysis, demonstration, inspection, test]
          minItems: 1
          description: "Constraints to validate"
        upstream_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"

    ValidatorOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - validation_results
        - summary
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        validation_results:
          type: array
          items:
            type: object
            required:
              - constraint_id
              - status
              - evidence
            properties:
              constraint_id:
                type: string
              status:
                type: string
                enum: [PASS, FAIL, PARTIAL, NOT_VERIFIED]
              evidence:
                type: string
              gaps:
                type: array
                items:
                  type: string
        summary:
          type: object
          required:
            - total
            - passed
            - failed
            - pass_rate
          properties:
            total:
              type: integer
            passed:
              type: integer
            failed:
              type: integer
            pass_rate:
              type: number
              minimum: 0.0
              maximum: 1.0
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        next_agent_hint:
          type: string
        state_key:
          type: string
          const: "validator_output"

    # -------------------------------------------------------------------------
    # ps-synthesizer Input/Output
    # -------------------------------------------------------------------------
    SynthesizerInput:
      type: object
      required:
        - context
        - input_artifacts
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        input_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"
          minItems: 2
          description: "Artifacts to synthesize (minimum 2)"
        synthesis_focus:
          type: string
          description: "Focus area for synthesis"
          example: "Architectural patterns across research documents"

    SynthesizerOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - patterns
        - themes
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        patterns:
          type: array
          items:
            type: object
            required:
              - id
              - name
              - description
              - occurrences
            properties:
              id:
                type: string
                pattern: "^P-\\d{3}$"
              name:
                type: string
              description:
                type: string
              occurrences:
                type: integer
                minimum: 2
              sources:
                type: array
                items:
                  type: string
        themes:
          type: array
          items:
            type: object
            required:
              - id
              - theme
              - supporting_evidence
            properties:
              id:
                type: string
                pattern: "^T-\\d{3}$"
              theme:
                type: string
              supporting_evidence:
                type: array
                items:
                  type: string
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        state_key:
          type: string
          const: "synthesizer_output"

    # -------------------------------------------------------------------------
    # ps-reviewer Input/Output
    # -------------------------------------------------------------------------
    ReviewerInput:
      type: object
      required:
        - context
        - review_type
        - target
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        review_type:
          type: string
          enum: [code, design, architecture, security, documentation]
        target:
          type: string
          description: "Path or description of what to review"
        checklist:
          type: array
          items:
            type: string
          description: "Custom checklist items"

    ReviewerOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - review_type
        - findings
        - overall_assessment
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        review_type:
          type: string
        findings:
          type: array
          items:
            type: object
            required:
              - id
              - category
              - severity
              - description
            properties:
              id:
                type: string
                pattern: "^REV-\\d{3}$"
              category:
                type: string
              severity:
                type: string
                enum: [critical, major, minor, info]
              description:
                type: string
              location:
                type: string
              recommendation:
                type: string
        overall_assessment:
          type: string
          enum: [APPROVE, APPROVE_WITH_COMMENTS, REQUEST_CHANGES, REJECT]
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        state_key:
          type: string
          const: "reviewer_output"

    # -------------------------------------------------------------------------
    # ps-investigator Input/Output
    # -------------------------------------------------------------------------
    InvestigatorInput:
      type: object
      required:
        - context
        - incident
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        incident:
          type: object
          required:
            - description
            - when
          properties:
            description:
              type: string
            when:
              type: string
              format: date-time
            severity:
              type: string
              enum: [low, medium, high, critical]
            symptoms:
              type: array
              items:
                type: string
        methodology:
          type: string
          enum: [5_whys, ishikawa, fmea, timeline, all]
          default: "5_whys"

    InvestigatorOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - root_cause
        - contributing_factors
        - corrective_actions
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        root_cause:
          type: object
          required:
            - description
            - evidence
          properties:
            description:
              type: string
            evidence:
              type: array
              items:
                type: string
        contributing_factors:
          type: array
          items:
            type: object
            properties:
              factor:
                type: string
              contribution_level:
                type: string
                enum: [primary, secondary, tertiary]
        corrective_actions:
          type: array
          items:
            type: object
            required:
              - id
              - action
              - type
              - priority
            properties:
              id:
                type: string
                pattern: "^CA-\\d{3}$"
              action:
                type: string
              type:
                type: string
                enum: [immediate, short_term, long_term]
              priority:
                type: string
                enum: [high, medium, low]
              owner:
                type: string
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        state_key:
          type: string
          const: "investigator_output"

    # -------------------------------------------------------------------------
    # ps-reporter Input/Output
    # -------------------------------------------------------------------------
    ReporterInput:
      type: object
      required:
        - context
        - report_type
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        report_type:
          type: string
          enum: [status, progress, summary, metrics, health]
        scope:
          type: string
          description: "Scope of the report (e.g., 'Phase 2', 'Sprint 5')"
        upstream_artifacts:
          type: array
          items:
            $ref: "#/components/schemas/UpstreamArtifact"

    ReporterOutput:
      type: object
      required:
        - context
        - artifact_path
        - output_levels
        - report_type
        - metrics
        - confidence
      properties:
        context:
          $ref: "#/components/schemas/PSContext"
        artifact_path:
          type: string
        output_levels:
          $ref: "#/components/schemas/OutputLevels"
        report_type:
          type: string
        metrics:
          type: object
          additionalProperties:
            type: object
            properties:
              value:
                oneOf:
                  - type: number
                  - type: string
              unit:
                type: string
              trend:
                type: string
                enum: [up, down, stable]
        health_status:
          type: string
          enum: [GREEN, YELLOW, RED]
        key_highlights:
          type: array
          items:
            type: string
        risks_and_issues:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              severity:
                type: string
                enum: [low, medium, high, critical]
              mitigation:
                type: string
        confidence:
          $ref: "#/components/schemas/ConfidenceScore"
        state_key:
          type: string
          const: "reporter_output"

# =============================================================================
# TESTING APPROACH
# =============================================================================

testing:
  description: |
    Validation approach for PS skill contracts using behavioral tests.
    Reference: skills/problem-solving/tests/BEHAVIOR_TESTS.md

  unit_tests:
    - name: "Input validation - PSContext"
      test: "Validate ps_id pattern matching"
      valid_examples:
        - { ps_id: "work-024", entry_id: "e-101", topic: "Caching" }
        - { ps_id: "phase-1.2", entry_id: "e-001", topic: "Research" }
      invalid_examples:
        - { ps_id: "WORK-024", entry_id: "e-101", topic: "Caching" }  # uppercase
        - { ps_id: "work-024", entry_id: "101", topic: "Caching" }    # missing e-

    - name: "Output validation - Artifact persistence"
      test: "Verify P-002 compliance - file creation"
      assertion: "artifact_path must be non-empty and file must exist after invocation"

    - name: "Output validation - L0/L1/L2 levels"
      test: "Verify all three output levels are present"
      assertion: "output_levels.L0, L1, and L2 must be non-empty strings"

    - name: "Output validation - Citations"
      test: "Verify P-001/P-004 compliance - citations present"
      assertion: "citations array must have at least 1 item for ps-researcher"

  integration_tests:
    - name: "Sequential chain handoff"
      test: "ps-researcher -> ps-analyst chain"
      steps:
        - invoke: ps-researcher
          input: { research_questions: ["What are caching options?"] }
          expect: researcher_output with artifact_path
        - invoke: ps-analyst
          input: { upstream_artifacts: ["{researcher_output.artifact_path}"] }
          expect: analyst_output referencing research

    - name: "State key propagation"
      test: "Verify state keys are set correctly"
      assertion: "Each agent output must include its designated state_key"

  contract_tests:
    - name: "Schema version compatibility"
      test: "Validate session_context.schema_version handling"
      scenarios:
        - input_version: "1.0.0"
          expected: "Process normally"
        - input_version: "2.0.0"
          expected: "Warn but attempt processing"
        - input_version: null
          expected: "Reject with validation error"
