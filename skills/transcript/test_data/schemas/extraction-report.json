{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "extraction-report.json",
  "title": "ExtractionReport",
  "description": "Schema for ts-extractor output per TDD-ts-extractor.md Section 3 (v1.1: chunked input support)",
  "version": "1.1",
  "type": "object",
  "required": ["version", "packet_id", "input_format", "extraction_stats", "speakers", "action_items", "decisions", "questions", "topics"],
  "properties": {
    "version": {
      "type": "string",
      "enum": ["1.0", "1.1"],
      "description": "Schema version (1.1 adds chunked input support)"
    },
    "packet_id": {
      "type": "string",
      "description": "Unique identifier for the transcript packet"
    },
    "input_format": {
      "type": "string",
      "enum": ["single_file", "chunked"],
      "description": "Input format used: single_file (legacy) or chunked (recommended for large transcripts)"
    },
    "chunk_metadata": {
      "oneOf": [
        { "$ref": "#/$defs/ChunkMetadata" },
        { "type": "null" }
      ],
      "description": "Chunk processing metadata (present only when input_format='chunked')"
    },
    "extraction_stats": {
      "$ref": "#/$defs/ExtractionStats"
    },
    "speakers": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Speaker"
      },
      "description": "Identified speakers"
    },
    "action_items": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/ActionItem"
      },
      "description": "Extracted action items"
    },
    "decisions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Decision"
      },
      "description": "Extracted decisions"
    },
    "questions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Question"
      },
      "description": "Extracted questions"
    },
    "topics": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Topic"
      },
      "description": "Segmented topics"
    }
  },
  "if": {
    "properties": { "input_format": { "const": "chunked" } }
  },
  "then": {
    "required": ["chunk_metadata"],
    "properties": {
      "chunk_metadata": {
        "$ref": "#/$defs/ChunkMetadata"
      }
    }
  },
  "$defs": {
    "ChunkMetadata": {
      "type": "object",
      "required": ["index_path", "chunks_processed", "chunks_total", "selection_strategy"],
      "properties": {
        "index_path": {
          "type": "string",
          "description": "Path to index.json that was used"
        },
        "chunks_processed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of chunks actually processed"
        },
        "chunks_total": {
          "type": "integer",
          "minimum": 0,
          "description": "Total chunks available in index"
        },
        "selection_strategy": {
          "type": "string",
          "enum": ["sequential", "index_only", "selective"],
          "description": "Chunk selection strategy used (per TASK-222)"
        },
        "chunks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ChunkProcessingInfo"
          },
          "description": "Per-chunk processing details"
        }
      },
      "description": "Metadata about chunk processing for traceability and debugging"
    },
    "ChunkProcessingInfo": {
      "type": "object",
      "required": ["chunk_id", "segment_range", "entities_extracted"],
      "properties": {
        "chunk_id": {
          "type": "string",
          "pattern": "^chunk-\\d{3,}$",
          "description": "Chunk identifier (matches EN-021 naming)"
        },
        "segment_range": {
          "type": "array",
          "items": { "type": "integer", "minimum": 1 },
          "minItems": 2,
          "maxItems": 2,
          "description": "Segment ID range [start, end] in this chunk"
        },
        "entities_extracted": {
          "type": "integer",
          "minimum": 0,
          "description": "Total entities extracted from this chunk"
        }
      }
    },
    "ExtractionStats": {
      "type": "object",
      "required": ["speakers_identified", "action_items", "decisions", "questions", "topics"],
      "properties": {
        "speakers_identified": {
          "type": "integer",
          "minimum": 0
        },
        "action_items": {
          "type": "integer",
          "minimum": 0
        },
        "decisions": {
          "type": "integer",
          "minimum": 0
        },
        "questions": {
          "type": "integer",
          "minimum": 0
        },
        "topics": {
          "type": "integer",
          "minimum": 0
        },
        "confidence_summary": {
          "$ref": "#/$defs/ConfidenceSummary"
        }
      }
    },
    "ConfidenceSummary": {
      "type": "object",
      "required": ["average", "high_count", "medium_count", "low_count", "high_ratio"],
      "properties": {
        "average": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Average confidence across all entities"
        },
        "high_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of HIGH confidence entities (>=0.85)"
        },
        "medium_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of MEDIUM confidence entities (0.70-0.84)"
        },
        "low_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of LOW confidence entities (<0.70)"
        },
        "high_ratio": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Ratio of HIGH confidence entities"
        }
      }
    },
    "Speaker": {
      "type": "object",
      "required": ["id", "name", "detection_pattern", "confidence", "segment_count"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^spk-",
          "description": "Speaker identifier (spk-*)"
        },
        "name": {
          "type": "string",
          "description": "Speaker name as detected"
        },
        "detection_pattern": {
          "type": "string",
          "enum": ["vtt_voice_tag", "prefix_pattern", "bracket_pattern", "contextual"],
          "description": "Pattern used for speaker detection (PAT-003)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Detection confidence score"
        },
        "segment_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of segments attributed to this speaker"
        }
      }
    },
    "Citation": {
      "type": "object",
      "required": ["segment_id", "anchor", "timestamp_ms", "text_snippet"],
      "properties": {
        "segment_id": {
          "type": "string",
          "pattern": "^seg-\\d{3,}$",
          "description": "Source segment identifier"
        },
        "chunk_id": {
          "type": "string",
          "pattern": "^chunk-\\d{3,}$",
          "description": "Source chunk identifier (present only for chunked input)"
        },
        "anchor": {
          "type": "string",
          "pattern": "^#seg-\\d{3,}$",
          "description": "Deep link anchor per ADR-003"
        },
        "timestamp_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Timestamp in milliseconds"
        },
        "text_snippet": {
          "type": "string",
          "minLength": 1,
          "description": "Source text snippet for verification"
        }
      },
      "description": "Citation object per PAT-004 anti-hallucination (v1.1: optional chunk_id for chunked input)"
    },
    "ActionItem": {
      "type": "object",
      "required": ["id", "text", "confidence", "citation"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^act-\\d{3,}$",
          "description": "Action item identifier"
        },
        "text": {
          "type": "string",
          "description": "Action item description"
        },
        "assignee": {
          "type": ["string", "null"],
          "description": "Assigned person (if stated)"
        },
        "due_date": {
          "type": ["string", "null"],
          "description": "Due date (if stated)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "tier": {
          "type": "integer",
          "enum": [1, 2, 3],
          "description": "Extraction tier (PAT-001)"
        },
        "citation": {
          "$ref": "#/$defs/Citation"
        }
      }
    },
    "Decision": {
      "type": "object",
      "required": ["id", "text", "confidence", "citation"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^dec-\\d{3,}$",
          "description": "Decision identifier"
        },
        "text": {
          "type": "string",
          "description": "Decision description"
        },
        "decided_by": {
          "type": ["string", "null"],
          "description": "Person or group who made the decision"
        },
        "rationale": {
          "type": ["string", "null"],
          "description": "Rationale for the decision (if stated)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "citation": {
          "$ref": "#/$defs/Citation"
        }
      }
    },
    "Question": {
      "type": "object",
      "required": ["id", "text", "answered", "confidence", "citation"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^que-\\d{3,}$",
          "description": "Question identifier"
        },
        "text": {
          "type": "string",
          "description": "Question text"
        },
        "asked_by": {
          "type": ["string", "null"],
          "description": "Person who asked"
        },
        "answered": {
          "type": "boolean",
          "description": "Whether question was answered in meeting"
        },
        "answer_citation": {
          "oneOf": [
            { "$ref": "#/$defs/Citation" },
            { "type": "null" }
          ],
          "description": "Citation for answer (if answered)"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "citation": {
          "$ref": "#/$defs/Citation"
        }
      }
    },
    "Topic": {
      "type": "object",
      "required": ["id", "title", "start_ms", "end_ms", "segment_ids"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^top-\\d{3,}$",
          "description": "Topic identifier"
        },
        "title": {
          "type": "string",
          "description": "Generated topic title"
        },
        "start_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Topic start timestamp"
        },
        "end_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Topic end timestamp"
        },
        "segment_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^seg-\\d{3,}$"
          },
          "minItems": 1,
          "description": "Segments within this topic"
        },
        "chunk_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^chunk-\\d{3,}$"
          },
          "description": "Chunks containing this topic (present only for chunked input)"
        }
      }
    }
  }
}
