# =============================================================================
# PARSER TEST SPECIFICATION
# =============================================================================
# Purpose: Test cases for ts-parser agent verification
# Created: 2026-01-27
# Updated: 2026-01-27 (Added edge case tests from W3C WebVTT research)
# Source: EN-007 DISC-002 (Minimal test infrastructure)
# Research: EN-007 webvtt-test-suite-research.md
# Implements: FR-001 (VTT), FR-002 (SRT), FR-003 (Plain Text), FR-004 (Format Detection)
# Reference: TDD-ts-parser.md, ts-parser.md
#
# REVIEW STATUS: PENDING_HUMAN_REVIEW
# =============================================================================

version: "1.1.0"
agent: ts-parser
created_at: "2026-01-27T14:30:00Z"
updated_at: "2026-01-27T18:00:00Z"
review_status: PENDING_HUMAN_REVIEW

# =============================================================================
# TEST SUITES
# =============================================================================

test_suites:

  # ---------------------------------------------------------------------------
  # VTT PARSING (FR-001) - Primary focus for TASK-102
  # ---------------------------------------------------------------------------
  vtt_parsing:
    description: "WebVTT format parsing tests (FR-001)"
    implements: "FR-001"
    reference: "TDD-ts-parser.md Section 1.1"

    tests:
      # Test VTT-001: Basic VTT with voice tags
      - id: vtt-001
        name: "Parse VTT with voice tags and closing </v> tags"
        description: |
          Verify ts-parser correctly handles VTT files with:
          - WEBVTT header
          - Voice tags with closing </v> (per DISC-001 correction)
          - Standard HH:MM:SS.mmm timestamps
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
          format: vtt
        expected:
          file: "../expected/internal-sample-sample.expected.json"
        assertions:
          - type: format_detected
            expected: "vtt"
          - type: segment_count
            expected: 20
          - type: speakers_detected
            expected: ["Adam Nowak", "Brendan Bennett"]
          - type: no_parse_errors
          - type: closing_tags_stripped
            description: "Text should NOT contain </v> closing tags"
        acceptance_criteria:
          - "AC-1: WEBVTT header recognized"
          - "AC-2: Voice tags parsed correctly"
          - "AC-3: Closing </v> tags stripped from text"

      # Test VTT-002: Multi-line cue payloads
      - id: vtt-002
        name: "Parse VTT with multi-line cue payloads"
        description: |
          Verify ts-parser correctly handles multi-line cue payloads:
          - Voice tag opens on first line
          - Closing tag on last line
          - Lines joined with single space
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
          segment_filter: "seg-002"  # Multi-line example
        expected:
          segment:
            id: "seg-002"
            speaker: "Brendan Bennett"
            text: "All right. Yeah. So I guess I was a little interested in"
        assertions:
          - type: text_no_newlines
            description: "Multi-line payload joined with single space"
          - type: text_no_closing_tag
            description: "Closing </v> stripped from extracted text"
        acceptance_criteria:
          - "AC-4: Multi-line payloads joined correctly"

      # Test VTT-003: Timestamp normalization
      - id: vtt-003
        name: "Timestamps normalized to milliseconds"
        description: |
          Verify ts-parser converts VTT timestamps to milliseconds:
          - HH:MM:SS.mmm -> integer milliseconds
          - Precision: 10ms (per NFR-006)
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
          segment_filter: "seg-001"
        expected:
          segment:
            start_ms: 3528
            end_ms: 6448
        assertions:
          - type: timestamp_format
            expected: "milliseconds"
          - type: start_before_end
            description: "start_ms < end_ms for all segments"
        acceptance_criteria:
          - "AC-6: Timestamps normalized to milliseconds"

      # Test VTT-004: Speaker extraction from voice tags
      - id: vtt-004
        name: "Speaker names extracted from <v> tags"
        description: |
          Verify ts-parser extracts speaker names correctly:
          - Pattern: <v SPEAKER_NAME>text</v>
          - Full name preserved (first and last)
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
        expected:
          speakers: ["Adam Nowak", "Brendan Bennett"]
        assertions:
          - type: speaker_count
            expected: 2
          - type: full_names_preserved
            description: "First and last names both present"
        acceptance_criteria:
          - "AC-2: Voice tags parsed correctly"

      # Test VTT-005: Canonical JSON schema compliance
      - id: vtt-005
        name: "Output matches canonical JSON schema"
        description: |
          Verify ts-parser output conforms to TDD-ts-parser.md Section 3 schema:
          - version field present
          - source object with format, encoding, file_path
          - metadata object with duration_ms, segment_count, detected_speakers
          - segments array with required fields
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
        expected:
          schema_compliance: true
        assertions:
          - type: has_version
            expected: "1.0"
          - type: has_source_object
            required_fields: ["format", "encoding", "file_path"]
          - type: has_metadata_object
            required_fields: ["duration_ms", "segment_count", "detected_speakers"]
          - type: has_segments_array
            segment_required_fields: ["id", "start_ms", "end_ms", "speaker", "text"]
        acceptance_criteria:
          - "AC-5: Output matches canonical JSON schema"

  # ---------------------------------------------------------------------------
  # VTT EDGE CASES (From W3C WebVTT Research)
  # Reference: EN-007 research/webvtt-test-suite-research.md
  # ---------------------------------------------------------------------------
  vtt_edge_cases:
    description: "WebVTT edge case tests derived from W3C WebVTT spec research"
    implements: "FR-001"
    reference: "W3C WebVTT Spec, WPT test suite, webvtt-test-suite-research.md"
    status: "READY"

    tests:
      # Test VTT-006: Voice tags without closing tag
      - id: vtt-006
        name: "Parse voice tags without closing </v> tag"
        description: |
          Per W3C spec, closing tag can be omitted if voice spans entire cue.
          Tests VT-004 from research.
        input:
          file: "transcripts/edge_cases/voice_tag_no_close.vtt"
        assertions:
          - type: speakers_extracted
            expected: ["John", "Mary", "Bob"]
          - type: all_segments_valid
          - type: no_parse_errors
        acceptance_criteria:
          - "VT-004: Voice tags without closing tag parsed correctly"

      # Test VTT-007: Voice tags with CSS classes
      - id: vtt-007
        name: "Parse voice tags with class annotations"
        description: |
          Format: <v.class1.class2 Speaker>text</v>
          Classes should be stripped, speaker name extracted.
          Tests VT-006, VT-007 from research.
        input:
          file: "transcripts/edge_cases/voice_tag_with_class.vtt"
        assertions:
          - type: speakers_extracted
            expected: ["Boss", "Employee", "Multi-Class Speaker"]
          - type: classes_stripped
            description: "Text should not contain .loud, .whisper, etc."
        acceptance_criteria:
          - "VT-006: Voice tag classes stripped correctly"

      # Test VTT-008: Multiple speakers in single cue
      - id: vtt-008
        name: "Parse multiple speakers in single cue"
        description: |
          Tests cues with multiple <v> tags.
          Tests VT-009 from research.
        input:
          file: "transcripts/edge_cases/multi_speaker_cue.vtt"
        assertions:
          - type: multi_speaker_extraction
            description: "All speakers extracted from multi-speaker cues"
        acceptance_criteria:
          - "VT-009: Multiple speakers per cue supported"

      # Test VTT-009: Nested formatting tags
      - id: vtt-009
        name: "Strip nested formatting tags from voice spans"
        description: |
          Format: <v Speaker><b>Bold</b> and <i>italic</i></v>
          All formatting tags should be stripped, text preserved.
          Tests VT-008, TT-008 from research.
        input:
          file: "transcripts/edge_cases/nested_formatting.vtt"
        assertions:
          - type: formatting_tags_stripped
            tags: ["<b>", "</b>", "<i>", "</i>", "<u>", "</u>", "<c>", "</c>", "<lang>", "</lang>"]
          - type: text_preserved
        acceptance_criteria:
          - "TT-008: Nested formatting tags stripped"

      # Test VTT-010: Unicode speakers and content
      - id: vtt-010
        name: "Parse Unicode speaker names and content"
        description: |
          Tests i18n support with various scripts:
          - Chinese, Arabic, Greek, German umlauts, Japanese, Emoji
          Tests CE-003, CE-004 from research.
        input:
          file: "transcripts/edge_cases/unicode_speakers.vtt"
        assertions:
          - type: unicode_speakers_extracted
            expected_count: 6
          - type: encoding_detected
            expected: "utf-8"
        acceptance_criteria:
          - "CE-004: Unicode speaker names preserved"

      # Test VTT-011: HTML entity decoding
      - id: vtt-011
        name: "Decode HTML entities in cue text"
        description: |
          Tests entity decoding: &amp; -> &, &lt; -> <, &gt; -> >, &nbsp; -> space
          Tests CE-005, CE-006, CE-007 from research.
        input:
          file: "transcripts/edge_cases/entity_escapes.vtt"
        assertions:
          - type: entity_decoded
            test_cases:
              - input: "&amp;"
                expected: "&"
              - input: "&lt;"
                expected: "<"
              - input: "&gt;"
                expected: ">"
        acceptance_criteria:
          - "CE-005: HTML entities decoded correctly"

      # Test VTT-012: Timestamp edge cases
      - id: vtt-012
        name: "Parse timestamp edge cases"
        description: |
          Tests timestamp format variations:
          - No hours format (MM:SS.mmm)
          - With hours format (HH:MM:SS.mmm)
          - Extended hours (>2 digits)
          - Minute boundaries
          - Short/minimal durations
          Tests TS-001 through TS-005 from research.
        input:
          file: "transcripts/edge_cases/timestamp_edge_cases.vtt"
        assertions:
          - type: timestamps_normalized
            format: "milliseconds"
          - type: start_before_end
            all_segments: true
        acceptance_criteria:
          - "TS-001: No-hours format parsed"
          - "TS-002: With-hours format parsed"
          - "TS-003: Extended hours supported"

      # Test VTT-013: Empty and malformed cues
      - id: vtt-013
        name: "Handle empty and malformed cues gracefully"
        description: |
          Tests PAT-002 defensive parsing:
          - Empty cue text
          - Whitespace-only payloads
          - Empty voice annotations
          Parser should continue despite individual errors.
        input:
          file: "transcripts/edge_cases/empty_and_malformed.vtt"
        assertions:
          - type: no_fatal_error
          - type: parse_warnings_captured
            description: "Warnings for malformed cues should be logged"
          - type: valid_segments_extracted
            min_count: 1
        acceptance_criteria:
          - "PAT-002: Defensive parsing continues despite errors"

      # Test VTT-014: Combined edge cases
      - id: vtt-014
        name: "Parse combined edge cases file"
        description: |
          Comprehensive test with all edge cases in single file:
          - Voice tags (VT-*)
          - Tag stripping (TT-*)
          - Multiline (ML-*)
          - Encoding (CE-*)
          - Timestamps (TS-*)
        input:
          file: "transcripts/edge_cases/combined_edge_cases.vtt"
        assertions:
          - type: all_segments_valid
          - type: no_fatal_error
          - type: segment_count
            minimum: 20
        acceptance_criteria:
          - "Comprehensive edge case coverage validated"

  # ---------------------------------------------------------------------------
  # FORMAT DETECTION (FR-004) - Placeholder for expansion
  # ---------------------------------------------------------------------------
  format_detection:
    description: "Format auto-detection tests (FR-004)"
    implements: "FR-004"
    reference: "TDD-ts-parser.md Section 2"
    status: "PLACEHOLDER - Expand in EN-015"

    tests:
      - id: det-001
        name: "Auto-detect VTT format"
        description: "Verify format detection for VTT files"
        input:
          file: "transcripts/real/internal-sample-sample.vtt"
        assertions:
          - type: format_detected
            expected: "vtt"

  # ---------------------------------------------------------------------------
  # SRT PARSING (FR-002) - Placeholder for TASK-103
  # ---------------------------------------------------------------------------
  srt_parsing:
    description: "SubRip format parsing tests (FR-002)"
    implements: "FR-002"
    reference: "TDD-ts-parser.md Section 1.2"
    status: "PLACEHOLDER - Implement in TASK-103"

    tests:
      - id: srt-001
        name: "Parse SRT with comma timestamps (placeholder)"
        status: "PENDING_TEST_DATA"
        note: "Requires SRT test file from EN-015"

  # ---------------------------------------------------------------------------
  # PLAIN TEXT PARSING (FR-003) - Placeholder for TASK-104
  # ---------------------------------------------------------------------------
  plain_text_parsing:
    description: "Plain text format parsing tests (FR-003)"
    implements: "FR-003"
    reference: "TDD-ts-parser.md Section 1.3"
    status: "PLACEHOLDER - Implement in TASK-104"

    tests:
      - id: txt-001
        name: "Parse plain text with speaker prefixes (placeholder)"
        status: "PENDING_TEST_DATA"
        note: "Requires plain text test file from EN-015"

# =============================================================================
# NOTES
# =============================================================================
#
# This is MINIMAL test infrastructure created per EN-007:DISC-002 to unblock
# TASK-102 VTT processing verification.
#
# EXPANSION PLANNED (EN-015 Sprint 4):
# - Additional VTT edge cases
# - SRT test files and cases
# - Plain text test files and cases
# - Golden dataset (3 meetings)
# - Edge case files (malformed, empty, large, unicode)
#
# HUMAN REVIEW REQUIRED:
# - Verify expected JSON values are correct
# - Confirm test assertions match acceptance criteria
# - Approve before using for verification
#
# =============================================================================
