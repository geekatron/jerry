{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://jerry-framework.example.com/schemas/work-tracker-v2.json",
  "title": "Work Tracker Schema",
  "description": "JSON Schema for ECW Work Tracker v2.0",
  "type": "object",
  "required": ["schema_version", "meta", "phases", "tasks"],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^2\\.\\d+(\\.\\d+)?$",
      "description": "Schema version (major.minor.patch)"
    },
    "meta": {
      "type": "object",
      "required": ["title"],
      "properties": {
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200
        },
        "initiative_id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9-]+$"
        },
        "status": {
          "type": "string",
          "enum": ["active", "Active", "complete", "Complete", "blocked", "Blocked", "archived", "Archived"],
          "description": "Tracker status (legacy capitalized values supported)"
        },
        "created": {
          "type": "string",
          "format": "date-time"
        },
        "updated": {
          "type": "string",
          "format": "date-time"
        },
        "fingerprint": {
          "type": "string",
          "pattern": "^wt-v\\d+\\.\\d+\\.\\d+-[a-f0-9]{8}$"
        },
        "progress": {
          "type": "object",
          "properties": {
            "overall": {
              "type": "integer",
              "minimum": 0,
              "maximum": 100
            }
          }
        }
      }
    },
    "phases": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["number", "name", "status"],
        "properties": {
          "number": {
            "type": "integer",
            "minimum": 1
          },
          "name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "status": {
            "$ref": "#/definitions/status"
          },
          "progress": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "description": {
            "type": "string"
          }
        }
      }
    },
    "tasks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "phase"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+$"
          },
          "phase": {
            "type": "integer",
            "minimum": 1
          },
          "name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "description": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "status": {
            "$ref": "#/definitions/status"
          },
          "progress": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "verification": {
            "type": "string"
          },
          "evidence": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/evidence"
            }
          },
          "dependencies": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^\\d+\\.\\d+$"
            }
          },
          "hierarchical_status": {
            "type": "string",
            "pattern": "^(Discovery|Design|Development|Review|Consent|Terminal|Deferred|Blocked)\\.[A-Za-z]+(\\.?[A-Za-z]+)?$",
            "description": "Hierarchical status in Zone.Status or Zone.Phase.Step format (Initiative 19)"
          },
          "zone": {
            "type": "string",
            "enum": ["Discovery", "Design", "Development", "Review", "Consent", "Terminal", "Deferred", "Blocked"],
            "description": "Current lifecycle zone (Initiative 19)"
          },
          "kent_beck_phase": {
            "type": "string",
            "enum": ["Work", "Right", "Fast"],
            "description": "Kent Beck development phase for Development zone tasks (Initiative 19)"
          },
          "status_history": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/status_history_entry"
            },
            "description": "History of status transitions (Initiative 19)"
          }
        },
        "anyOf": [
          {"required": ["name"]},
          {"required": ["description"]}
        ]
      }
    },
    "subtasks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "task_id", "name"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "task_id": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+$"
          },
          "name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200
          },
          "status": {
            "$ref": "#/definitions/status"
          },
          "progress": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "completed": {
            "type": "boolean"
          }
        }
      }
    },
    "events": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "timestamp"],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "TrackerCreated",
              "InitiativeCreated",
              "PhaseAdded",
              "PhaseUpdated",
              "PhaseDeleted",
              "PhasesReordered",
              "TaskAdded",
              "TaskUpdated",
              "TaskDeleted",
              "TaskMoved",
              "SubtaskAdded",
              "SubtaskUpdated",
              "SubtaskDeleted",
              "SubtasksAutoCompleted",
              "SubtasksBulkAdded",
              "SubtasksBulkAutoCompleted",
              "WorkTrackerUpdated",
              "EvidenceAttached",
              "EvidenceVerified",
              "StatusChanged",
              "ProgressUpdated",
              "progress_auto_corrected"
            ],
            "description": "Event type - D-016 added InitiativeCreated. Initiative 19 added SubtasksAutoCompleted, SubtasksBulkAutoCompleted, progress_auto_corrected. Phase 14 added TaskMoved, PhasesReordered. D-008 added SubtasksBulkAdded, WorkTrackerUpdated"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "actor": {
            "type": "string"
          },
          "target": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["phase", "task", "subtask"]
              },
              "id": {
                "type": "string"
              }
            }
          },
          "changes": {
            "type": "object"
          }
        }
      }
    }
  },
  "definitions": {
    "status_history_entry": {
      "type": "object",
      "required": ["from_status", "to_status", "timestamp"],
      "properties": {
        "from_status": {
          "type": "string",
          "description": "Previous hierarchical status"
        },
        "to_status": {
          "type": "string",
          "description": "New hierarchical status"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the transition occurred"
        },
        "reason": {
          "type": "string",
          "description": "Reason for transition (required for backtracks)"
        },
        "is_backtrack": {
          "type": "boolean",
          "description": "Whether this was a backward transition"
        },
        "is_zone_change": {
          "type": "boolean",
          "description": "Whether this crossed zone boundaries"
        }
      },
      "description": "Initiative 19: Status transition history entry"
    },
    "hierarchical_status_zone": {
      "type": "string",
      "enum": ["Discovery", "Design", "Development", "Review", "Consent", "Terminal", "Deferred", "Blocked"],
      "description": "Initiative 19: Valid lifecycle zones"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "Pending", "in_progress", "In Progress", "complete", "Complete", "blocked", "Blocked", "skipped", "Skipped", "superseded", "Superseded"],
      "description": "Valid status values (legacy capitalized values supported, includes superseded for replaced work)"
    },
    "evidence": {
      "type": "object",
      "required": ["type", "timestamp"],
      "description": "Evidence entry - supports both legacy format and 5W1H rich format (Initiative 19 Phase 33)",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique evidence identifier (e.g., ev_abc12345)"
        },
        "type": {
          "type": "string",
          "enum": ["command_output", "file_reference", "manual_note", "screenshot", "test_results", "code_review"],
          "description": "Evidence type per IEEE 829-2008 (6 supported types)"
        },
        "content": {
          "type": "string",
          "description": "Evidence content or description (legacy)"
        },
        "command": {
          "type": "string",
          "description": "Command executed (for command_output)"
        },
        "output": {
          "type": "string",
          "description": "Command output (legacy, use content)"
        },
        "file": {
          "type": "string",
          "description": "File path (legacy, use file_path)"
        },
        "file_path": {
          "type": "string",
          "description": "Path to referenced file"
        },
        "note": {
          "type": "string",
          "description": "Manual note text (legacy, use content)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "verified": {
          "type": "boolean",
          "default": false,
          "description": "Legacy verification flag"
        },
        "verification_status": {
          "type": "string",
          "enum": ["pending", "verified", "rejected", "needs_review"],
          "default": "pending",
          "description": "Current verification status per NIST SP 800-86"
        },
        "verified_by": {
          "type": "string",
          "description": "Who verified the evidence"
        },
        "verified_at": {
          "type": "string",
          "format": "date-time",
          "description": "When evidence was verified"
        },
        "verification_notes": {
          "type": "string",
          "description": "Notes from verification"
        },
        "who": {
          "$ref": "#/definitions/evidence_actor",
          "description": "WHO collected evidence - NIST SP 800-86 chain of custody"
        },
        "what": {
          "$ref": "#/definitions/evidence_what",
          "description": "WHAT is being verified - IEEE 829-2008 test items"
        },
        "where": {
          "$ref": "#/definitions/evidence_where",
          "description": "WHERE - traceability link - NASA SP-2016-6105"
        },
        "when": {
          "$ref": "#/definitions/evidence_when",
          "description": "WHEN - temporal context - NIST timestamping"
        },
        "why": {
          "$ref": "#/definitions/evidence_why",
          "description": "WHY - verification rationale - IEEE 829-2008 pass/fail"
        },
        "how": {
          "$ref": "#/definitions/evidence_how",
          "description": "HOW - reproduction - NIST reproducibility"
        },
        "integrity": {
          "$ref": "#/definitions/evidence_integrity",
          "description": "Integrity verification - NIST SP 800-86"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "confidence_level": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "reviewer": {"type": "string"},
            "framework": {"type": "string"},
            "passed": {"type": "integer", "minimum": 0},
            "failed": {"type": "integer", "minimum": 0},
            "skipped": {"type": "integer", "minimum": 0},
            "total": {"type": "integer", "minimum": 0},
            "width": {"type": "integer", "minimum": 1},
            "height": {"type": "integer", "minimum": 1},
            "pr_number": {"type": "integer", "minimum": 1},
            "status": {"type": "string"}
          },
          "additionalProperties": true,
          "description": "Type-specific and custom metadata"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {"type": {"const": "command_output"}}
          },
          "then": {
            "anyOf": [
              {"required": ["content"]},
              {"required": ["output"]},
              {"required": ["what"]}
            ]
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "file_reference"}}
          },
          "then": {
            "anyOf": [
              {"required": ["file"]},
              {"required": ["file_path"]},
              {"required": ["content"]},
              {"required": ["where"]}
            ]
          }
        },
        {
          "if": {
            "properties": {"type": {"const": "manual_note"}}
          },
          "then": {
            "anyOf": [
              {"required": ["note"]},
              {"required": ["content"]},
              {"required": ["what"]}
            ]
          }
        }
      ]
    },
    "evidence_actor": {
      "type": "object",
      "description": "WHO: Actor who collected evidence (NIST SP 800-86 chain of custody)",
      "required": ["type", "identity"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["claude-code", "human", "system", "ci"],
          "description": "Actor type"
        },
        "identity": {
          "type": "string",
          "description": "Specific actor identifier"
        }
      }
    },
    "evidence_what": {
      "type": "object",
      "description": "WHAT: What is being verified (IEEE 829-2008 test items)",
      "required": ["description", "acceptance_criteria"],
      "properties": {
        "description": {
          "type": "string",
          "description": "What was verified"
        },
        "acceptance_criteria": {
          "type": "string",
          "description": "Pass/fail criteria"
        },
        "content_snippet": {
          "type": "string",
          "maxLength": 500,
          "description": "Actual evidence content (truncated to 500 chars)"
        },
        "full_content_available": {
          "type": "boolean",
          "default": true,
          "description": "Whether full content exists"
        }
      }
    },
    "evidence_where": {
      "type": "object",
      "description": "WHERE: Location context (NASA SP-2016-6105 traceability)",
      "required": ["requirement_id"],
      "properties": {
        "requirement_id": {
          "type": "string",
          "description": "Task/Subtask ID being verified"
        },
        "file_path": {
          "type": "string",
          "description": "Path to artifact file"
        },
        "line_range": {
          "type": "string",
          "pattern": "^\\d+(-\\d+)?$",
          "description": "Line range (e.g., 100-150)"
        }
      }
    },
    "evidence_when": {
      "type": "object",
      "description": "WHEN: Temporal context (NIST timestamping)",
      "required": ["collected_at"],
      "properties": {
        "collected_at": {
          "type": "string",
          "format": "date-time",
          "description": "When evidence was collected"
        },
        "verified_at": {
          "type": "string",
          "format": "date-time",
          "description": "When evidence was verified"
        }
      }
    },
    "evidence_why": {
      "type": "object",
      "description": "WHY: Verification rationale (IEEE 829-2008 pass/fail criteria)",
      "required": ["verification_method", "expected_result", "actual_result", "passed"],
      "properties": {
        "verification_method": {
          "type": "string",
          "enum": ["inspection", "analysis", "demonstration", "test"],
          "description": "NASA SP-2016-6105 verification methods"
        },
        "expected_result": {
          "type": "string",
          "description": "What should happen"
        },
        "actual_result": {
          "type": "string",
          "description": "What actually happened"
        },
        "passed": {
          "type": "boolean",
          "description": "Whether verification passed"
        }
      }
    },
    "evidence_how": {
      "type": "object",
      "description": "HOW: Reproduction instructions (NIST reproducibility)",
      "properties": {
        "reproduction_command": {
          "type": "string",
          "description": "Command to reproduce"
        },
        "environment": {
          "type": "string",
          "description": "Environment requirements"
        },
        "verification_steps": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Step-by-step verification instructions"
        }
      }
    },
    "evidence_integrity": {
      "type": "object",
      "description": "Integrity verification (NIST SP 800-86)",
      "required": ["content_hash"],
      "properties": {
        "content_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of evidence content"
        },
        "file_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of referenced file"
        },
        "chain_of_custody": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/chain_of_custody_entry"
          },
          "description": "Audit trail per NIST SP 800-86"
        }
      }
    },
    "chain_of_custody_entry": {
      "type": "object",
      "description": "NIST SP 800-86 chain of custody record",
      "required": ["action", "by", "at"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["collected", "verified", "modified", "rejected"],
          "description": "Action performed"
        },
        "by": {
          "type": "string",
          "description": "Actor identity"
        },
        "at": {
          "type": "string",
          "format": "date-time",
          "description": "When action occurred"
        },
        "notes": {
          "type": "string",
          "description": "Additional notes"
        }
      }
    }
  }
}
